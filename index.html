<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹¸è¿å¤§æŠ½å¥– - ä¹å®«æ ¼</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            min-height: 100vh;
            color: white;
            padding: 15px;
        }
        
        .container {
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
            text-align: center;
        }
        
        .header {
            margin-bottom: 20px;
            padding: 20px;
        }
        
        h1 {
            font-size: clamp(24px, 5vw, 36px);
            margin-bottom: 10px;
            background: linear-gradient(to right, #FFD700, #FFA500);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle {
            font-size: clamp(14px, 3vw, 18px);
            opacity: 0.8;
            margin-bottom: 20px;
        }
        
        .music-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .control-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 215, 0, 0.5);
            color: white;
            padding: 8px 20px;
            border-radius: 50px;
            cursor: pointer;
            font-size: clamp(14px, 3vw, 16px);
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .control-btn:hover {
            background: rgba(255, 215, 0, 0.2);
            transform: translateY(-2px);
        }
        
        .control-btn.active {
            background: rgba(255, 215, 0, 0.3);
            border-color: #FFD700;
        }
        
        /* ä¹å®«æ ¼å¸ƒå±€ */
        .nine-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 10px;
            width: min(95vw, 600px);
            height: min(95vw, 600px);
            margin: 0 auto 30px;
            position: relative;
        }
        
        .grid-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        /* å¥–å“æ ¼å­ */
        .grid-item.prize {
            cursor: default;
        }
        
        .grid-item.prize.active {
            border-color: #FFD700;
            box-shadow: 0 0 25px rgba(255, 215, 0, 0.5);
            transform: scale(1.05);
            z-index: 2;
        }
        
        .prize-image {
            width: 70px;
            height: 70px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 8px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            /* ä½¿ç”¨base64å ä½å›¾ï¼Œç«‹å³æ˜¾ç¤º */
            background: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjMzMzIi8+CjxwYXRoIGQ9Ik0zNSA0MEw2NSA0ME02NSA2MEwzNSA2ME0zNSA1MEw2NSA1MCIgc3Ryb2tlPSIjNjY2IiBzdHJva2Utd2lkdGg9IjMiLz4KPC9zdmc+') center/cover no-repeat;
        }
        
        .prize-name {
            font-size: 14px;
            text-align: center;
            font-weight: bold;
            color: #FFD700;
        }
        
        .prize-level {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 215, 0, 0.8);
            color: #000;
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: bold;
        }
        
        /* ä¸­å¿ƒæŠ½å¥–æŒ‰é’®æ ¼å­ */
        .grid-item.center-btn {
            background: linear-gradient(145deg, #FF416C, #FF4B2B);
            border: none;
            cursor: pointer;
            grid-column: 2;
            grid-row: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            z-index: 10;
        }
        
        .grid-item.center-btn:hover {
            background: linear-gradient(145deg, #FF4B2B, #FF416C);
            box-shadow: 0 0 30px rgba(255, 65, 108, 0.7);
        }
        
        .grid-item.center-btn:active {
            transform: scale(0.98);
        }
        
        .grid-item.center-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            background: linear-gradient(145deg, #666, #888);
        }
        
        .start-btn-text {
            font-size: clamp(16px, 3vw, 20px);
            font-weight: bold;
            color: white;
        }
        
        .chance-count {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
        }
        
        .result-display {
            margin: 20px auto;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            max-width: 600px;
            border: 2px solid rgba(255, 215, 0, 0.2);
        }
        
        .result-text {
            font-size: clamp(18px, 4vw, 24px);
            margin-bottom: 15px;
            min-height: 40px;
        }
        
        .result-prize {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        
        @media (min-width: 768px) {
            .result-prize {
                flex-direction: row;
                justify-content: center;
            }
        }
        
        .result-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 12px;
            border: 2px solid #FFD700;
        }
        
        .winner-board {
            margin-top: 30px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .board-header {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 215, 0, 0.3);
        }
        
        @media (min-width: 576px) {
            .board-header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }
        
        .board-title {
            font-size: clamp(18px, 4vw, 20px);
            color: #FFD700;
        }
        
        .view-history-btn, .reset-btn {
            background: rgba(255, 215, 0, 0.2);
            border: 1px solid #FFD700;
            color: white;
            padding: 8px 20px;
            border-radius: 50px;
            cursor: pointer;
            font-size: clamp(14px, 3vw, 16px);
            transition: all 0.3s;
        }
        
        .view-history-btn:hover, .reset-btn:hover {
            background: rgba(255, 215, 0, 0.3);
            transform: translateY(-2px);
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .winner-scroll {
            height: 200px;
            overflow: hidden;
            position: relative;
        }
        
        .winner-list {
            list-style: none;
        }
        
        .winner-list li {
            padding: 10px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* å¼¹çª—æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            width: 100%;
            max-width: 500px;
            border-radius: 20px;
            padding: 30px;
            position: relative;
            border: 2px solid #FFD700;
            box-shadow: 0 0 40px rgba(255, 215, 0, 0.4);
        }
        
        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 215, 0, 0.2);
            border: 1px solid #FFD700;
            color: white;
            font-size: 20px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* æ—‹è½¬åŠ¨ç”» */
        @keyframes rotateIndicator {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .spinning {
            animation: rotateIndicator 1s linear infinite;
        }
        
        /* å“åº”å¼ä¼˜åŒ– */
        @media (max-width: 768px) {
            .nine-grid {
                width: min(95vw, 500px);
                height: min(95vw, 500px);
            }
            
            .prize-image {
                width: 50px;
                height: 50px;
            }
            
            .prize-name {
                font-size: 12px;
            }
        }
        
        @media (max-width: 480px) {
            .nine-grid {
                width: min(95vw, 400px);
                height: min(95vw, 400px);
                gap: 5px;
            }
            
            .prize-image {
                width: 40px;
                height: 40px;
            }
            
            .prize-name {
                font-size: 10px;
            }
            
            .grid-item {
                padding: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ° å¹¸è¿å¤§æŠ½å¥– ğŸ°</h1>
            <p class="subtitle">ç‚¹å‡»ä¸­å¿ƒæŒ‰é’®å¼€å§‹æŠ½å¥–ï¼Œä¹å®«æ ¼å¸ƒå±€ï¼Œç¥ä½ å¥½è¿ï¼</p>
            
            <div class="music-controls">
                <button class="control-btn" id="bgMusicBtn">
                    <span>ğŸµ</span> èƒŒæ™¯éŸ³ä¹: <span id="bgMusicStatus">å¼€å¯</span>
                </button>
                <button class="control-btn" id="soundEffectBtn">
                    <span>ğŸ”Š</span> æ—‹è½¬éŸ³æ•ˆ: <span id="soundEffectStatus">å¼€å¯</span>
                </button>
            </div>
        </div>
        
        <!-- ä¹å®«æ ¼å¸ƒå±€ -->
        <div class="nine-grid" id="nineGrid">
            <!-- å¥–å“æ ¼å­é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
        
        <!-- ç»“æœå±•ç¤º -->
        <div class="result-display">
            <div class="result-text" id="resultText">ç­‰å¾…æŠ½å¥–å¼€å§‹...</div>
            <div class="result-prize" id="resultPrize" style="display: none;">
                <img id="resultImage" class="result-image" alt="ä¸­å¥–å¥–å“">
                <div>
                    <div style="color: #FFD700; font-size: 18px;" id="resultPrizeName"></div>
                    <div style="margin-top: 8px; font-size: 14px;" id="resultTime"></div>
                </div>
            </div>
        </div>
        
        <!-- ä¸­å¥–åå• -->
        <div class="winner-board">
            <div class="board-header">
                <div class="board-title">ğŸ† å®æ—¶ä¸­å¥–åå•</div>
                <div class="button-group">
                    <button class="view-history-btn" id="viewHistoryBtn">ğŸ“œ æˆ‘çš„ä¸­å¥–è®°å½•</button>
                    <button class="reset-btn" id="resetBtn">ğŸ”„ é‡ç½®æ¬¡æ•°</button>
                </div>
            </div>
            
            <div class="winner-scroll">
                <ul class="winner-list" id="winnerList"></ul>
            </div>
        </div>
    </div>
    
    <!-- æˆ‘çš„ä¸­å¥–è®°å½•å¼¹çª— -->
    <div class="modal" id="historyModal">
        <div class="modal-content">
            <button class="close-modal" id="closeModal">Ã—</button>
            <h2 style="color: #FFD700; margin-bottom: 15px;">ğŸ“‹ æˆ‘çš„ä¸­å¥–è®°å½•</h2>
            <div id="historyContent" style="max-height: 60vh; overflow-y: auto;"></div>
        </div>
    </div>
    
    <!-- ç­”é¢˜å¼¹çª— -->
    <div class="modal" id="quizModal">
        <div class="modal-content">
            <div id="quizContent">
                <!-- ç­”é¢˜å†…å®¹å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>
    
    <!-- éŸ³ä¹å…ƒç´  -->
    <audio id="backgroundMusic" loop>
        <source src="papa.mp3" type="audio/mpeg">
        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘å…ƒç´ 
    </audio>
    
    <audio id="dingSound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-bell-notification-933.mp3" type="audio/mpeg">
    </audio>

    <script>
        // ğŸ¯ å¥–å“æ•°æ® - ä½¿ç”¨EMOJIä»£æ›¿å›¾ç‰‡ï¼ˆè§£å†³åŠ è½½æ…¢é—®é¢˜ï¼‰
        const prizes = [
            { 
                id: 1, 
                name: "iPhone 16 Pro", 
                level: "ä¸€ç­‰å¥–",
                emoji: "ğŸ“±", // ä½¿ç”¨emoji
                probability: 3 
            },
            { 
                id: 2, 
                name: "iPad Air", 
                level: "äºŒç­‰å¥–",
                emoji: "ğŸ’»", // ä½¿ç”¨emoji
                probability: 5 
            },
            { 
                id: 3, 
                name: "æ™ºèƒ½æ‰‹è¡¨", 
                level: "ä¸‰ç­‰å¥–",
                emoji: "âŒš", // ä½¿ç”¨emoji
                probability: 8 
            },
            { 
                id: 4, 
                name: "AirPods", 
                level: "å››ç­‰å¥–",
                emoji: "ğŸ§", // ä½¿ç”¨emoji
                probability: 12 
            },
            { 
                id: 5, 
                name: "å¸†å¸ƒåŒ…", 
                level: "äº”ç­‰å¥–",
                emoji: "ğŸ‘œ", // ä½¿ç”¨emoji
                probability: 15 
            },
            { 
                id: 6, 
                name: "å¥¶èŒ¶", 
                level: "å…­ç­‰å¥–",
                emoji: "ğŸ§‹", // ä½¿ç”¨emoji
                probability: 20 
            },
            { 
                id: 7, 
                name: "çŸ¿æ³‰æ°´", 
                level: "ä¸ƒç­‰å¥–",
                emoji: "ğŸ’§", // ä½¿ç”¨emoji
                probability: 22 
            },
            { 
                id: 8, 
                name: "è°¢è°¢å‚ä¸", 
                level: "å‚ä¸å¥–",
                emoji: "ğŸ", // ä½¿ç”¨emoji
                probability: 15 
            }
        ];

        // ä¹å®«æ ¼å¸ƒå±€é¡ºåº
        const gridPositions = [
            { row: 1, col: 1 }, // å·¦ä¸Š
            { row: 1, col: 2 }, // ä¸Šä¸­
            { row: 1, col: 3 }, // å³ä¸Š
            { row: 2, col: 1 }, // å·¦ä¸­
            { row: 2, col: 2 }, // ä¸­å¿ƒï¼ˆæŠ½å¥–æŒ‰é’®ï¼‰
            { row: 2, col: 3 }, // å³ä¸­
            { row: 3, col: 1 }, // å·¦ä¸‹
            { row: 3, col: 2 }, // ä¸‹ä¸­
            { row: 3, col: 3 }  // å³ä¸‹
        ];

        // ç½‘ååº“
        const nicknames = [
            "æ˜Ÿæ²³æ»šçƒ«", "äººé—´ç†æƒ³", "æœˆè‰²çœŸç¾", "æ¸…é£å¾æ¥", "äº‘å·äº‘èˆ’", "èŠ±å¼€å¯Œè´µ", "æ˜Ÿè¾°å¤§æµ·",
            "æ—¶å…‰é™å¥½", "æ˜¥æš–èŠ±å¼€", "ç§‹æ°´ä¼Šäºº", "åŒ—åŸä»¥åŒ—", "å—é£æœªèµ·", "è¥¿æ¥¼æœˆä¸‹", "ä¸œç¯±æŠŠé…’"
        ];

        // è„‘ç­‹æ€¥è½¬å¼¯é¢˜åº“
        const quizQuestions = [
            { question: "ä»€ä¹ˆä¸œè¥¿è¶Šæ´—è¶Šè„ï¼Ÿ", options: ["è¡£æœ", "æ°´", "ç¢—", "æ‰‹"], answer: 1 },
            { question: "ä»€ä¹ˆé—¨æ°¸è¿œå…³ä¸ä¸Šï¼Ÿ", options: ["çƒé—¨", "å†°ç®±é—¨", "å¿ƒé—¨", "è½¦é—¨"], answer: 0 },
            { question: "ä»€ä¹ˆä¸œè¥¿å¤©æ°”è¶Šçƒ­ï¼Œå®ƒçˆ¬å¾—è¶Šé«˜ï¼Ÿ", options: ["æ¸©åº¦è®¡", "èš‚èš", "å¤ªé˜³", "æ°”çƒ"], answer: 0 },
            { question: "ä»€ä¹ˆè›‹æ‰“ä¸çƒ‚ï¼Œç…®ä¸ç†Ÿï¼Œæ›´ä¸èƒ½åƒï¼Ÿ", options: ["é¸¡è›‹", "ç¬¨è›‹", "é¸­è›‹", "é›¶è›‹"], answer: 1 },
            { question: "ç”¨æ¤°å­å’Œè¥¿ç“œæ‰“å¤´å“ªä¸€ä¸ªæ¯”è¾ƒç—›ï¼Ÿ", options: ["æ¤°å­", "è¥¿ç“œ", "å¤´", "æ‰‹"], answer: 2 }
        ];

        // ğŸ¯ çŠ¶æ€å˜é‡ï¼ˆç²¾ç®€ï¼‰
        let isDrawing = false;
        let remainingChances = 3;
        let isBgMusicOn = true;
        let isSoundEffectOn = true;
        let winners = [];
        let myHistory = [];
        let currentUser = nicknames[Math.floor(Math.random() * nicknames.length)];
        
        // ç­”é¢˜çŠ¶æ€
        let quizState = {
            currentQuestion: 0,
            score: 0,
            selectedOption: null,
            questions: []
        };

        // ğŸ¯ DOMå…ƒç´ ï¼ˆå»¶è¿Ÿè·å–ï¼‰
        let elements = {};

        // åˆå§‹åŒ–DOMå…ƒç´ 
        function initElements() {
            elements = {
                nineGrid: document.getElementById('nineGrid'),
                resultText: document.getElementById('resultText'),
                resultPrize: document.getElementById('resultPrize'),
                resultImage: document.getElementById('resultImage'),
                resultPrizeName: document.getElementById('resultPrizeName'),
                resultTime: document.getElementById('resultTime'),
                winnerList: document.getElementById('winnerList'),
                bgMusicBtn: document.getElementById('bgMusicBtn'),
                soundEffectBtn: document.getElementById('soundEffectBtn'),
                bgMusicStatus: document.getElementById('bgMusicStatus'),
                soundEffectStatus: document.getElementById('soundEffectStatus'),
                viewHistoryBtn: document.getElementById('viewHistoryBtn'),
                resetBtn: document.getElementById('resetBtn'),
                historyModal: document.getElementById('historyModal'),
                quizModal: document.getElementById('quizModal'),
                closeModal: document.getElementById('closeModal'),
                historyContent: document.getElementById('historyContent'),
                quizContent: document.getElementById('quizContent'),
                bgMusic: document.getElementById('backgroundMusic'),
                dingSound: document.getElementById('dingSound')
            };
        }

        // ğŸ¯ åˆå§‹åŒ–ä¹å®«æ ¼å¸ƒå±€ï¼ˆå¿«é€ŸåŠ è½½ï¼‰
        function initializeNineGrid() {
            elements.nineGrid.innerHTML = '';
            
            // æ‰“ä¹±å¥–å“é¡ºåº
            const shuffledPrizes = [...prizes.filter(p => p.name !== "è°¢è°¢å‚ä¸")];
            shuffledPrizes.sort(() => Math.random() - 0.5);
            
            // ç¡®ä¿è°¢è°¢å‚ä¸åœ¨æœ€åä¸€ä¸ª
            const thanksPrize = prizes.find(p => p.name === "è°¢è°¢å‚ä¸");
            shuffledPrizes.push(thanksPrize);
            
            // åˆ›å»ºæ ¼å­
            for (let i = 0; i < 9; i++) {
                const gridItem = document.createElement('div');
                const position = gridPositions[i];
                
                gridItem.style.gridColumn = position.col;
                gridItem.style.gridRow = position.row;
                
                if (i === 4) { // ä¸­å¿ƒæŠ½å¥–æŒ‰é’®
                    gridItem.className = 'grid-item center-btn';
                    gridItem.id = 'startLotteryBtn';
                    gridItem.innerHTML = `
                        <div style="font-size: 32px;">ğŸ</div>
                        <div class="start-btn-text">å¼€å§‹æŠ½å¥–</div>
                        <div class="chance-count">å‰©ä½™: <span id="chanceCountDisplay">${remainingChances}</span> æ¬¡</div>
                    `;
                    
                    // ğŸ¯ ç«‹å³ç»‘å®šç‚¹å‡»äº‹ä»¶
                    gridItem.addEventListener('click', startLottery);
                } else {
                    const prizeIndex = i < 4 ? i : i - 1;
                    const prize = shuffledPrizes[prizeIndex];
                    gridItem.className = 'grid-item prize';
                    gridItem.dataset.id = prize.id;
                    gridItem.dataset.index = prizeIndex;
                    
                    // ğŸ¯ ä½¿ç”¨emojiè€Œä¸æ˜¯å›¾ç‰‡ï¼Œå¿«é€ŸåŠ è½½
                    gridItem.innerHTML = `
                        <div class="prize-level">${prize.level}</div>
                        <div class="prize-image" style="font-size: 40px; display: flex; align-items: center; justify-content: center;">
                            ${prize.emoji}
                        </div>
                        <div class="prize-name">${prize.name}</div>
                    `;
                }
                
                elements.nineGrid.appendChild(gridItem);
            }
            
            // ä¿å­˜chanceCountDisplayå¼•ç”¨
            elements.chanceCountDisplay = document.getElementById('chanceCountDisplay');
        }

        // ğŸ¯ æ’­æ”¾éŸ³æ•ˆ
        function playDingSound() {
            if (!isSoundEffectOn) return;
            
            try {
                elements.dingSound.currentTime = 0;
                elements.dingSound.play().catch(e => console.log("éŸ³æ•ˆæ’­æ”¾å¤±è´¥"));
            } catch (e) {
                console.log("éŸ³æ•ˆé”™è¯¯:", e);
            }
        }

        // ğŸ¯ å¼€å§‹æŠ½å¥–ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
        function startLottery() {
            if (isDrawing) {
                console.log("æ­£åœ¨æŠ½å¥–ä¸­ï¼Œè¯·ç­‰å¾…...");
                return;
            }
            
            if (remainingChances <= 0) {
                elements.resultText.textContent = "æŠ½å¥–æ¬¡æ•°å·²ç”¨å®Œï¼ç‚¹å‡»é‡ç½®æ¬¡æ•°è·å–æ›´å¤šæœºä¼š";
                return;
            }
            
            console.log("å¼€å§‹æŠ½å¥–...");
            isDrawing = true;
            
            // ç«‹å³ç¦ç”¨æŒ‰é’®
            const startBtn = document.getElementById('startLotteryBtn');
            if (startBtn) {
                startBtn.disabled = true;
                startBtn.innerHTML = `
                    <div style="font-size: 32px;" class="spinning">ğŸ¯</div>
                    <div class="start-btn-text">æŠ½å¥–ä¸­...</div>
                `;
            }
            
            // ç«‹å³æ˜¾ç¤ºçŠ¶æ€
            elements.resultText.textContent = "ğŸ° æŠ½å¥–è¿›è¡Œä¸­...";
            
            // ğŸ¯ å¼‚æ­¥ç¡®å®šç›®æ ‡å¥–å“ï¼ˆä¸é˜»å¡UIï¼‰
            setTimeout(() => {
                const totalProbability = prizes.reduce((sum, prize) => sum + prize.probability, 0);
                let randomNum = Math.random() * totalProbability;
                let selectedPrize = prizes[0];
                
                for (const prize of prizes) {
                    if (randomNum < prize.probability) {
                        selectedPrize = prize;
                        break;
                    }
                    randomNum -= prize.probability;
                }
                
                console.log(`ä¸­å¥–å¥–å“: ${selectedPrize.name}`);
                
                // å¼€å§‹æ—‹è½¬åŠ¨ç”»
                startRotationAnimation(selectedPrize);
            }, 50);
        }

        // ğŸ¯ æ—‹è½¬åŠ¨ç”»ï¼ˆç®€åŒ–ç‰ˆï¼‰
        function startRotationAnimation(selectedPrize) {
            const prizeItems = document.querySelectorAll('.grid-item.prize');
            let currentIndex = 0;
            let spinCount = 0;
            const totalSpins = 20;
            
            // ğŸ¯ æ¸…é™¤é«˜äº®
            prizeItems.forEach(item => item.classList.remove('active'));
            
            function spin() {
                playDingSound();
                
                // æ¸…é™¤ä¸Šä¸€ä¸ª
                if (spinCount > 0) {
                    const prevIndex = (currentIndex - 1 + prizeItems.length) % prizeItems.length;
                    prizeItems[prevIndex].classList.remove('active');
                }
                
                // é«˜äº®å½“å‰
                prizeItems[currentIndex].classList.add('active');
                
                currentIndex = (currentIndex + 1) % prizeItems.length;
                spinCount++;
                
                if (spinCount < totalSpins) {
                    // åŠ¨æ€é€Ÿåº¦
                    const speed = spinCount < 15 ? 100 : 150 + (spinCount - 15) * 30;
                    setTimeout(spin, speed);
                } else {
                    // æ‰¾åˆ°ç›®æ ‡æ ¼å­
                    let targetGridIndex = -1;
                    prizeItems.forEach((item, index) => {
                        if (parseInt(item.dataset.id) === selectedPrize.id) {
                            targetGridIndex = index;
                        }
                    });
                    
                    // ç²¾å‡†åœæ­¢
                    if (targetGridIndex !== -1) {
                        let movesToTarget = (targetGridIndex - currentIndex + prizeItems.length) % prizeItems.length;
                        if (movesToTarget === 0) movesToTarget = prizeItems.length;
                        
                        let finalMoves = 0;
                        
                        function finalAdjustment() {
                            playDingSound();
                            
                            const prev = prizeItems[(currentIndex - 1 + prizeItems.length) % prizeItems.length];
                            if (prev) prev.classList.remove('active');
                            
                            prizeItems[currentIndex].classList.add('active');
                            currentIndex = (currentIndex + 1) % prizeItems.length;
                            finalMoves++;
                            
                            if (finalMoves < movesToTarget) {
                                setTimeout(finalAdjustment, 200 + finalMoves * 80);
                            } else {
                                setTimeout(() => {
                                    showResult(selectedPrize);
                                }, 500);
                            }
                        }
                        
                        setTimeout(finalAdjustment, 300);
                    } else {
                        showResult(selectedPrize);
                    }
                }
            }
            
            setTimeout(spin, 100);
        }

        // ğŸ¯ æ˜¾ç¤ºç»“æœ
        function showResult(selectedPrize) {
            // æ¸…é™¤é«˜äº®
            document.querySelectorAll('.grid-item.prize').forEach(item => {
                item.classList.remove('active');
            });
            
            // é«˜äº®ä¸­å¥–æ ¼å­
            const winningItems = document.querySelectorAll(`.grid-item.prize[data-id="${selectedPrize.id}"]`);
            winningItems.forEach(item => item.classList.add('active'));
            
            // æ›´æ–°æ—¶é—´
            const now = new Date();
            const timeStr = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}:${now.getSeconds().toString().padStart(2,'0')}`;
            
            // æ˜¾ç¤ºç»“æœ
            if (selectedPrize.name === "è°¢è°¢å‚ä¸") {
                elements.resultText.textContent = `ğŸ˜¢ ${selectedPrize.name}ï¼Œä¸‹æ¬¡ç»§ç»­åŠ æ²¹ï¼`;
                elements.resultPrize.style.display = 'none';
            } else {
                elements.resultText.textContent = `ğŸ‰ æ­å–œï¼æŠ½ä¸­ ${selectedPrize.name} ğŸ‰`;
                elements.resultPrizeName.textContent = selectedPrize.name;
                elements.resultTime.textContent = `æ—¶é—´: ${timeStr}`;
                elements.resultPrize.style.display = 'flex';
            }
            
            // æ›´æ–°æ¬¡æ•°
            remainingChances--;
            if (elements.chanceCountDisplay) {
                elements.chanceCountDisplay.textContent = remainingChances;
            }
            
            // æ·»åŠ åˆ°è®°å½•
            myHistory.unshift({
                name: currentUser,
                prize: selectedPrize.name,
                level: selectedPrize.level,
                time: new Date().toLocaleString(),
                emoji: selectedPrize.emoji
            });
            
            // æ·»åŠ åˆ°å…¬å…±åå•
            const randomName = nicknames[Math.floor(Math.random() * nicknames.length)];
            winners.unshift({ 
                name: randomName, 
                prize: selectedPrize.name, 
                time: timeStr 
            });
            updateWinnerList();
            
            // ğŸ¯ é‡ç½®æŒ‰é’®çŠ¶æ€
            isDrawing = false;
            const startBtn = document.getElementById('startLotteryBtn');
            if (startBtn) {
                startBtn.disabled = false;
                startBtn.innerHTML = `
                    <div style="font-size: 32px;">ğŸ</div>
                    <div class="start-btn-text">å¼€å§‹æŠ½å¥–</div>
                    <div class="chance-count">å‰©ä½™: <span id="chanceCountDisplay">${remainingChances}</span> æ¬¡</div>
                `;
                startBtn.classList.remove('spinning');
            }
            
            updateHistoryDisplay();
        }

        // ğŸ¯ æ›´æ–°ä¸­å¥–åå•
        function updateWinnerList() {
            if (!elements.winnerList) return;
            
            elements.winnerList.innerHTML = '';
            const displayWinners = winners.slice(0, 8);
            
            displayWinners.forEach(winner => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span>ğŸ‘¤ ${winner.name}</span>
                    <span style="color: #FFD700; margin: 0 10px;">${winner.prize}</span>
                    <span style="font-size: 12px;">${winner.time}</span>
                `;
                elements.winnerList.appendChild(li);
            });
        }

        // ğŸ¯ æ›´æ–°æˆ‘çš„è®°å½•
        function updateHistoryDisplay() {
            if (!elements.historyContent) return;
            
            elements.historyContent.innerHTML = '';
            
            if (myHistory.length === 0) {
                elements.historyContent.innerHTML = '<p style="text-align: center; padding: 20px; color: #999;">æš‚æ— ä¸­å¥–è®°å½•</p>';
                return;
            }
            
            myHistory.slice(0, 10).forEach(record => {
                const div = document.createElement('div');
                div.style.cssText = 'display: flex; align-items: center; padding: 10px; margin-bottom: 8px; background: rgba(255,255,255,0.05); border-radius: 8px;';
                
                div.innerHTML = `
                    <div style="font-size: 24px; margin-right: 12px;">${record.emoji}</div>
                    <div style="flex: 1;">
                        <div style="color: #FFD700;">${record.name}</div>
                        <div>${record.prize} <span style="font-size: 12px; background: rgba(255,215,0,0.2); padding: 2px 6px; border-radius: 8px; margin-left: 8px;">${record.level}</span></div>
                    </div>
                    <div style="font-size: 12px; color: #999;">${record.time}</div>
                `;
                
                elements.historyContent.appendChild(div);
            });
        }

        // ğŸ¯ åˆ‡æ¢éŸ³ä¹
        function toggleBgMusic() {
            isBgMusicOn = !isBgMusicOn;
            elements.bgMusicStatus.textContent = isBgMusicOn ? 'å¼€å¯' : 'å…³é—­';
            
            if (isBgMusicOn) {
                elements.bgMusic.play().catch(e => console.log("éŸ³ä¹æ’­æ”¾å¤±è´¥"));
                elements.bgMusicBtn.classList.add('active');
            } else {
                elements.bgMusic.pause();
                elements.bgMusicBtn.classList.remove('active');
            }
        }

        // ğŸ¯ åˆ‡æ¢éŸ³æ•ˆ
        function toggleSoundEffect() {
            isSoundEffectOn = !isSoundEffectOn;
            elements.soundEffectStatus.textContent = isSoundEffectOn ? 'å¼€å¯' : 'å…³é—­';
            elements.soundEffectBtn.classList.toggle('active', isSoundEffectOn);
        }

        // ğŸ¯ å¼€å§‹ç­”é¢˜
        function startQuiz() {
            quizState = {
                currentQuestion: 0,
                score: 0,
                selectedOption: null,
                questions: [...quizQuestions].sort(() => Math.random() - 0.5).slice(0, 5)
            };
            
            showQuizQuestion();
            elements.quizModal.style.display = 'flex';
        }

        // ğŸ¯ æ˜¾ç¤ºé¢˜ç›®
        function showQuizQuestion() {
            const q = quizState.questions[quizState.currentQuestion];
            const progress = (quizState.currentQuestion / 5) * 100;
            
            elements.quizContent.innerHTML = `
                <div style="text-align: center;">
                    <h2 style="color: #FFD700; margin-bottom: 15px;">ğŸ§  ç­”é¢˜é‡ç½®</h2>
                    <div style="background: rgba(255,255,255,0.1); height: 6px; border-radius: 3px; margin: 15px 0;">
                        <div style="height: 100%; background: linear-gradient(90deg, #FF416C, #FF4B2B); width: ${progress}%; transition: width 0.3s;"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 20px; color: #FFD700;">
                        <span>ç¬¬ ${quizState.currentQuestion + 1}/5 é¢˜</span>
                        <span>å¾—åˆ†: ${quizState.score}/3</span>
                    </div>
                    <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: left;">
                        <div style="font-size: 18px; margin-bottom: 15px;">${q.question}</div>
                        <div style="display: grid; gap: 10px;">
                            ${q.options.map((opt, i) => `
                                <button onclick="selectQuizOption(${i})" style="background: ${quizState.selectedOption === i ? 'rgba(255,215,0,0.2)' : 'rgba(255,255,255,0.05)'}; border: 1px solid ${quizState.selectedOption === i ? '#FFD700' : 'rgba(255,215,0,0.3)'}; color: white; padding: 12px; border-radius: 8px; text-align: left; cursor: pointer;">
                                    ${String.fromCharCode(65 + i)}. ${opt}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                    <button onclick="submitQuizAnswer()" style="background: linear-gradient(90deg, #FF416C, #FF4B2B); color: white; border: none; padding: 12px 30px; border-radius: 25px; font-size: 16px; cursor: pointer; width: 100%;" ${quizState.selectedOption === null ? 'disabled' : ''}>
                        ${quizState.currentQuestion < 4 ? 'æäº¤ç­”æ¡ˆ' : 'å®Œæˆç­”é¢˜'}
                    </button>
                </div>
            `;
        }

        // ğŸ¯ é€‰æ‹©ç­”æ¡ˆ
        window.selectQuizOption = function(index) {
            quizState.selectedOption = index;
            showQuizQuestion();
        }

        // ğŸ¯ æäº¤ç­”æ¡ˆ
        window.submitQuizAnswer = function() {
            if (quizState.selectedOption === null) return;
            
            const q = quizState.questions[quizState.currentQuestion];
            if (quizState.selectedOption === q.answer) {
                quizState.score++;
                playDingSound();
            }
            
            quizState.currentQuestion++;
            quizState.selectedOption = null;
            
            if (quizState.currentQuestion < quizState.questions.length) {
                showQuizQuestion();
            } else {
                showQuizResult();
            }
        }

        // ğŸ¯ æ˜¾ç¤ºç­”é¢˜ç»“æœ
        function showQuizResult() {
            const success = quizState.score >= 3;
            
            elements.quizContent.innerHTML = `
                <div style="text-align: center; padding: 20px 0;">
                    <div style="font-size: 60px; margin-bottom: 15px;">${success ? 'ğŸ‰' : 'ğŸ˜¢'}</div>
                    <div style="font-size: 20px; color: #FFD700; margin-bottom: 15px;">
                        ${success ? 'æ­å–œï¼ç­”é¢˜æˆåŠŸï¼' : 'å¾ˆé—æ†¾ï¼Œç­”é¢˜å¤±è´¥'}
                    </div>
                    <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; margin: 15px 0;">
                        <div>å¾—åˆ†: ${quizState.score}/5</div>
                        <div style="font-size: 32px; color: #FFD700; margin: 10px 0;">${quizState.score}åˆ†</div>
                        <div>${success ? 'âœ… è¾¾åˆ°3åˆ†è¦æ±‚' : 'âŒ éœ€è¦3åˆ†æ‰èƒ½é‡ç½®'}</div>
                    </div>
                    ${success ? `
                        <div style="color: #4CAF50; background: rgba(76,175,80,0.1); padding: 10px; border-radius: 8px; margin: 15px 0; border: 1px solid #4CAF50;">
                            ğŸ è·å¾—3æ¬¡æŠ½å¥–æœºä¼šï¼
                        </div>
                    ` : ''}
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button onclick="${success ? 'resetChances()' : 'closeQuizModal()'}" style="flex: 1; background: rgba(255,215,0,0.2); border: 1px solid #FFD700; color: white; padding: 12px; border-radius: 25px; cursor: pointer;">
                            ${success ? 'é‡ç½®æ¬¡æ•°' : 'å…³é—­'}
                        </button>
                        ${!success ? `
                            <button onclick="retryQuiz()" style="flex: 1; background: linear-gradient(90deg, #FF416C, #FF4B2B); border: none; color: white; padding: 12px; border-radius: 25px; cursor: pointer;">
                                é‡æ–°æŒ‘æˆ˜
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // ğŸ¯ é‡æ–°æŒ‘æˆ˜
        window.retryQuiz = function() {
            startQuiz();
        }

        // ğŸ¯ é‡ç½®æ¬¡æ•°
        window.resetChances = function() {
            remainingChances = 3;
            if (elements.chanceCountDisplay) {
                elements.chanceCountDisplay.textContent = remainingChances;
            }
            elements.quizModal.style.display = 'none';
            elements.resultText.textContent = "ğŸŠ æŠ½å¥–æ¬¡æ•°å·²é‡ç½®ï¼";
            playDingSound();
        }

        // ğŸ¯ å…³é—­å¼¹çª—
        window.closeQuizModal = function() {
            elements.quizModal.style.display = 'none';
        }

        // ğŸ¯ ç”Ÿæˆåˆå§‹æ•°æ®
        function generateInitialData() {
            const now = new Date();
            for (let i = 0; i < 10; i++) {
                const time = new Date(now.getTime() - i * 600000);
                winners.push({
                    name: nicknames[Math.floor(Math.random() * nicknames.length)],
                    prize: prizes[Math.floor(Math.random() * prizes.length)].name,
                    time: `${time.getHours().toString().padStart(2,'0')}:${time.getMinutes().toString().padStart(2,'0')}`
                });
            }
            currentUser = nicknames[Math.floor(Math.random() * nicknames.length)];
        }

        // ğŸ¯ åˆå§‹åŒ–éŸ³ä¹
        function initMusic() {
            setTimeout(() => {
                try {
                    elements.bgMusic.volume = 0.3;
                    elements.bgMusic.play().then(() => {
                        isBgMusicOn = true;
                        elements.bgMusicStatus.textContent = 'å¼€å¯';
                        elements.bgMusicBtn.classList.add('active');
                    }).catch(() => {
                        isBgMusicOn = false;
                    });
                } catch (e) {
                    console.log("éŸ³ä¹è‡ªåŠ¨æ’­æ”¾å¤±è´¥");
                }
            }, 500);
        }

        // ğŸ¯ ç»‘å®šäº‹ä»¶
        function bindEvents() {
            elements.bgMusicBtn.addEventListener('click', toggleBgMusic);
            elements.soundEffectBtn.addEventListener('click', toggleSoundEffect);
            elements.viewHistoryBtn.addEventListener('click', () => {
                elements.historyModal.style.display = 'flex';
            });
            elements.resetBtn.addEventListener('click', startQuiz);
            elements.closeModal.addEventListener('click', () => {
                elements.historyModal.style.display = 'none';
            });
            
            elements.historyModal.addEventListener('click', (e) => {
                if (e.target === elements.historyModal) {
                    elements.historyModal.style.display = 'none';
                }
            });
            
            elements.quizModal.addEventListener('click', (e) => {
                if (e.target === elements.quizModal) {
                    elements.quizModal.style.display = 'none';
                }
            });
        }

        // ğŸ¯ ä¸»åˆå§‹åŒ–
        function init() {
            console.log("å¼€å§‹åˆå§‹åŒ–...");
            
            // 1. è·å–DOMå…ƒç´ 
            initElements();
            
            // 2. ç«‹å³æ˜¾ç¤ºç•Œé¢
            initializeNineGrid();
            
            // 3. ç”Ÿæˆæ•°æ®
            generateInitialData();
            
            // 4. æ›´æ–°æ˜¾ç¤º
            updateWinnerList();
            updateHistoryDisplay();
            
            // 5. ç»‘å®šäº‹ä»¶
            bindEvents();
            
            // 6. åˆå§‹åŒ–éŸ³ä¹ï¼ˆå¼‚æ­¥ï¼‰
            initMusic();
            
            console.log("åˆå§‹åŒ–å®Œæˆï¼");
        }

        // ğŸ¯ é¡µé¢åŠ è½½å®Œæˆæ—¶ç«‹å³åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>

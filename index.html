<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Âπ∏ËøêÂ§ßÊäΩÂ•ñ - ‰πùÂÆ´Ê†º</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            min-height: 100vh;
            color: white;
            padding: 15px;
        }
        
        .container {
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
            text-align: center;
        }
        
        .header {
            margin-bottom: 20px;
            padding: 20px;
        }
        
        h1 {
            font-size: clamp(24px, 5vw, 36px);
            margin-bottom: 10px;
            background: linear-gradient(to right, #FFD700, #FFA500);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle {
            font-size: clamp(14px, 3vw, 18px);
            opacity: 0.8;
            margin-bottom: 20px;
        }
        
        .music-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .control-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 215, 0, 0.5);
            color: white;
            padding: 8px 20px;
            border-radius: 50px;
            cursor: pointer;
            font-size: clamp(14px, 3vw, 16px);
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .control-btn:hover {
            background: rgba(255, 215, 0, 0.2);
            transform: translateY(-2px);
        }
        
        .control-btn.active {
            background: rgba(255, 215, 0, 0.3);
            border-color: #FFD700;
        }
        
        /* ‰πùÂÆ´Ê†ºÂ∏ÉÂ±Ä */
        .nine-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 10px;
            width: min(95vw, 600px);
            height: min(95vw, 600px);
            margin: 0 auto 30px;
            position: relative;
        }
        
        .grid-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        /* Â•ñÂìÅÊ†ºÂ≠ê */
        .grid-item.prize {
            cursor: default;
        }
        
        .grid-item.prize.active {
            border-color: #FFD700;
            box-shadow: 0 0 25px rgba(255, 215, 0, 0.5);
            transform: scale(1.05);
            z-index: 2;
        }
        
        .prize-image {
            width: 70px;
            height: 70px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 8px;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .prize-emoji {
            font-size: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
            width: 70px;
            height: 70px;
        }
        
        .prize-name {
            font-size: 14px;
            text-align: center;
            font-weight: bold;
            color: #FFD700;
        }
        
        .prize-level {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 215, 0, 0.8);
            color: #000;
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: bold;
        }
        
        /* ‰∏≠ÂøÉÊäΩÂ•ñÊåâÈíÆÊ†ºÂ≠ê */
        .grid-item.center-btn {
            background: linear-gradient(145deg, #FF416C, #FF4B2B);
            border: none;
            cursor: pointer;
            grid-column: 2;
            grid-row: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            z-index: 10;
        }
        
        .grid-item.center-btn:hover {
            background: linear-gradient(145deg, #FF4B2B, #FF416C);
            box-shadow: 0 0 30px rgba(255, 65, 108, 0.7);
        }
        
        .grid-item.center-btn:active {
            transform: scale(0.98);
        }
        
        .grid-item.center-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            background: linear-gradient(145deg, #666, #888);
        }
        
        .start-btn-text {
            font-size: clamp(16px, 3vw, 20px);
            font-weight: bold;
            color: white;
        }
        
        .chance-count {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
        }
        
        .result-display {
            margin: 20px auto;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            max-width: 600px;
            border: 2px solid rgba(255, 215, 0, 0.2);
        }
        
        .result-text {
            font-size: clamp(18px, 4vw, 24px);
            margin-bottom: 15px;
            min-height: 40px;
        }
        
        .result-prize {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        
        @media (min-width: 768px) {
            .result-prize {
                flex-direction: row;
                justify-content: center;
            }
        }
        
        .result-emoji {
            font-size: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100px;
            height: 100px;
            background: rgba(255, 215, 0, 0.1);
            border-radius: 50%;
            border: 2px solid #FFD700;
        }
        
        .winner-board {
            margin-top: 30px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .board-header {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 215, 0, 0.3);
        }
        
        @media (min-width: 576px) {
            .board-header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }
        
        .board-title {
            font-size: clamp(18px, 4vw, 20px);
            color: #FFD700;
        }
        
        .view-history-btn, .reset-btn {
            background: rgba(255, 215, 0, 0.2);
            border: 1px solid #FFD700;
            color: white;
            padding: 8px 20px;
            border-radius: 50px;
            cursor: pointer;
            font-size: clamp(14px, 3vw, 16px);
            transition: all 0.3s;
        }
        
        .view-history-btn:hover, .reset-btn:hover {
            background: rgba(255, 215, 0, 0.3);
            transform: translateY(-2px);
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .winner-scroll {
            height: 200px;
            overflow: hidden;
            position: relative;
        }
        
        .winner-list {
            list-style: none;
        }
        
        .winner-list li {
            padding: 10px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* ÂºπÁ™óÊ†∑Âºè */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            width: 100%;
            max-width: 500px;
            border-radius: 20px;
            padding: 30px;
            position: relative;
            border: 2px solid #FFD700;
            box-shadow: 0 0 40px rgba(255, 215, 0, 0.4);
        }
        
        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 215, 0, 0.2);
            border: 1px solid #FFD700;
            color: white;
            font-size: 20px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* ÊóãËΩ¨Âä®Áîª */
        @keyframes rotateIndicator {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .spinning {
            animation: rotateIndicator 1s linear infinite;
        }
        
        /* ÂìçÂ∫îÂºè‰ºòÂåñ */
        @media (max-width: 768px) {
            .nine-grid {
                width: min(95vw, 500px);
                height: min(95vw, 500px);
            }
            
            .prize-emoji {
                width: 50px;
                height: 50px;
                font-size: 30px;
            }
            
            .prize-name {
                font-size: 12px;
            }
            
            .result-emoji {
                width: 70px;
                height: 70px;
                font-size: 40px;
            }
        }
        
        @media (max-width: 480px) {
            .nine-grid {
                width: min(95vw, 400px);
                height: min(95vw, 400px);
                gap: 5px;
            }
            
            .prize-emoji {
                width: 40px;
                height: 40px;
                font-size: 24px;
            }
            
            .prize-name {
                font-size: 10px;
            }
            
            .grid-item {
                padding: 5px;
            }
            
            .result-emoji {
                width: 60px;
                height: 60px;
                font-size: 32px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé∞ Âπ∏ËøêÂ§ßÊäΩÂ•ñ üé∞</h1>
            <p class="subtitle">ÁÇπÂáª‰∏≠ÂøÉÊåâÈíÆÂºÄÂßãÊäΩÂ•ñÔºå‰πùÂÆ´Ê†ºÂ∏ÉÂ±ÄÔºåÁ•ù‰Ω†Â•ΩËøêÔºÅ</p>
            
            <div class="music-controls">
                <button class="control-btn" id="bgMusicBtn">
                    <span>üéµ</span> ËÉåÊôØÈü≥‰πê: <span id="bgMusicStatus">ÂºÄÂêØ</span>
                </button>
                <button class="control-btn" id="soundEffectBtn">
                    <span>üîä</span> ÊóãËΩ¨Èü≥Êïà: <span id="soundEffectStatus">ÂºÄÂêØ</span>
                </button>
            </div>
        </div>
        
        <!-- ‰πùÂÆ´Ê†ºÂ∏ÉÂ±Ä -->
        <div class="nine-grid" id="nineGrid">
            <!-- Â•ñÂìÅÊ†ºÂ≠êÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
        </div>
        
        <!-- ÁªìÊûúÂ±ïÁ§∫ -->
        <div class="result-display">
            <div class="result-text" id="resultText">Á≠âÂæÖÊäΩÂ•ñÂºÄÂßã...</div>
            <div class="result-prize" id="resultPrize" style="display: none;">
                <div class="result-emoji" id="resultEmoji"></div>
                <div>
                    <div style="color: #FFD700; font-size: 20px; font-weight: bold;" id="resultPrizeName"></div>
                    <div style="color: #FFD700; font-size: 14px; margin-top: 5px;" id="resultPrizeLevel"></div>
                    <div style="margin-top: 10px; font-size: 14px; color: #aaa;" id="resultTime"></div>
                </div>
            </div>
        </div>
        
        <!-- ‰∏≠Â•ñÂêçÂçï -->
        <div class="winner-board">
            <div class="board-header">
                <div class="board-title">üèÜ ÂÆûÊó∂‰∏≠Â•ñÂêçÂçï</div>
                <div class="button-group">
                    <button class="view-history-btn" id="viewHistoryBtn">üìú ÊàëÁöÑ‰∏≠Â•ñËÆ∞ÂΩï</button>
                    <button class="reset-btn" id="resetBtn">üîÑ ÈáçÁΩÆÊ¨°Êï∞</button>
                </div>
            </div>
            
            <div class="winner-scroll">
                <ul class="winner-list" id="winnerList"></ul>
            </div>
        </div>
    </div>
    
    <!-- ÊàëÁöÑ‰∏≠Â•ñËÆ∞ÂΩïÂºπÁ™ó -->
    <div class="modal" id="historyModal">
        <div class="modal-content">
            <button class="close-modal" id="closeModal">√ó</button>
            <h2 style="color: #FFD700; margin-bottom: 15px;">üìã ÊàëÁöÑ‰∏≠Â•ñËÆ∞ÂΩï</h2>
            <div id="historyContent" style="max-height: 60vh; overflow-y: auto;"></div>
        </div>
    </div>
    
    <!-- Á≠îÈ¢òÂºπÁ™ó -->
    <div class="modal" id="quizModal">
        <div class="modal-content">
            <div id="quizContent">
                <!-- Á≠îÈ¢òÂÜÖÂÆπÂ∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
            </div>
        </div>
    </div>
    
    <!-- Èü≥‰πêÂÖÉÁ¥† -->
    <audio id="backgroundMusic" loop>
        <source src="papa.mp3" type="audio/mpeg">
        ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅÈü≥È¢ëÂÖÉÁ¥†
    </audio>
    
    <audio id="dingSound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3" type="audio/mpeg">
    </audio>

    <script>
        // üéØ Á≥ªÁªüÈÖçÁΩÆÊñá‰ª∂
        const SYSTEM_CONFIG = {
            QUIZ: {
                TOTAL_QUESTIONS: 5,
                REQUIRED_SCORE: 3,
                TIME_PER_QUESTION: 0,
                MAX_RETRY_TIMES: 3
            },
            LOTTERY: {
                INITIAL_CHANCES: 3,
                MAX_CHANCES: 10,
                RESET_COOLDOWN: 60
            },
            ANIMATION: {
                SPIN_FAST_SPEED: 80,
                SPIN_SLOW_SPEED: 200,
                TOTAL_SPINS: 20,
                FINAL_SPINS: 3
            },
            DISPLAY: {
                WINNERS_COUNT: 10,
                HISTORY_COUNT: 10,
                AUTO_REFRESH: 5000,
                EMOJI_SIZE: "40px"
            },
            SOUND: {
                BACKGROUND_VOLUME: 0.5,
                EFFECT_VOLUME: 0.7,
                ENABLE_BY_DEFAULT: true
            }
        };

        // üéØ Â•ñÂìÅÊï∞ÊçÆ
        const prizes = [
            { 
                id: 1, 
                name: "iPhone 16 Pro", 
                level: "‰∏ÄÁ≠âÂ•ñ",
                emoji: "üì±",
                color: "#FFD700",
                probability: 0.1 
            },
            { 
                id: 2, 
                name: "iPad Air", 
                level: "‰∫åÁ≠âÂ•ñ",
                emoji: "üíª",
                color: "#C0C0C0",
                probability: 0.2 
            },
            { 
                id: 3, 
                name: "Êô∫ËÉΩÊâãË°®", 
                level: "‰∏âÁ≠âÂ•ñ",
                emoji: "‚åö",
                color: "#CD7F32",
                probability: 0.3
            },
            { 
                id: 4, 
                name: "AirPods", 
                level: "ÂõõÁ≠âÂ•ñ",
                emoji: "üéß",
                color: "#4CAF50",
                probability: 0.4 
            },
            { 
                id: 5, 
                name: "ËÉåÂåÖ", 
                level: "‰∫îÁ≠âÂ•ñ",
                emoji: "üéí",
                color: "#2196F3",
                probability:  3
            },
            { 
                id: 6, 
                name: "Â•∂Ëå∂", 
                level: "ÂÖ≠Á≠âÂ•ñ",
                emoji: "üßã",
                color: "#E91E63",
                probability:  6
            },
            { 
                id: 7, 
                name: "ÁüøÊ≥âÊ∞¥", 
                level: "‰∏ÉÁ≠âÂ•ñ",
                emoji: "üíß",
                color: "#00BCD4",
                probability:  10
            },
            { 
                id: 8, 
                name: "Ë∞¢Ë∞¢ÂèÇ‰∏é", 
                level: "ÂèÇ‰∏éÂ•ñ",
                emoji: "üéÅ",
                color: "#9E9E9E",
                probability: 70 
            }
        ];

        // ‰πùÂÆ´Ê†ºÂ∏ÉÂ±ÄÈ°∫Â∫è
        const gridPositions = [
            { row: 1, col: 1 }, // Â∑¶‰∏ä
            { row: 1, col: 2 }, // ‰∏ä‰∏≠
            { row: 1, col: 3 }, // Âè≥‰∏ä
            { row: 2, col: 1 }, // Â∑¶‰∏≠
            { row: 2, col: 2 }, // ‰∏≠ÂøÉÔºàÊäΩÂ•ñÊåâÈíÆÔºâ
            { row: 2, col: 3 }, // Âè≥‰∏≠
            { row: 3, col: 1 }, // Â∑¶‰∏ã
            { row: 3, col: 2 }, // ‰∏ã‰∏≠
            { row: 3, col: 3 }  // Âè≥‰∏ã
        ];

        // ÁΩëÂêçÂ∫ì
        const nicknames = [
            "ÊòüÊ≤≥ÊªöÁÉ´", "‰∫∫Èó¥ÁêÜÊÉ≥", "ÊúàËâ≤ÁúüÁæé", "Ê∏ÖÈ£éÂæêÊù•", "‰∫ëÂç∑‰∫ëËàí", "Ëä±ÂºÄÂØåË¥µ", "ÊòüËæ∞Â§ßÊµ∑",
            "Êó∂ÂÖâÈùôÂ•Ω", "Êò•ÊöñËä±ÂºÄ", "ÁßãÊ∞¥‰ºä‰∫∫", "ÂåóÂüé‰ª•Âåó", "ÂçóÈ£éÊú™Ëµ∑", "Ë•øÊ•ºÊúà‰∏ã", "‰∏úÁØ±ÊääÈÖí",
            "ÂâëÊåáËãçÁ©π", "Á¨ëÂÇ≤Ê±üÊπñ", "Â¢®ÊüìÂÄæÂüé", "ÊµÖÁ¨ëÂÆâÁÑ∂", "ÁπÅÂçéËêΩÂπï", "Á¥†Âπ¥Èî¶Êó∂", "ÊµÆÁîüËã•Ê¢¶",
            "ÂçäÂüéÁÉüÊ≤ô", "‰∏Ä‰∏ñÁπÅÂçé", "‰∏âÁîü‰∏â‰∏ñ", "ÂõõÊµ∑ÂÖ´Ëçí", "‰∫îÊπñÂõõÊµ∑", "ÂÖ≠ÈÅìËΩÆÂõû", "‰∏ÉÊòüÈ´òÁÖß",
            "ÂÖ´‰ªôËøáÊµ∑", "‰πù‰πùÂΩí‰∏Ä", "ÂçÅÂÖ®ÂçÅÁæé", "Áôæ‰∫ãÂèØ‰πê", "ÂçÉ‰∏éÂçÉÂØª", "‰∏áÈáåÊåë‰∏Ä", "‰∫øË°®‰∫∫Êâç",
            "ÁéãËÄÖÂΩíÊù•", "Ëç£ËÄÄÁéãËÄÖ", "ÂêÉÈ∏°Â§ßÁ•û", "ÁîµÁ´ûÂ∞ëÂ•≥", "Ê∏∏Êàè‰∫∫Áîü", "‰∫åÊ¨°ÂÖÉÂêõ", "Âä®Êº´ÂÆÖÁî∑",
            "ÊñáËâ∫ÈùíÂπ¥", "ÊëáÊªöÂ∑®Êòü", "ÊµÅË°åÊïô‰∏ª", "Êó∂Â∞öËææ‰∫∫", "ÁæéÈ£üÂÆ∂", "ÊóÖË°åÂÆ∂", "ÊëÑÂΩ±Â∏à",
            "Á®ãÂ∫èÂëò", "ËÆæËÆ°Â∏à", "‰∫ßÂìÅÁªèÁêÜ", "ËøêËê•Â§ß‰Ω¨", "Â∏ÇÂú∫‰∏ìÂÆ∂", "ÈîÄÂîÆÂÜ†ÂÜõ", "Ë¥¢Âä°Ëá™Áî±",
            "ÊäïËµÑÂ§©Êâç", "Âàõ‰∏öÂÖàÈîã", "Â≠¶Èú∏Âêõ", "Â≠¶Ê∏£ÈÄÜË¢≠", "ËÄÉËØïÂ§ßÁ•û", "ËÆ∫ÊñáÊùÄÊâã", "ÂÆû‰π†Ëææ‰∫∫",
            "ËÅåÂú∫Á≤æËã±", "ÈÄÄ‰ºëÁîüÊ¥ª", "ÂÖªÁîü‰∏ìÂÆ∂", "ÂÅ•Ë∫´Ëææ‰∫∫", "Áëú‰ºΩÂ§ßÂ∏à", "Ë∑ëÊ≠•ÂÜ†ÂÜõ", "Ê∏∏Ê≥≥ÂÅ•Â∞Ü",
            "ÁØÆÁêÉÈ´òÊâã", "Ë∂≥ÁêÉÊòéÊòü", "ÁîµÁ´ûÈÄâÊâã", "‰∏ªÊí≠Â§ß‰Ω¨", "ÁΩëÁ∫¢Ëææ‰∫∫", "ÊµÅÈáèÊòéÊòü", "Á≤â‰∏ùÂçÉ‰∏á",
            "ÁÇπËµûËøá‰∏á", "ËØÑËÆ∫Á†¥ÂçÉ", "ËΩ¨ÂèëÁôæ‰∏á", "ÁÉ≠ÊêúÁ¨¨‰∏Ä", "ÁÉ≠Èó®ËØùÈ¢ò", "ÊµÅÈáèÊãÖÂΩì", "ÊúàÂÖâÊóè",
            "ÊúùÈò≥Áæ§‰ºó", "Â§úÁå´Â≠ê", "Êó©Ëµ∑È∏ü", "ÊäÄÊúØÂÆÖ", "ÊñáËâ∫ËåÉ", "ÈÖ∑Áõñ", "ËêåÊñ∞", "Â§ß‰Ω¨",
            "ËÇùÂ∏ù", "Ê¨ßÁöá", "ÈùûÈÖã", "Ê∞™Èáë", "ÁôΩÂ´ñ", "‰ΩõÁ≥ª", "Á°¨Ê†∏", "Ë∫∫Âπ≥", "ÂÜÖÂç∑", "ÊëÜÁÉÇ"
        ];

        // ËÑëÁ≠ãÊÄ•ËΩ¨ÂºØÈ¢òÂ∫ì
        const quizQuestions = [
            { question: "‰ªÄ‰πà‰∏úË•øË∂äÊ¥óË∂äËÑèÔºü", options: ["Ë°£Êúç", "Ê∞¥", "Á¢ó", "Êâã"], answer: 1 },
            { question: "‰ªÄ‰πàÈó®Ê∞∏ËøúÂÖ≥‰∏ç‰∏äÔºü", options: ["ÁêÉÈó®", "ÂÜ∞ÁÆ±Èó®", "ÂøÉÈó®", "ËΩ¶Èó®"], answer: 0 },
            { question: "‰ªÄ‰πà‰∏úË•øÂ§©Ê∞îË∂äÁÉ≠ÔºåÂÆÉÁà¨ÂæóË∂äÈ´òÔºü", options: ["Ê∏©Â∫¶ËÆ°", "ËöÇËöÅ", "Â§™Èò≥", "Ê∞îÁêÉ"], answer: 0 },
            { question: "‰ªÄ‰πàËõãÊâì‰∏çÁÉÇÔºåÁÖÆ‰∏çÁÜüÔºåÊõ¥‰∏çËÉΩÂêÉÔºü", options: ["È∏°Ëõã", "Á¨®Ëõã", "È∏≠Ëõã", "Èõ∂Ëõã"], answer: 1 },
            { question: "Áî®Ê§∞Â≠êÂíåË•øÁìúÊâìÂ§¥Âì™‰∏Ä‰∏™ÊØîËæÉÁóõÔºü", options: ["Ê§∞Â≠ê", "Ë•øÁìú", "Â§¥", "Êâã"], answer: 2 },
            { question: "Êó©Êô®ÈÜíÊù•ÔºåÊØè‰∏™‰∫∫ÈÉΩ‰ºöÂéªÂÅöÁöÑÁ¨¨‰∏Ä‰ª∂‰∫ãÊòØ‰ªÄ‰πàÔºü", options: ["ÁùÅÁúº", "Âà∑Áâô", "‰∏äÂéïÊâÄ", "Á©øË°£Êúç"], answer: 0 },
            { question: "‰ªÄ‰πà‰∏úË•ø‰∫∫‰ª¨Âú®‰∏çÂÅúÂú∞ÂêÉÂÆÉÔºåÂç¥Ê∞∏ËøúÂêÉ‰∏çÈ•±Ôºü", options: ["Á©∫Ê∞î", "Á±≥È•≠", "Èõ∂È£ü", "Âè£Ê∞¥"], answer: 0 },
            { question: "‰ªÄ‰πàËΩ¶Â≠êÂØ∏Ê≠•ÈöæË°åÔºü", options: ["È£éËΩ¶", "Ëá™Ë°åËΩ¶", "Ê±ΩËΩ¶", "È©¨ËΩ¶"], answer: 0 },
            { question: "Âì™‰∏Ä‰∏™ÊúàÊúâ‰∫åÂçÅÂÖ´Â§©Ôºü", options: ["‰∫åÊúà", "ÊØè‰∏™Êúà", "ÂçÅ‰∫åÊúà", "ÂÖ≠Êúà"], answer: 1 },
            { question: "‰ªÄ‰πàËã±ÊñáÂ≠óÊØçÊúÄÂ§ö‰∫∫ÂñúÊ¨¢Âê¨Ôºü", options: ["A", "C", "D", "CD"], answer: 3 },
            { question: "‰∏ÄÂè™Âá∂ÁåõÁöÑÈ•øÁå´ÔºåÁúãÂà∞ËÄÅÈº†Ôºå‰∏∫‰ΩïÊãîËÖøÂ∞±Ë∑ëÔºü", options: ["ÂéªËøΩËÄÅÈº†", "ÂéªÊçâËÄÅÈº†", "Ë∑ëÂéªÊãçÁîµÂΩ±", "Ë∑ëÂéªÊäìÈ±º"], answer: 3 },
            { question: "Â∞èÁ∫¢‰∏éÂ¶àÂ¶àÈÉΩÂú®Âêå‰∏Ä‰∏™Áè≠Èáå‰∏äËØæÔºåËøôÊòØ‰∏∫‰ªÄ‰πàÔºü", options: ["Â¶àÂ¶àÊòØËÄÅÂ∏à", "Â∞èÁ∫¢ÊòØËÄÅÂ∏à", "Â¶àÂ¶àÊòØÂ≠¶Áîü", "Â¶àÂ¶àÂú®Âê¨ËØæ"], answer: 0 },
            { question: "‰ªÄ‰πàÊ∞¥Ê∞∏ËøúÁî®‰∏çÂÆåÔºü", options: ["Ëá™Êù•Ê∞¥", "Ê≥™Ê∞¥", "Âè£Ê∞¥", "Ê≥™Ê∞¥"], answer: 2 },
            { question: "‰ªÄ‰πà‰∏úË•øÊúâ‰∫î‰∏™Â§¥Ôºå‰ΩÜ‰∫∫‰∏çËßâÂæóÂÆÉÊÄ™Ôºü", options: ["Êâã", "ËÑö", "ÊâãÂ•ó", "ÊÄ™Áâ©"], answer: 1 },
            { question: "‰ªÄ‰πàÈÖí‰∏çËÉΩÂñùÔºü", options: ["ÁôΩÈÖí", "Âï§ÈÖí", "Á¢òÈÖí", "Á∫¢ÈÖí"], answer: 2 },
            { question: "‰ªÄ‰πà‰∏úË•øÊôö‰∏äÊâçÁîüÂá∫Â∞æÂ∑¥Âë¢Ôºü", options: ["ÊòüÊòü", "Êúà‰∫Æ", "ÊµÅÊòü", "Ëê§ÁÅ´Ëô´"], answer: 2 },
            { question: "‰π¶Â∫óÈáå‰π∞‰∏çÂà∞‰ªÄ‰πà‰π¶Ôºü", options: ["ÊïôÁßë‰π¶", "Â∞èËØ¥", "ÈÅó‰π¶", "Êº´Áîª"], answer: 2 },
            { question: "‰ªÄ‰πàË∑ØÊúÄÁ™ÑÔºü", options: ["Â±±Ë∑Ø", "Ê∞¥Ë∑Ø", "ÂÜ§ÂÆ∂Ë∑ØÁ™Ñ", "ÂÖ¨Ë∑Ø"], answer: 2 },
            { question: "‰ªÄ‰πà‰∫∫ÂßãÁªà‰∏çÊï¢Ê¥óÊæ°Ôºü", options: ["Ê≥•‰∫∫", "Áõ≤‰∫∫", "ËÄÅ‰∫∫", "Â∞èÂ≠©"], answer: 0 },
            { question: "‰ªÄ‰πàÁâõ‰∏ç‰ºöÂêÉËçâÔºü", options: ["ËúóÁâõ", "Â•∂Áâõ", "ÈªÑÁâõ", "Ê∞¥Áâõ"], answer: 0 },
            { question: "‰ªÄ‰πà‰∏úË•øÂò¥ÈáåÊ≤°ÊúâËàåÂ§¥Ôºü", options: ["Ëå∂Â£∂Âò¥", "Ê∞¥Â£∂", "Ëå∂ÊùØ", "‰øùÊ∏©ÊùØ"], answer: 0 },
            { question: "‰ªÄ‰πà‰∫∫ÁîüÁóÖ‰ªéÊù•‰∏çÁúãÂåªÁîüÔºü", options: ["Áõ≤‰∫∫", "ÂåªÁîü", "Êú∫Âô®‰∫∫", "Ê≠ª‰∫∫"], answer: 1 },
            { question: "Êó∂Èíü‰ªÄ‰πàÊó∂ÂÄô‰∏ç‰ºöËµ∞Ôºü", options: ["Ê≤°ÁîµÊó∂", "Âùè‰∫ÜÊó∂", "Êó∂ÈíüÊú¨Êù•Â∞±‰∏ç‰ºöËµ∞", "Ë£ÖÁöÑÊó∂ÂÄô"], answer: 2 },
            { question: "‰ªÄ‰πàÂ≠óÂÖ®‰∏ñÁïåÈÄöÁî®Ôºü", options: ["Ëã±Êñá", "‰∏≠Êñá", "ÈòøÊãâ‰ºØÊï∞Â≠ó", "Êï∞Â≠¶Á¨¶Âè∑"], answer: 2 },
            { question: "‰∏∫‰ªÄ‰πàÂ∞èÁéã‰ªéÂàù‰∏ÄÂà∞Âàù‰∏âÂ∞±Â≠¶‰∫Ü‰∏ÄÁØáËØæÊñáÔºü", options: ["‰ªñÂæàÊáí", "ËÄÅÂ∏àÂè™Êïô‰∏ÄÁØá", "ËØæÊñáÂæàÈïø", "Âàù‰∏ÄÂà∞Âàù‰∏âÂè™Êúâ‰∏âÂ§©"], answer: 3 },
            { question: "‰∏Ä‰∏™‰∫∫Á©∫ËÇöÂ≠êÊúÄÂ§öËÉΩÂêÉÂá†‰∏™È∏°ËõãÔºü", options: ["‰∏Ä‰∏™", "‰∏§‰∏™", "‰∏â‰∏™", "‰∏Ä‰∏™ÔºàÂõ†‰∏∫ÂêÉ‰∫Ü‰∏Ä‰∏™ÂêéÂ∞±‰∏çÊòØÁ©∫ËÇöÂ≠ê‰∫ÜÔºâ"], answer: 3 },
            { question: "ÂΩìÂì•‰º¶Â∏É‰∏ÄÂè™ËÑöËøà‰∏äÊñ∞Â§ßÈôÜÂêéÔºåÁ¥ßÊé•ÁùÄÂÅö‰ªÄ‰πàÔºü", options: ["Ëøà‰∏äÂè¶‰∏ÄÂè™ËÑö", "Êèí‰∏äÊóóÂ∏ú", "È´òÂëºËÉúÂà©", "ÂºÄÂßãÊé¢Èô©"], answer: 0 },
            { question: "‰ªÄ‰πà‰∏úË•øÊØî‰πåÈ∏¶Êõ¥ËÆ®ÂéåÔºü", options: ["‰πåÈ∏¶Âò¥", "‰πåÈ∏¶ÁöÑÂêåÁ±ª", "‰πåÈ∏¶ÁöÑÊïå‰∫∫", "‰πåÈ∏¶Êú¨Ë∫´"], answer: 0 },
            { question: "‰∏ñÁïå‰∏äÈô§‰∫ÜÁÅ´ËΩ¶Âï•ËΩ¶ÊúÄÈïøÔºü", options: ["Â†µËΩ¶", "ÁÅ´ËΩ¶", "Ê±ΩËΩ¶", "Ë¥ßËΩ¶"], answer: 0 },
            { question: "‰ªÄ‰πà‰∏úË•ø‰∏çËÉΩÂêÉÔºü", options: ["‰∏úË•øÊñπÂêë", "È£üÁâ©", "Ê∞¥", "Á©∫Ê∞î"], answer: 0 },
            { question: "‰∏∫‰ªÄ‰πàÂ§ßÈõÅÁßãÂ§©Ë¶ÅÈ£ûÂà∞ÂçóÊñπÂéªÔºü", options: ["Âõ†‰∏∫ÂçóÊñπÊöñÂíå", "Âõ†‰∏∫Ëµ∞ÂæóÂ§™ÊÖ¢‰∫Ü", "Âõ†‰∏∫È£ûÊØîËµ∞Âø´", "Âõ†‰∏∫ÊòØÂÄôÈ∏ü"], answer: 1 },
            { question: "‰ªÄ‰πàÂ∏Ω‰∏çËÉΩÊà¥Ôºü", options: ["Ëû∫‰∏ùÂ∏Ω", "ËçâÂ∏Ω", "Ê£íÁêÉÂ∏Ω", "Á§ºÂ∏Ω"], answer: 0 },
            { question: "‰∏∫‰ªÄ‰πàÂ§ßÈÉ®ÂàÜ‰ΩõÊïôÂæíÈÉΩÂú®ÂåóÂçäÁêÉÔºü", options: ["ÂçóÊó†ÈòøÂº•ÈôÄ‰Ωõ", "Ê∞îÂÄôÂéüÂõ†", "ÂéÜÂè≤ÂéüÂõ†", "Âú∞ÁêÜÂéüÂõ†"], answer: 0 },
            { question: "‰ªÄ‰πà‰∏úË•øÊúâÂ§¥Êó†ËÑöÔºü", options: ["ÈíâÂ≠ê", "Ëõá", "ËöØËöì", "ÈìÖÁ¨î"], answer: 0 },
            { question: "Èªë‰∫∫‰∏∫‰ªÄ‰πàÂñúÊ¨¢ÂêÉÁôΩËâ≤Â∑ßÂÖãÂäõÔºü", options: ["ÊÄïÂí¨Âà∞Ëá™Â∑±ÁöÑÊâã", "ÁôΩËâ≤Â•ΩÂêÉ", "ÈªëËâ≤Â§™Ëã¶", "Ëê•ÂÖªÂ•Ω"], answer: 0 },
            { question: "Ë∞ÅÂ§©Â§©ÂéªÁúãÁóÖÔºü", options: ["ÂåªÁîü", "ÁóÖ‰∫∫", "Êä§Â£´", "ÂåªÈô¢Èô¢Èïø"], answer: 0 },
            { question: "‰ªÄ‰πàÁÖßÁâáÁúã‰∏çÂá∫ÁÖßÁöÑÊòØË∞ÅÔºü", options: ["XÂÖâÁÖßÁâá", "Ê®°Á≥äÁÖßÁâá", "ËÉåÂΩ±ÁÖßÁâá", "ÈªëÁôΩÁÖßÁâá"], answer: 0 },
            { question: "‰ªÄ‰πàÂ∏ÉÂâ™‰∏çÊñ≠Ôºü", options: ["ÁÄëÂ∏É", "Ê£âÂ∏É", "È∫ªÂ∏É", "Á∫±Â∏É"], answer: 0 },
            { question: "‰ªÄ‰πà‰∏úË•øÂÅöÁöÑ‰∫∫Áü•ÈÅìÔºå‰π∞ÁöÑ‰∫∫Áü•ÈÅìÔºåÂçñÁöÑ‰∫∫Áü•ÈÅìÔºåÁî®ÁöÑ‰∫∫Âç¥‰∏çÁü•ÈÅìÔºü", options: ["Ê£∫Êùê", "Ë°£Êúç", "È£üÁâ©", "ÊàøÂ≠ê"], answer: 0 },
            { question: "‰∏Ä‰∏™‰∫∫‰ªéÈ£ûÊú∫‰∏äÊéâ‰∏ãÊù•Ôºå‰∏∫‰ªÄ‰πàÊ≤°ÊëîÊ≠ªÂë¢Ôºü", options: ["È£ûÊú∫ÂÅúÂú®Âú∞‰∏ä", "ÊúâÈôçËêΩ‰ºû", "ÊéâÂú®Êµ∑Èáå", "ÊéâÂú®Ê£âËä±‰∏ä"], answer: 0 },
            { question: "‰ªÄ‰πà‰∫∫ÂøÉËÇ†ÊúÄ‰∏çÂ•ΩÔºü", options: ["ÂæóËÉÉËÇ†ÁÇéÁöÑ‰∫∫", "ÂøÉËÑèÁóÖÁöÑ‰∫∫", "Ê≤°ËâØÂøÉÁöÑ‰∫∫", "ÂåªÁîü"], answer: 1 },
            { question: "Âì™È°πÊØîËµõÊòØÂæÄÂêéË∑ëÁöÑÔºü", options: ["ÊãîÊ≤≥", "Ë∑ëÊ≠•", "Ê∏∏Ê≥≥", "Ë∑≥Ëøú"], answer: 0 },
            { question: "‰ªÄ‰πàÂÆò‰∏ç‰ªÖ‰∏çÈ¢ÜÂ∑•ËµÑÔºåËøòË¶ÅËá™ÊéèËÖ∞ÂåÖÔºü", options: ["Êñ∞ÈÉéÂÆò", "ÂÜõÂÆò", "Ê≥ïÂÆò", "ËÄÉÂÆò"], answer: 0 },
            { question: "‰ªÄ‰πà‰∫∫ÁîüÊù•Â∞±Áß∞ÁéãÔºü", options: ["ÂõΩÁéã", "ÁéãÂ≠ê", "ÁöáÂ∏ù", "ÂßìÁéãÁöÑ‰∫∫"], answer: 3 },
            { question: "‰ªÄ‰πàËä±Ê≤°ÊúâÊ†πÔºü", options: ["ÁÉüËä±", "Èõ™Ëä±", "Êµ™Ëä±", "ÁÅ´Ëä±"], answer: 0 },
            { question: "‰ªÄ‰πà‰∏úË•øÊúÄÂÆπÊòìÊª°Ë∂≥Ôºü", options: ["Ë¢úÂ≠ê", "ÈûãÂ≠ê", "Â∏ΩÂ≠ê", "ÊâãÂ•ó"], answer: 0 },
            { question: "‰ªÄ‰πàÈ∏°Ê≤°ÊúâÁøÖËÜÄÔºü", options: ["Áî∞È∏°", "Â±±È∏°", "ÈáéÈ∏°", "ÁÉßÈ∏°"], answer: 0 },
            { question: "‰ªÄ‰πàËàπ‰ªéÊù•‰∏ç‰∏ãÊ∞¥Ôºü", options: ["ÂÆáÂÆôÈ£ûËàπ", "Ëà™Á©∫ÊØçËà∞", "Â∏ÜËàπ", "Á†¥Ëàπ"], answer: 0 },
            { question: "‰ªÄ‰πà‰∫∫‰∏ÄÂπ¥‰∏≠Âè™Â∑•‰Ωú‰∏ÄÂ§©Ôºü", options: ["Âú£ËØûËÄÅ‰∫∫", "ÊºîÂëò", "Á®ãÂ∫èÂëò", "ËÄÅÂ∏à"], answer: 0 },
            { question: "‰ªÄ‰πà‰∫ãÂ§©‰∏çÁü•ÈÅìÂú∞Áü•ÈÅìÔºå‰Ω†‰∏çÁü•ÈÅìÊàëÁü•ÈÅìÔºü", options: ["ÈûãÂ≠êÁ†¥‰∫Ü", "ÁßòÂØÜ", "Â§©Ê∞î", "Á≠îÊ°à"], answer: 0 }
        ];

        // üéØ Áä∂ÊÄÅÂèòÈáè
        let isDrawing = false;
        let remainingChances = SYSTEM_CONFIG.LOTTERY.INITIAL_CHANCES;
        let isBgMusicOn = SYSTEM_CONFIG.SOUND.ENABLE_BY_DEFAULT;
        let isSoundEffectOn = SYSTEM_CONFIG.SOUND.ENABLE_BY_DEFAULT;
        let winners = [];
        let myHistory = [];
        let currentUser = nicknames[Math.floor(Math.random() * nicknames.length)];
        
        // Á≠îÈ¢òÁä∂ÊÄÅ
        let quizState = {
            currentQuestion: 0,
            score: 0,
            selectedOption: null,
            questions: []
        };

        // üéØ DOMÂÖÉÁ¥†
        let elements = {};

        // ÂàùÂßãÂåñDOMÂÖÉÁ¥†
        function initElements() {
            elements = {
                nineGrid: document.getElementById('nineGrid'),
                resultText: document.getElementById('resultText'),
                resultPrize: document.getElementById('resultPrize'),
                resultEmoji: document.getElementById('resultEmoji'),
                resultPrizeName: document.getElementById('resultPrizeName'),
                resultPrizeLevel: document.getElementById('resultPrizeLevel'),
                resultTime: document.getElementById('resultTime'),
                winnerList: document.getElementById('winnerList'),
                bgMusicBtn: document.getElementById('bgMusicBtn'),
                soundEffectBtn: document.getElementById('soundEffectBtn'),
                bgMusicStatus: document.getElementById('bgMusicStatus'),
                soundEffectStatus: document.getElementById('soundEffectStatus'),
                viewHistoryBtn: document.getElementById('viewHistoryBtn'),
                resetBtn: document.getElementById('resetBtn'),
                historyModal: document.getElementById('historyModal'),
                quizModal: document.getElementById('quizModal'),
                closeModal: document.getElementById('closeModal'),
                historyContent: document.getElementById('historyContent'),
                quizContent: document.getElementById('quizContent'),
                bgMusic: document.getElementById('backgroundMusic'),
                dingSound: document.getElementById('dingSound')
            };
        }

        // üéØ ÂàùÂßãÂåñ‰πùÂÆ´Ê†ºÂ∏ÉÂ±Ä
        function initializeNineGrid() {
            elements.nineGrid.innerHTML = '';
            
            // Êâì‰π±Â•ñÂìÅÈ°∫Â∫è
            const shuffledPrizes = [...prizes.filter(p => p.name !== "Ë∞¢Ë∞¢ÂèÇ‰∏é")];
            shuffledPrizes.sort(() => Math.random() - 0.5);
            
            // Á°Æ‰øùË∞¢Ë∞¢ÂèÇ‰∏éÂú®ÊúÄÂêé‰∏Ä‰∏™
            const thanksPrize = prizes.find(p => p.name === "Ë∞¢Ë∞¢ÂèÇ‰∏é");
            shuffledPrizes.push(thanksPrize);
            
            // ÂàõÂª∫Ê†ºÂ≠ê
            for (let i = 0; i < 9; i++) {
                const gridItem = document.createElement('div');
                const position = gridPositions[i];
                
                gridItem.style.gridColumn = position.col;
                gridItem.style.gridRow = position.row;
                
                if (i === 4) { // ‰∏≠ÂøÉÊäΩÂ•ñÊåâÈíÆ
                    gridItem.className = 'grid-item center-btn';
                    gridItem.id = 'startLotteryBtn';
                    gridItem.innerHTML = `
                        <div style="font-size: 32px;">üéÅ</div>
                        <div class="start-btn-text">ÂºÄÂßãÊäΩÂ•ñ</div>
                        <div class="chance-count">Ââ©‰Ωô: <span id="chanceCountDisplay">${remainingChances}</span> Ê¨°</div>
                    `;
                    
                    gridItem.addEventListener('click', startLottery);
                } else {
                    const prizeIndex = i < 4 ? i : i - 1;
                    const prize = shuffledPrizes[prizeIndex];
                    gridItem.className = 'grid-item prize';
                    gridItem.dataset.id = prize.id;
                    gridItem.dataset.index = prizeIndex;
                    
                    // üéØ ‰ΩøÁî®emoji
                    gridItem.innerHTML = `
                        <div class="prize-level">${prize.level}</div>
                        <div class="prize-emoji">${prize.emoji}</div>
                        <div class="prize-name">${prize.name}</div>
                    `;
                }
                
                elements.nineGrid.appendChild(gridItem);
            }
            
            // ‰øùÂ≠òchanceCountDisplayÂºïÁî®
            elements.chanceCountDisplay = document.getElementById('chanceCountDisplay');
        }

        // üéØ ‰øÆÂ§ç1ÔºöÊõ¥Êñ∞ÊäΩÂ•ñÊ¨°Êï∞ÊòæÁ§∫ÂáΩÊï∞
        function updateChanceCountDisplay() {
            if (elements.chanceCountDisplay) {
                elements.chanceCountDisplay.textContent = remainingChances;
            }
            
            // ‰πüÊõ¥Êñ∞‰∏≠ÂøÉÊåâÈíÆÁöÑÊòæÁ§∫
            const startBtn = document.getElementById('startLotteryBtn');
            if (startBtn) {
                const chanceCountSpan = startBtn.querySelector('.chance-count span');
                if (chanceCountSpan) {
                    chanceCountSpan.textContent = remainingChances;
                }
            }
        }

        // üéØ Êí≠ÊîæÈü≥Êïà
        function playDingSound() {
            if (!isSoundEffectOn) return;
            
            try {
                elements.dingSound.currentTime = 0;
                elements.dingSound.volume = SYSTEM_CONFIG.SOUND.EFFECT_VOLUME;
                elements.dingSound.play().catch(e => console.log("Èü≥ÊïàÊí≠ÊîæÂ§±Ë¥•"));
            } catch (e) {
                console.log("Èü≥ÊïàÈîôËØØ:", e);
            }
        }

        // üéØ ÂºÄÂßãÊäΩÂ•ñ
        function startLottery() {
            if (isDrawing) {
                console.log("Ê≠£Âú®ÊäΩÂ•ñ‰∏≠ÔºåËØ∑Á≠âÂæÖ...");
                return;
            }
            
            if (remainingChances <= 0) {
                elements.resultText.textContent = "ÊäΩÂ•ñÊ¨°Êï∞Â∑≤Áî®ÂÆåÔºÅÁÇπÂáªÈáçÁΩÆÊ¨°Êï∞Ëé∑ÂèñÊõ¥Â§öÊú∫‰ºö";
                return;
            }
            
            console.log("ÂºÄÂßãÊäΩÂ•ñ...");
            isDrawing = true;
            
            // Á´ãÂç≥Á¶ÅÁî®ÊåâÈíÆ
            const startBtn = document.getElementById('startLotteryBtn');
            if (startBtn) {
                startBtn.disabled = true;
                startBtn.innerHTML = `
                    <div style="font-size: 32px;" class="spinning">üéØ</div>
                    <div class="start-btn-text">ÊäΩÂ•ñ‰∏≠...</div>
                    <div class="chance-count">Ââ©‰Ωô: <span id="chanceCountDisplay">${remainingChances}</span> Ê¨°</div>
                `;
            }
            
            // Á´ãÂç≥ÊòæÁ§∫Áä∂ÊÄÅ
            elements.resultText.textContent = "üé∞ ÊäΩÂ•ñËøõË°å‰∏≠...";
            
            // ÈöêËóè‰∏ä‰∏ÄÊ¨°ÁöÑÁªìÊûú
            elements.resultPrize.style.display = 'none';
            
            // üéØ ÂºÇÊ≠•Á°ÆÂÆöÁõÆÊ†áÂ•ñÂìÅ
            setTimeout(() => {
                const totalProbability = prizes.reduce((sum, prize) => sum + prize.probability, 0);
                let randomNum = Math.random() * totalProbability;
                let selectedPrize = prizes[0];
                
                for (const prize of prizes) {
                    if (randomNum < prize.probability) {
                        selectedPrize = prize;
                        break;
                    }
                    randomNum -= prize.probability;
                }
                
                console.log(`‰∏≠Â•ñÂ•ñÂìÅ: ${selectedPrize.name}`);
                
                // ÂºÄÂßãÊóãËΩ¨Âä®Áîª
                startRotationAnimation(selectedPrize);
            }, 50);
        }

        // üéØ ÊóãËΩ¨Âä®ÁîªÔºà‰ΩøÁî®ÈÖçÁΩÆÔºâ
        function startRotationAnimation(selectedPrize) {
            const prizeItems = document.querySelectorAll('.grid-item.prize');
            let currentIndex = 0;
            let spinCount = 0;
            const totalSpins = SYSTEM_CONFIG.ANIMATION.TOTAL_SPINS;
            
            // Ê∏ÖÈô§È´ò‰∫Æ
            prizeItems.forEach(item => item.classList.remove('active'));
            
            function spin() {
                playDingSound();
                
                // Ê∏ÖÈô§‰∏ä‰∏Ä‰∏™
                if (spinCount > 0) {
                    const prevIndex = (currentIndex - 1 + prizeItems.length) % prizeItems.length;
                    prizeItems[prevIndex].classList.remove('active');
                }
                
                // È´ò‰∫ÆÂΩìÂâç
                prizeItems[currentIndex].classList.add('active');
                
                currentIndex = (currentIndex + 1) % prizeItems.length;
                spinCount++;
                
                if (spinCount < totalSpins) {
                    // Âä®ÊÄÅÈÄüÂ∫¶Ôºà‰ΩøÁî®ÈÖçÁΩÆÔºâ
                    let speed;
                    if (spinCount < 15) {
                        speed = SYSTEM_CONFIG.ANIMATION.SPIN_FAST_SPEED;
                    } else if (spinCount < 17) {
                        speed = SYSTEM_CONFIG.ANIMATION.SPIN_SLOW_SPEED;
                    } else {
                        speed = SYSTEM_CONFIG.ANIMATION.SPIN_SLOW_SPEED + (spinCount - 17) * 50;
                    }
                    setTimeout(spin, speed);
                } else {
                    // ÊâæÂà∞ÁõÆÊ†áÊ†ºÂ≠ê
                    let targetGridIndex = -1;
                    prizeItems.forEach((item, index) => {
                        if (parseInt(item.dataset.id) === selectedPrize.id) {
                            targetGridIndex = index;
                        }
                    });
                    
                    // Á≤æÂáÜÂÅúÊ≠¢
                    if (targetGridIndex !== -1) {
                        let movesToTarget = (targetGridIndex - currentIndex + prizeItems.length) % prizeItems.length;
                        if (movesToTarget === 0) movesToTarget = prizeItems.length;
                        
                        let finalMoves = 0;
                        
                        function finalAdjustment() {
                            playDingSound();
                            
                            const prev = prizeItems[(currentIndex - 1 + prizeItems.length) % prizeItems.length];
                            if (prev) prev.classList.remove('active');
                            
                            prizeItems[currentIndex].classList.add('active');
                            currentIndex = (currentIndex + 1) % prizeItems.length;
                            finalMoves++;
                            
                            if (finalMoves < movesToTarget) {
                                setTimeout(finalAdjustment, 200 + finalMoves * 80);
                            } else {
                                setTimeout(() => {
                                    showResult(selectedPrize);
                                }, 500);
                            }
                        }
                        
                        setTimeout(finalAdjustment, 300);
                    } else {
                        showResult(selectedPrize);
                    }
                }
            }
            
            setTimeout(spin, 100);
        }

        // üéØ ÊòæÁ§∫ÁªìÊûú
        function showResult(selectedPrize) {
            // Ê∏ÖÈô§È´ò‰∫Æ
            document.querySelectorAll('.grid-item.prize').forEach(item => {
                item.classList.remove('active');
            });
            
            // È´ò‰∫Æ‰∏≠Â•ñÊ†ºÂ≠ê
            const winningItems = document.querySelectorAll(`.grid-item.prize[data-id="${selectedPrize.id}"]`);
            winningItems.forEach(item => item.classList.add('active'));
            
            // Êõ¥Êñ∞Êó∂Èó¥
            const now = new Date();
            const timeStr = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')} ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}:${now.getSeconds().toString().padStart(2,'0')}`;
            
            // üéØ ÊòæÁ§∫‰∏≠Â•ñÁªìÊûú
            if (selectedPrize.name === "Ë∞¢Ë∞¢ÂèÇ‰∏é") {
                elements.resultText.textContent = `üò¢ ${selectedPrize.name}Ôºå‰∏ãÊ¨°ÁªßÁª≠Âä†Ê≤πÔºÅ`;
                elements.resultPrize.style.display = 'none';
            } else {
                elements.resultText.textContent = `üéâ ÊÅ≠ÂñúÔºÅÊäΩ‰∏≠ ${selectedPrize.name} üéâ`;
                
                // ËÆæÁΩÆemoji
                elements.resultEmoji.textContent = selectedPrize.emoji;
                elements.resultEmoji.style.color = selectedPrize.color;
                
                // ËÆæÁΩÆÂ•ñÂìÅÂêçÁß∞ÂíåÁ≠âÁ∫ß
                elements.resultPrizeName.textContent = selectedPrize.name;
                elements.resultPrizeLevel.textContent = selectedPrize.level;
                elements.resultPrizeLevel.style.color = selectedPrize.color;
                
                // ËÆæÁΩÆÊó∂Èó¥
                elements.resultTime.textContent = `‰∏≠Â•ñÊó∂Èó¥: ${timeStr}`;
                
                // ÊòæÁ§∫ÁªìÊûúÂå∫Âüü
                elements.resultPrize.style.display = 'flex';
            }
            
            // Êõ¥Êñ∞Ê¨°Êï∞
            remainingChances--;
            updateChanceCountDisplay(); // ‰øÆÂ§ç2ÔºöÁ´ãÂç≥Êõ¥Êñ∞ÊòæÁ§∫
            
            // Ê∑ªÂä†Âà∞ËÆ∞ÂΩï
            myHistory.unshift({
                name: currentUser,
                prize: selectedPrize.name,
                level: selectedPrize.level,
                time: timeStr,
                emoji: selectedPrize.emoji,
                color: selectedPrize.color
            });
            
            // Ê∑ªÂä†Âà∞ÂÖ¨ÂÖ±ÂêçÂçï
            const randomName = nicknames[Math.floor(Math.random() * nicknames.length)];
            winners.unshift({ 
                name: randomName, 
                prize: selectedPrize.name, 
                level: selectedPrize.level,
                time: now.toLocaleTimeString(),
                emoji: selectedPrize.emoji
            });
            
            // ÈôêÂà∂ÊòæÁ§∫Êï∞Èáè
            if (winners.length > SYSTEM_CONFIG.DISPLAY.WINNERS_COUNT * 2) {
                winners = winners.slice(0, SYSTEM_CONFIG.DISPLAY.WINNERS_COUNT * 2);
            }
            
            updateWinnerList();
            
            // üéØ ÈáçÁΩÆÊåâÈíÆÁä∂ÊÄÅ
            isDrawing = false;
            const startBtn = document.getElementById('startLotteryBtn');
            if (startBtn) {
                startBtn.disabled = false;
                startBtn.innerHTML = `
                    <div style="font-size: 32px;">üéÅ</div>
                    <div class="start-btn-text">ÂºÄÂßãÊäΩÂ•ñ</div>
                    <div class="chance-count">Ââ©‰Ωô: <span id="chanceCountDisplay">${remainingChances}</span> Ê¨°</div>
                `;
                startBtn.classList.remove('spinning');
                
                // ÈáçÊñ∞‰øùÂ≠òÂºïÁî®
                elements.chanceCountDisplay = document.getElementById('chanceCountDisplay');
            }
            
            updateHistoryDisplay();
        }

        // üéØ Êõ¥Êñ∞‰∏≠Â•ñÂêçÂçï
        function updateWinnerList() {
            if (!elements.winnerList) return;
            
            elements.winnerList.innerHTML = '';
            const displayWinners = winners.slice(0, SYSTEM_CONFIG.DISPLAY.WINNERS_COUNT);
            
            displayWinners.forEach(winner => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 18px;">${winner.emoji}</span>
                        <span>üë§ ${winner.name}</span>
                    </span>
                    <span style="color: #FFD700; margin: 0 10px; font-weight: bold;">${winner.prize}</span>
                    <span style="font-size: 12px; color: #aaa;">${winner.time}</span>
                `;
                elements.winnerList.appendChild(li);
            });
        }

        // üéØ Êõ¥Êñ∞ÊàëÁöÑËÆ∞ÂΩï
        function updateHistoryDisplay() {
            if (!elements.historyContent) return;
            
            elements.historyContent.innerHTML = '';
            
            if (myHistory.length === 0) {
                elements.historyContent.innerHTML = '<p style="text-align: center; padding: 20px; color: #999;">ÊöÇÊó†‰∏≠Â•ñËÆ∞ÂΩï</p>';
                return;
            }
            
            myHistory.slice(0, SYSTEM_CONFIG.DISPLAY.HISTORY_COUNT).forEach(record => {
                const div = document.createElement('div');
                div.style.cssText = 'display: flex; align-items: center; padding: 10px; margin-bottom: 8px; background: rgba(255,255,255,0.05); border-radius: 8px;';
                
                div.innerHTML = `
                    <div style="font-size: 28px; margin-right: 12px; color: ${record.color};">${record.emoji}</div>
                    <div style="flex: 1;">
                        <div style="color: #FFD700; font-weight: bold;">${record.name}</div>
                        <div>${record.prize} 
                            <span style="font-size: 12px; background: rgba(255,215,0,0.2); padding: 2px 8px; border-radius: 8px; margin-left: 8px; color: ${record.color};">${record.level}</span>
                        </div>
                    </div>
                    <div style="font-size: 12px; color: #999; text-align: right;">
                        <div>${record.time.split(' ')[0]}</div>
                        <div>${record.time.split(' ')[1]}</div>
                    </div>
                `;
                
                elements.historyContent.appendChild(div);
            });
        }

        // üéØ ‰øÆÂ§ç3Ôºö‰ºòÂåñÈü≥‰πêÊéßÂà∂ÂáΩÊï∞
        function toggleBgMusic() {
            isBgMusicOn = !isBgMusicOn;
            elements.bgMusicStatus.textContent = isBgMusicOn ? 'ÂºÄÂêØ' : 'ÂÖ≥Èó≠';
            
            if (isBgMusicOn) {
                elements.bgMusic.volume = SYSTEM_CONFIG.SOUND.BACKGROUND_VOLUME;
                elements.bgMusic.play().catch(e => {
                    console.log("Èü≥‰πêÊí≠ÊîæÂ§±Ë¥•ÔºåÂ∞ùËØïÈáçÊñ∞Âä†ËΩΩ:", e);
                    // Â¶ÇÊûúÊí≠ÊîæÂ§±Ë¥•ÔºåÂ∞ùËØïÈáçÊñ∞ËÆæÁΩÆÊ∫ê
                    elements.bgMusic.load();
                    setTimeout(() => {
                        elements.bgMusic.play().catch(e2 => console.log("ÂÜçÊ¨°Â∞ùËØïÂ§±Ë¥•:", e2));
                    }, 500);
                });
                elements.bgMusicBtn.classList.add('active');
            } else {
                elements.bgMusic.pause();
                elements.bgMusicBtn.classList.remove('active');
            }
        }

        // üéØ ÂàáÊç¢Èü≥Êïà
        function toggleSoundEffect() {
            isSoundEffectOn = !isSoundEffectOn;
            elements.soundEffectStatus.textContent = isSoundEffectOn ? 'ÂºÄÂêØ' : 'ÂÖ≥Èó≠';
            elements.soundEffectBtn.classList.toggle('active', isSoundEffectOn);
        }

        // üéØ ÂºÄÂßãÁ≠îÈ¢ò
        function startQuiz() {
            if (remainingChances >= SYSTEM_CONFIG.LOTTERY.MAX_CHANCES) {
                elements.resultText.textContent = "üéä ÊäΩÂ•ñÊ¨°Êï∞Â∑≤Ëææ‰∏äÈôêÔºÅ";
                return;
            }
            
            quizState = {
                currentQuestion: 0,
                score: 0,
                selectedOption: null,
                questions: [...quizQuestions].sort(() => Math.random() - 0.5).slice(0, SYSTEM_CONFIG.QUIZ.TOTAL_QUESTIONS)
            };
            
            showQuizQuestion();
            elements.quizModal.style.display = 'flex';
        }

        // üéØ ÊòæÁ§∫È¢òÁõÆ
        function showQuizQuestion() {
            const q = quizState.questions[quizState.currentQuestion];
            const progress = (quizState.currentQuestion / SYSTEM_CONFIG.QUIZ.TOTAL_QUESTIONS) * 100;
            
            elements.quizContent.innerHTML = `
                <div style="text-align: center;">
                    <h2 style="color: #FFD700; margin-bottom: 15px;">üß† Á≠îÈ¢òÈáçÁΩÆ</h2>
                    <div style="background: rgba(255,255,255,0.1); height: 6px; border-radius: 3px; margin: 15px 0;">
                        <div style="height: 100%; background: linear-gradient(90deg, #FF416C, #FF4B2B); width: ${progress}%; transition: width 0.3s;"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 20px; color: #FFD700;">
                        <span>Á¨¨ ${quizState.currentQuestion + 1}/${SYSTEM_CONFIG.QUIZ.TOTAL_QUESTIONS} È¢ò</span>
                        <span>ÂæóÂàÜ: ${quizState.score}/${SYSTEM_CONFIG.QUIZ.REQUIRED_SCORE}</span>
                    </div>
                    <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: left;">
                        <div style="font-size: 18px; margin-bottom: 15px; color: white;">${q.question}</div>
                        <div style="display: grid; gap: 10px;">
                            ${q.options.map((opt, i) => `
                                <button onclick="selectQuizOption(${i})" style="background: ${quizState.selectedOption === i ? 'rgba(255,215,0,0.2)' : 'rgba(255,255,255,0.05)'}; border: 1px solid ${quizState.selectedOption === i ? '#FFD700' : 'rgba(255,215,0,0.3)'}; color: white; padding: 12px; border-radius: 8px; text-align: left; cursor: pointer;">
                                    ${String.fromCharCode(65 + i)}. ${opt}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                    <button onclick="submitQuizAnswer()" style="background: linear-gradient(90deg, #FF416C, #FF4B2B); color: white; border: none; padding: 12px 30px; border-radius: 25px; font-size: 16px; cursor: pointer; width: 100%;" ${quizState.selectedOption === null ? 'disabled' : ''}>
                        ${quizState.currentQuestion < SYSTEM_CONFIG.QUIZ.TOTAL_QUESTIONS - 1 ? 'Êèê‰∫§Á≠îÊ°à' : 'ÂÆåÊàêÁ≠îÈ¢ò'}
                    </button>
                </div>
            `;
        }

        // üéØ ÈÄâÊã©Á≠îÊ°à
        window.selectQuizOption = function(index) {
            quizState.selectedOption = index;
            showQuizQuestion();
        }

        // üéØ Êèê‰∫§Á≠îÊ°à
        window.submitQuizAnswer = function() {
            if (quizState.selectedOption === null) return;
            
            const q = quizState.questions[quizState.currentQuestion];
            if (quizState.selectedOption === q.answer) {
                quizState.score++;
                playDingSound();
            }
            
            quizState.currentQuestion++;
            quizState.selectedOption = null;
            
            if (quizState.currentQuestion < quizState.questions.length) {
                showQuizQuestion();
            } else {
                showQuizResult();
            }
        }

        // üéØ ‰øÆÂ§ç4ÔºöÊòæÁ§∫Á≠îÈ¢òÁªìÊûúÂπ∂Á´ãÂç≥Âà∑Êñ∞ÊäΩÂ•ñÊ¨°Êï∞
        function showQuizResult() {
            const success = quizState.score >= SYSTEM_CONFIG.QUIZ.REQUIRED_SCORE;
            
            elements.quizContent.innerHTML = `
                <div style="text-align: center; padding: 20px 0;">
                    <div style="font-size: 60px; margin-bottom: 15px;">${success ? 'üéâ' : 'üò¢'}</div>
                    <div style="font-size: 20px; color: #FFD700; margin-bottom: 15px;">
                        ${success ? 'ÊÅ≠ÂñúÔºÅÁ≠îÈ¢òÊàêÂäüÔºÅ' : 'ÂæàÈÅóÊÜæÔºåÁ≠îÈ¢òÂ§±Ë¥•'}
                    </div>
                    <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; margin: 15px 0;">
                        <div>ÂæóÂàÜ: ${quizState.score}/${SYSTEM_CONFIG.QUIZ.TOTAL_QUESTIONS}</div>
                        <div style="font-size: 32px; color: #FFD700; margin: 10px 0;">${quizState.score}ÂàÜ</div>
                        <div>${success ? '‚úÖ ËææÂà∞Ë¶ÅÊ±ÇÂàÜÊï∞' : `‚ùå ÈúÄË¶Å${SYSTEM_CONFIG.QUIZ.REQUIRED_SCORE}ÂàÜÊâçËÉΩÈáçÁΩÆ`}</div>
                    </div>
                    ${success ? `
                        <div style="color: #4CAF50; background: rgba(76,175,80,0.1); padding: 10px; border-radius: 8px; margin: 15px 0; border: 1px solid #4CAF50;">
                            üéÅ Ëé∑Âæó${SYSTEM_CONFIG.LOTTERY.INITIAL_CHANCES}Ê¨°ÊäΩÂ•ñÊú∫‰ºöÔºÅ
                        </div>
                    ` : ''}
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button onclick="${success ? 'resetChances()' : 'closeQuizModal()'}" style="flex: 1; background: rgba(255,215,0,0.2); border: 1px solid #FFD700; color: white; padding: 12px; border-radius: 25px; cursor: pointer;">
                            ${success ? 'ÈáçÁΩÆÊ¨°Êï∞' : 'ÂÖ≥Èó≠'}
                        </button>
                        ${!success ? `
                            <button onclick="retryQuiz()" style="flex: 1; background: linear-gradient(90deg, #FF416C, #FF4B2B); border: none; color: white; padding: 12px; border-radius: 25px; cursor: pointer;">
                                ÈáçÊñ∞ÊåëÊàò
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // üéØ ÈáçÊñ∞ÊåëÊàò
        window.retryQuiz = function() {
            startQuiz();
        }

        // üéØ ‰øÆÂ§ç5ÔºöÈáçÁΩÆÊ¨°Êï∞Âπ∂Á´ãÂç≥Êõ¥Êñ∞ÊòæÁ§∫
        window.resetChances = function() {
            remainingChances = SYSTEM_CONFIG.LOTTERY.INITIAL_CHANCES;
            updateChanceCountDisplay(); // Á´ãÂç≥Êõ¥Êñ∞ÊòæÁ§∫
            elements.quizModal.style.display = 'none';
            elements.resultText.textContent = "üéä ÊäΩÂ•ñÊ¨°Êï∞Â∑≤ÈáçÁΩÆÔºÅ";
            playDingSound();
        }

        // üéØ ÂÖ≥Èó≠ÂºπÁ™ó
        window.closeQuizModal = function() {
            elements.quizModal.style.display = 'none';
        }

        // üéØ ÁîüÊàêÂàùÂßãÊï∞ÊçÆ
        function generateInitialData() {
            const now = new Date();
            for (let i = 0; i < SYSTEM_CONFIG.DISPLAY.WINNERS_COUNT; i++) {
                const time = new Date(now.getTime() - i * 600000);
                const randomPrize = prizes[Math.floor(Math.random() * prizes.length)];
                winners.push({
                    name: nicknames[Math.floor(Math.random() * nicknames.length)],
                    prize: randomPrize.name,
                    level: randomPrize.level,
                    time: `${time.getHours().toString().padStart(2,'0')}:${time.getMinutes().toString().padStart(2,'0')}`,
                    emoji: randomPrize.emoji
                });
            }
            currentUser = nicknames[Math.floor(Math.random() * nicknames.length)];
        }

        // üéØ ‰øÆÂ§ç6Ôºö‰ºòÂåñÈü≥‰πêÂàùÂßãÂåñ
        function initMusic() {
            // È¢ÑÂä†ËΩΩÈü≥È¢ë
            try {
                elements.bgMusic.load();
                elements.dingSound.load();
                
                // ËÆæÁΩÆÈü≥Èáè
                elements.bgMusic.volume = SYSTEM_CONFIG.SOUND.BACKGROUND_VOLUME;
                elements.dingSound.volume = SYSTEM_CONFIG.SOUND.EFFECT_VOLUME;
                
                // ÁõëÂê¨Èü≥È¢ëÂä†ËΩΩÂÆåÊàê
                elements.bgMusic.addEventListener('canplaythrough', () => {
                    console.log("ËÉåÊôØÈü≥‰πêÂ∑≤Âä†ËΩΩÂÆåÊàê");
                });
                
                elements.dingSound.addEventListener('canplaythrough', () => {
                    console.log("Èü≥ÊïàÂ∑≤Âä†ËΩΩÂÆåÊàê");
                });
                
                // Ê∑ªÂä†Áî®Êà∑‰∫§‰∫íÂêéËá™Âä®Êí≠Êîæ
                document.addEventListener('click', () => {
                    if (isBgMusicOn && elements.bgMusic.paused) {
                        elements.bgMusic.play().catch(e => {
                            console.log("‰∫§‰∫íÂêéÊí≠ÊîæÂ§±Ë¥•:", e);
                        });
                    }
                }, { once: true });
                
            } catch (e) {
                console.log("Èü≥È¢ëÂàùÂßãÂåñÂ§±Ë¥•:", e);
            }
        }

        // üéØ ÁªëÂÆö‰∫ã‰ª∂
        function bindEvents() {
            elements.bgMusicBtn.addEventListener('click', toggleBgMusic);
            elements.soundEffectBtn.addEventListener('click', toggleSoundEffect);
            elements.viewHistoryBtn.addEventListener('click', () => {
                elements.historyModal.style.display = 'flex';
            });
            elements.resetBtn.addEventListener('click', startQuiz);
            elements.closeModal.addEventListener('click', () => {
                elements.historyModal.style.display = 'none';
            });
            
            elements.historyModal.addEventListener('click', (e) => {
                if (e.target === elements.historyModal) {
                    elements.historyModal.style.display = 'none';
                }
            });
            
            elements.quizModal.addEventListener('click', (e) => {
                if (e.target === elements.quizModal) {
                    elements.quizModal.style.display = 'none';
                }
            });
        }

        // üéØ ‰∏ªÂàùÂßãÂåñ
        function init() {
            console.log("ÂºÄÂßãÂàùÂßãÂåñ...");
            
            // 1. Ëé∑ÂèñDOMÂÖÉÁ¥†
            initElements();
            
            // 2. Á´ãÂç≥ÊòæÁ§∫ÁïåÈù¢
            initializeNineGrid();
            
            // 3. ÁîüÊàêÊï∞ÊçÆ
            generateInitialData();
            
            // 4. Êõ¥Êñ∞ÊòæÁ§∫
            updateWinnerList();
            updateHistoryDisplay();
            
            // 5. ÁªëÂÆö‰∫ã‰ª∂
            bindEvents();
            
            // 6. ÂàùÂßãÂåñÈü≥‰πê
            initMusic();
            
            console.log("ÂàùÂßãÂåñÂÆåÊàêÔºÅ");
            console.log("Èü≥È¢ëÊñá‰ª∂Ë∑ØÂæÑ: papa.mp3");
        }

        // üéØ È°µÈù¢Âä†ËΩΩÂÆåÊàêÊó∂Á´ãÂç≥ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>

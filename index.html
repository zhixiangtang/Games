<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹¸è¿å¤§æŠ½å¥–</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            min-height: 100vh;
            color: white;
            padding: 15px;
        }
        
        .container {
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
            text-align: center;
        }
        
        .header {
            margin-bottom: 20px;
            padding: 20px;
        }
        
        h1 {
            font-size: clamp(24px, 5vw, 36px);
            margin-bottom: 10px;
            background: linear-gradient(to right, #FFD700, #FFA500);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle {
            font-size: clamp(14px, 3vw, 18px);
            opacity: 0.8;
            margin-bottom: 20px;
        }
        
        .music-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .control-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 215, 0, 0.5);
            color: white;
            padding: 8px 20px;
            border-radius: 50px;
            cursor: pointer;
            font-size: clamp(14px, 3vw, 16px);
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .control-btn:hover {
            background: rgba(255, 215, 0, 0.2);
            transform: translateY(-2px);
        }
        
        .control-btn.active {
            background: rgba(255, 215, 0, 0.3);
            border-color: #FFD700;
        }
        
        /* ä¹å®«æ ¼å¸ƒå±€ */
        .nine-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 10px;
            width: min(95vw, 600px);
            height: min(95vw, 600px);
            margin: 0 auto 30px;
            position: relative;
        }
        
        .grid-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        /* å¥–å“æ ¼å­ */
        .grid-item.prize {
            cursor: default;
        }
        
        .grid-item.prize.active {
            border-color: #FFD700;
            box-shadow: 0 0 25px rgba(255, 215, 0, 0.5);
            transform: scale(1.05);
            z-index: 2;
        }
        
        .prize-image {
            width: 70px;
            height: 70px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 8px;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .prize-name {
            font-size: 14px;
            text-align: center;
            font-weight: bold;
            color: #FFD700;
        }
        
        .prize-level {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 215, 0, 0.8);
            color: #000;
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: bold;
        }
        
        /* ä¸­å¿ƒæŠ½å¥–æŒ‰é’®æ ¼å­ - å›ºå®šä½ç½®ä¸è·³åŠ¨ */
        .grid-item.center-btn {
            background: linear-gradient(145deg, #FF416C, #FF4B2B);
            border: none;
            cursor: pointer;
            grid-column: 2;
            grid-row: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            z-index: 10;
            /* ç§»é™¤transformï¼Œä½¿ç”¨gridå›ºå®šä½ç½® */
        }
        
        .grid-item.center-btn:hover {
            background: linear-gradient(145deg, #FF4B2B, #FF416C);
            box-shadow: 0 0 30px rgba(255, 65, 108, 0.7);
            /* ä¸å†ä½¿ç”¨transformï¼Œé¿å…ä½ç½®è·³åŠ¨ */
        }
        
        .grid-item.center-btn:active {
            transform: scale(0.98);
        }
        
        .grid-item.center-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            background: linear-gradient(145deg, #666, #888);
        }
        
        .start-btn-text {
            font-size: clamp(16px, 3vw, 20px);
            font-weight: bold;
            color: white;
        }
        
        .chance-count {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
        }
        
        .result-display {
            margin: 20px auto;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            max-width: 600px;
            border: 2px solid rgba(255, 215, 0, 0.2);
        }
        
        .result-text {
            font-size: clamp(18px, 4vw, 24px);
            margin-bottom: 15px;
            min-height: 40px;
        }
        
        .result-prize {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        
        @media (min-width: 768px) {
            .result-prize {
                flex-direction: row;
                justify-content: center;
            }
        }
        
        .result-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 12px;
            border: 2px solid #FFD700;
        }
        
        .winner-board {
            margin-top: 30px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .board-header {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 215, 0, 0.3);
        }
        
        @media (min-width: 576px) {
            .board-header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }
        
        .board-title {
            font-size: clamp(18px, 4vw, 20px);
            color: #FFD700;
        }
        
        .view-history-btn, .reset-btn {
            background: rgba(255, 215, 0, 0.2);
            border: 1px solid #FFD700;
            color: white;
            padding: 8px 20px;
            border-radius: 50px;
            cursor: pointer;
            font-size: clamp(14px, 3vw, 16px);
            transition: all 0.3s;
        }
        
        .view-history-btn:hover, .reset-btn:hover {
            background: rgba(255, 215, 0, 0.3);
            transform: translateY(-2px);
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .winner-scroll {
            height: 200px;
            overflow: hidden;
            position: relative;
        }
        
        .winner-list {
            list-style: none;
        }
        
        .winner-list li {
            padding: 10px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* å¼¹çª—æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            width: 100%;
            max-width: 500px;
            border-radius: 20px;
            padding: 30px;
            position: relative;
            border: 2px solid #FFD700;
            box-shadow: 0 0 40px rgba(255, 215, 0, 0.4);
        }
        
        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 215, 0, 0.2);
            border: 1px solid #FFD700;
            color: white;
            font-size: 20px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* æ—‹è½¬åŠ¨ç”» */
        @keyframes rotateIndicator {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .spinning {
            animation: rotateIndicator 1s linear infinite;
        }
        
        /* å“åº”å¼ä¼˜åŒ– */
        @media (max-width: 768px) {
            .nine-grid {
                width: min(95vw, 500px);
                height: min(95vw, 500px);
            }
            
            .prize-image {
                width: 50px;
                height: 50px;
            }
            
            .prize-name {
                font-size: 12px;
            }
        }
        
        @media (max-width: 480px) {
            .nine-grid {
                width: min(95vw, 400px);
                height: min(95vw, 400px);
                gap: 5px;
            }
            
            .prize-image {
                width: 40px;
                height: 40px;
            }
            
            .prize-name {
                font-size: 10px;
            }
            
            .grid-item {
                padding: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ° å¹¸è¿å¤§æŠ½å¥– ğŸ°</h1>
            <p class="subtitle">ç‚¹å‡»ä¸­å¿ƒæŒ‰é’®å¼€å§‹æŠ½å¥–ï¼Œä¹å®«æ ¼å¸ƒå±€ï¼Œç¥ä½ å¥½è¿ï¼</p>
            
            <div class="music-controls">
                <button class="control-btn" id="bgMusicBtn">
                    <span>ğŸµ</span> èƒŒæ™¯éŸ³ä¹: <span id="bgMusicStatus">å¼€å¯</span>
                </button>
                <button class="control-btn" id="soundEffectBtn">
                    <span>ğŸ”Š</span> æ—‹è½¬éŸ³æ•ˆ: <span id="soundEffectStatus">å¼€å¯</span>
                </button>
            </div>
        </div>
        
        <!-- ä¹å®«æ ¼å¸ƒå±€ -->
        <div class="nine-grid" id="nineGrid">
            <!-- å¥–å“æ ¼å­é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
        
        <!-- ç»“æœå±•ç¤º -->
        <div class="result-display">
            <div class="result-text" id="resultText">ç­‰å¾…æŠ½å¥–å¼€å§‹...</div>
            <div class="result-prize" id="resultPrize" style="display: none;">
                <img id="resultImage" class="result-image" alt="ä¸­å¥–å¥–å“">
                <div>
                    <div style="color: #FFD700; font-size: 18px;" id="resultPrizeName"></div>
                    <div style="margin-top: 8px; font-size: 14px;" id="resultTime"></div>
                </div>
            </div>
        </div>
        
        <!-- ä¸­å¥–åå• -->
        <div class="winner-board">
            <div class="board-header">
                <div class="board-title">ğŸ† å®æ—¶ä¸­å¥–åå•</div>
                <div class="button-group">
                    <button class="view-history-btn" id="viewHistoryBtn">ğŸ“œ æˆ‘çš„ä¸­å¥–è®°å½•</button>
                    <button class="reset-btn" id="resetBtn">ğŸ”„ é‡ç½®æ¬¡æ•°</button>
                </div>
            </div>
            
            <div class="winner-scroll">
                <ul class="winner-list" id="winnerList"></ul>
            </div>
        </div>
    </div>
    
    <!-- æˆ‘çš„ä¸­å¥–è®°å½•å¼¹çª— -->
    <div class="modal" id="historyModal">
        <div class="modal-content">
            <button class="close-modal" id="closeModal">Ã—</button>
            <h2 style="color: #FFD700; margin-bottom: 15px;">ğŸ“‹ æˆ‘çš„ä¸­å¥–è®°å½•</h2>
            <div id="historyContent" style="max-height: 60vh; overflow-y: auto;"></div>
        </div>
    </div>
    
    <!-- ç­”é¢˜å¼¹çª— -->
    <div class="modal" id="quizModal">
        <div class="modal-content">
            <div id="quizContent">
                <!-- ç­”é¢˜å†…å®¹å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>
    
    <!-- éŸ³ä¹å…ƒç´  -->
    <audio id="backgroundMusic" loop>
        <source src="papa.mp3" type="audio/mpeg">
        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘å…ƒç´ 
    </audio>
    
    <audio id="dingSound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-bell-notification-933.mp3" type="audio/mpeg">
    </audio>

    <script>
        // æ›´æ–°å¥–å“æ•°æ®ï¼ˆæŒ‰ä½ çš„è¦æ±‚ï¼‰
        const prizes = [
            { 
                id: 1, 
                name: "iPhone 16 Pro", 
                level: "ä¸€ç­‰å¥–",
                image: "https://images.unsplash.com/photo-1511707171634-5f897ff02aa9?w=300&h=300&fit=crop", 
                probability: 3 
            },
            { 
                id: 2, 
                name: "iPad Air", 
                level: "äºŒç­‰å¥–",
                image: "https://images.unsplash.com/photo-1544244015-0df4b3ffc6b0?w=300&h=300&fit=crop", 
                probability: 5 
            },
            { 
                id: 3, 
                name: "æ™ºèƒ½æ‰‹è¡¨", 
                level: "ä¸‰ç­‰å¥–",
                image: "https://images.unsplash.com/photo-1523275335684-37898b6baf30?w=300&h=300&fit=crop", 
                probability: 8 
            },
            { 
                id: 4, 
                name: "AirPods", 
                level: "å››ç­‰å¥–",
                image: "https://images.unsplash.com/photo-1572569511254-d8f925fe2cbb?w=300&h=300&fit=crop", 
                probability: 12 
            },
            { 
                id: 5, 
                name: "å¸†å¸ƒåŒ…", 
                level: "äº”ç­‰å¥–",
                image: "https://images.unsplash.com/photo-1566150902887-9679ecc1557a?w=300&h=300&fit=crop", 
                probability: 15 
            },
            { 
                id: 6, 
                name: "å¥¶èŒ¶", 
                level: "å…­ç­‰å¥–",
                image: "https://images.unsplash.com/photo-1561121338-8c3260a09e66?w=300&h=300&fit=crop", 
                probability: 20 
            },
            { 
                id: 7, 
                name: "çŸ¿æ³‰æ°´", 
                level: "ä¸ƒç­‰å¥–",
                image: "https://images.unsplash.com/photo-1523362628745-0c100150b504?w=300&h=300&fit=crop", 
                probability: 22 
            },
            { 
                id: 8, 
                name: "è°¢è°¢å‚ä¸", 
                level: "å‚ä¸å¥–",
                image: "https://images.unsplash.com/photo-1530103862676-de8c9debad1d?w=300&h=300&fit=crop", 
                probability: 15 
            }
        ];

        // ä¹å®«æ ¼å¸ƒå±€é¡ºåºï¼ˆ3x3ç½‘æ ¼ï¼Œä¸­é—´æ˜¯æŠ½å¥–æŒ‰é’®ï¼‰
        const gridPositions = [
            { row: 1, col: 1 }, // å·¦ä¸Š
            { row: 1, col: 2 }, // ä¸Šä¸­
            { row: 1, col: 3 }, // å³ä¸Š
            { row: 2, col: 1 }, // å·¦ä¸­
            { row: 2, col: 2 }, // ä¸­å¿ƒï¼ˆæŠ½å¥–æŒ‰é’®ï¼‰
            { row: 2, col: 3 }, // å³ä¸­
            { row: 3, col: 1 }, // å·¦ä¸‹
            { row: 3, col: 2 }, // ä¸‹ä¸­
            { row: 3, col: 3 }  // å³ä¸‹
        ];

        // ç½‘ååº“
        const nicknames = [
            "æ˜Ÿæ²³æ»šçƒ«", "äººé—´ç†æƒ³", "æœˆè‰²çœŸç¾", "æ¸…é£å¾æ¥", "äº‘å·äº‘èˆ’", "èŠ±å¼€å¯Œè´µ", "æ˜Ÿè¾°å¤§æµ·",
            "æ—¶å…‰é™å¥½", "æ˜¥æš–èŠ±å¼€", "ç§‹æ°´ä¼Šäºº", "åŒ—åŸä»¥åŒ—", "å—é£æœªèµ·", "è¥¿æ¥¼æœˆä¸‹", "ä¸œç¯±æŠŠé…’",
            "å‰‘æŒ‡è‹ç©¹", "ç¬‘å‚²æ±Ÿæ¹–", "å¢¨æŸ“å€¾åŸ", "æµ…ç¬‘å®‰ç„¶", "ç¹åè½å¹•", "ç´ å¹´é”¦æ—¶", "æµ®ç”Ÿè‹¥æ¢¦"
        ];

        // è„‘ç­‹æ€¥è½¬å¼¯é¢˜åº“ï¼ˆç®€ç‰ˆï¼‰
        const quizQuestions = [
            { question: "ä»€ä¹ˆä¸œè¥¿è¶Šæ´—è¶Šè„ï¼Ÿ", options: ["è¡£æœ", "æ°´", "ç¢—", "æ‰‹"], answer: 1 },
            { question: "ä»€ä¹ˆé—¨æ°¸è¿œå…³ä¸ä¸Šï¼Ÿ", options: ["çƒé—¨", "å†°ç®±é—¨", "å¿ƒé—¨", "è½¦é—¨"], answer: 0 },
            { question: "ä»€ä¹ˆä¸œè¥¿å¤©æ°”è¶Šçƒ­ï¼Œå®ƒçˆ¬å¾—è¶Šé«˜ï¼Ÿ", options: ["æ¸©åº¦è®¡", "èš‚èš", "å¤ªé˜³", "æ°”çƒ"], answer: 0 },
            { question: "ä»€ä¹ˆè›‹æ‰“ä¸çƒ‚ï¼Œç…®ä¸ç†Ÿï¼Œæ›´ä¸èƒ½åƒï¼Ÿ", options: ["é¸¡è›‹", "ç¬¨è›‹", "é¸­è›‹", "é›¶è›‹"], answer: 1 },
            { question: "ç”¨æ¤°å­å’Œè¥¿ç“œæ‰“å¤´å“ªä¸€ä¸ªæ¯”è¾ƒç—›ï¼Ÿ", options: ["æ¤°å­", "è¥¿ç“œ", "å¤´", "æ‰‹"], answer: 2 }
        ];

        // çŠ¶æ€å˜é‡
        let isDrawing = false;
        let remainingChances = 3;
        let isBgMusicOn = true;
        let isSoundEffectOn = true;
        let winners = [];
        let myHistory = [];
        let currentUser = nicknames[Math.floor(Math.random() * nicknames.length)];
        
        // ç­”é¢˜çŠ¶æ€
        let quizState = {
            currentQuestion: 0,
            score: 0,
            selectedOption: null,
            quizCompleted: false,
            questions: []
        };

        // DOMå…ƒç´ 
        const elements = {
            nineGrid: document.getElementById('nineGrid'),
            startLotteryBtn: null, // ç¨ååŠ¨æ€è·å–
            chanceCount: document.getElementById('chanceCount'),
            resultText: document.getElementById('resultText'),
            resultPrize: document.getElementById('resultPrize'),
            resultImage: document.getElementById('resultImage'),
            resultPrizeName: document.getElementById('resultPrizeName'),
            resultTime: document.getElementById('resultTime'),
            winnerList: document.getElementById('winnerList'),
            bgMusicBtn: document.getElementById('bgMusicBtn'),
            soundEffectBtn: document.getElementById('soundEffectBtn'),
            bgMusicStatus: document.getElementById('bgMusicStatus'),
            soundEffectStatus: document.getElementById('soundEffectStatus'),
            viewHistoryBtn: document.getElementById('viewHistoryBtn'),
            resetBtn: document.getElementById('resetBtn'),
            historyModal: document.getElementById('historyModal'),
            quizModal: document.getElementById('quizModal'),
            closeModal: document.getElementById('closeModal'),
            historyContent: document.getElementById('historyContent'),
            quizContent: document.getElementById('quizContent'),
            bgMusic: document.getElementById('backgroundMusic'),
            dingSound: document.getElementById('dingSound')
        };

        // åˆå§‹åŒ–ä¹å®«æ ¼å¸ƒå±€
        function initializeNineGrid() {
            elements.nineGrid.innerHTML = '';
            
            // æ‰“ä¹±å¥–å“é¡ºåºï¼ˆé™¤äº†è°¢è°¢å‚ä¸æ”¾åœ¨æœ€åä¸€ä¸ªä½ç½®ï¼‰
            const shuffledPrizes = [...prizes.filter(p => p.name !== "è°¢è°¢å‚ä¸")];
            shuffledPrizes.sort(() => Math.random() - 0.5);
            
            // ç¡®ä¿è°¢è°¢å‚ä¸åœ¨æœ€åä¸€ä¸ª
            const thanksPrize = prizes.find(p => p.name === "è°¢è°¢å‚ä¸");
            shuffledPrizes.push(thanksPrize);
            
            // åˆ›å»º8ä¸ªå¥–å“æ ¼å­å’Œ1ä¸ªæŠ½å¥–æŒ‰é’®æ ¼å­
            for (let i = 0; i < 9; i++) {
                const gridItem = document.createElement('div');
                const position = gridPositions[i];
                
                gridItem.style.gridColumn = position.col;
                gridItem.style.gridRow = position.row;
                
                if (i === 4) { // ç¬¬5ä¸ªä½ç½®æ˜¯ä¸­å¿ƒæŠ½å¥–æŒ‰é’®
                    gridItem.className = 'grid-item center-btn';
                    gridItem.id = 'startLotteryBtn';
                    gridItem.innerHTML = `
                        <div style="font-size: 32px;">ğŸ</div>
                        <div class="start-btn-text">å¼€å§‹æŠ½å¥–</div>
                        <div class="chance-count">å‰©ä½™: <span id="chanceCountDisplay">${remainingChances}</span> æ¬¡</div>
                    `;
                } else {
                    const prizeIndex = i < 4 ? i : i - 1; // è·³è¿‡ä¸­å¿ƒä½ç½®
                    const prize = shuffledPrizes[prizeIndex];
                    gridItem.className = 'grid-item prize';
                    gridItem.dataset.id = prize.id;
                    gridItem.dataset.index = prizeIndex;
                    
                    gridItem.innerHTML = `
                        <div class="prize-level">${prize.level}</div>
                        <img src="${prize.image}" alt="${prize.name}" class="prize-image">
                        <div class="prize-name">${prize.name}</div>
                    `;
                }
                
                elements.nineGrid.appendChild(gridItem);
            }
            
            // è·å–æŠ½å¥–æŒ‰é’®å…ƒç´ 
            elements.startLotteryBtn = document.getElementById('startLotteryBtn');
            elements.chanceCountDisplay = document.getElementById('chanceCountDisplay');
        }

        // æ’­æ”¾éŸ³æ•ˆ
        function playDingSound() {
            if (!isSoundEffectOn) return;
            
            try {
                elements.dingSound.currentTime = 0;
                elements.dingSound.play().catch(e => console.log("éŸ³æ•ˆæ’­æ”¾å¤±è´¥"));
            } catch (e) {
                console.log("éŸ³æ•ˆé”™è¯¯:", e);
            }
        }

        // å¼€å§‹æŠ½å¥–ï¼ˆä¹å®«æ ¼é«˜äº®é¡ºåºï¼‰
        function startLottery() {
            if (isDrawing) return;
            if (remainingChances <= 0) {
                elements.resultText.textContent = "æŠ½å¥–æ¬¡æ•°å·²ç”¨å®Œï¼ç‚¹å‡»é‡ç½®æ¬¡æ•°è·å–æ›´å¤šæœºä¼š";
                return;
            }
            
            isDrawing = true;
            elements.startLotteryBtn.disabled = true;
            elements.startLotteryBtn.innerHTML = `
                <div style="font-size: 32px;" class="spinning">ğŸ¯</div>
                <div class="start-btn-text">æŠ½å¥–ä¸­...</div>
            `;
            
            // ç¡®å®šç›®æ ‡å¥–å“
            const totalProbability = prizes.reduce((sum, prize) => sum + prize.probability, 0);
            let randomNum = Math.random() * totalProbability;
            let selectedPrize = prizes[0];
            let targetIndex = 0;
            
            for (let i = 0; i < prizes.length; i++) {
                if (randomNum < prizes[i].probability) {
                    selectedPrize = prizes[i];
                    targetIndex = i;
                    break;
                }
                randomNum -= prizes[i].probability;
            }
            
            console.log(`ç›®æ ‡å¥–å“: ${selectedPrize.name}, ç´¢å¼•: ${targetIndex}`);
            
            // æ¸…é™¤æ‰€æœ‰é«˜äº®
            document.querySelectorAll('.grid-item.prize').forEach(item => {
                item.classList.remove('active');
            });
            
            // ä¹å®«æ ¼æ—‹è½¬åŠ¨ç”»ï¼ˆæŒ‰é¡ºåºé«˜äº®ï¼‰
            const prizeItems = document.querySelectorAll('.grid-item.prize');
            let currentIndex = 0;
            let spinCount = 0;
            const totalSpins = 24; // è½¬3åœˆï¼ˆ8ä¸ªæ ¼å­Ã—3åœˆï¼‰
            const baseSpeed = 100;
            
            function spin() {
                playDingSound();
                
                // æ¸…é™¤ä¸Šä¸€ä¸ªé«˜äº®
                const prevIndex = (currentIndex - 1 + prizeItems.length) % prizeItems.length;
                if (prevIndex >= 0) {
                    prizeItems[prevIndex].classList.remove('active');
                }
                
                // é«˜äº®å½“å‰
                prizeItems[currentIndex].classList.add('active');
                
                currentIndex = (currentIndex + 1) % prizeItems.length;
                spinCount++;
                
                // åŠ¨æ€é€Ÿåº¦æ§åˆ¶ï¼šå…ˆå¿«åæ…¢
                let currentSpeed;
                if (spinCount < totalSpins * 0.6) {
                    currentSpeed = baseSpeed;
                } else if (spinCount < totalSpins * 0.8) {
                    currentSpeed = baseSpeed + (spinCount - totalSpins * 0.6) * 15;
                } else {
                    currentSpeed = baseSpeed + 120 + (spinCount - totalSpins * 0.8) * 40;
                }
                
                if (spinCount < totalSpins) {
                    setTimeout(spin, currentSpeed);
                } else {
                    // æ‰¾åˆ°ç›®æ ‡å¥–å“å¯¹åº”çš„æ ¼å­
                    let targetGridIndex = -1;
                    prizeItems.forEach((item, index) => {
                        if (parseInt(item.dataset.id) === selectedPrize.id) {
                            targetGridIndex = index;
                        }
                    });
                    
                    if (targetGridIndex !== -1) {
                        // è°ƒæ•´åˆ°ç›®æ ‡ä½ç½®
                        let movesToTarget = (targetGridIndex - currentIndex + prizeItems.length) % prizeItems.length;
                        if (movesToTarget === 0) movesToTarget = prizeItems.length;
                        
                        let finalMoves = 0;
                        
                        function finalAdjustment() {
                            playDingSound();
                            
                            const prev = prizeItems[(currentIndex - 1 + prizeItems.length) % prizeItems.length];
                            if (prev) prev.classList.remove('active');
                            
                            prizeItems[currentIndex].classList.add('active');
                            
                            currentIndex = (currentIndex + 1) % prizeItems.length;
                            finalMoves++;
                            
                            if (finalMoves < movesToTarget) {
                                setTimeout(finalAdjustment, 200 + finalMoves * 100);
                            } else {
                                setTimeout(() => {
                                    finalizeResult(selectedPrize);
                                }, 500);
                            }
                        }
                        
                        setTimeout(finalAdjustment, 300);
                    } else {
                        finalizeResult(selectedPrize);
                    }
                }
            }
            
            spin();
        }

        // æœ€ç»ˆç¡®å®šç»“æœ
        function finalizeResult(selectedPrize) {
            // æ¸…é™¤æ‰€æœ‰é«˜äº®
            document.querySelectorAll('.grid-item.prize').forEach(item => {
                item.classList.remove('active');
            });
            
            // é«˜äº®æœ€ç»ˆå¥–å“
            const winningItems = document.querySelectorAll(`.grid-item.prize[data-id="${selectedPrize.id}"]`);
            winningItems.forEach(item => {
                item.classList.add('active');
            });
            
            // æ˜¾ç¤ºç»“æœ
            const now = new Date();
            const fullTime = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')} ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}:${now.getSeconds().toString().padStart(2,'0')}`;
            const shortTime = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
            
            if (selectedPrize.name === "è°¢è°¢å‚ä¸") {
                elements.resultText.textContent = `ğŸ˜¢ ${selectedPrize.name}ï¼Œä¸‹æ¬¡ç»§ç»­åŠ æ²¹ï¼`;
            } else {
                elements.resultText.textContent = `ğŸ‰ æ­å–œï¼æŠ½ä¸­ ${selectedPrize.name} ğŸ‰`;
            }
            
            elements.resultImage.src = selectedPrize.image;
            elements.resultPrizeName.textContent = selectedPrize.name;
            elements.resultTime.textContent = `æ—¶é—´: ${fullTime}`;
            elements.resultPrize.style.display = 'flex';
            
            // æ›´æ–°æŠ½å¥–æ¬¡æ•°
            remainingChances--;
            elements.chanceCountDisplay.textContent = remainingChances;
            
            // æ·»åŠ åˆ°æˆ‘çš„ä¸­å¥–è®°å½•
            myHistory.unshift({
                name: currentUser,
                prize: selectedPrize.name,
                level: selectedPrize.level,
                time: fullTime,
                image: selectedPrize.image
            });
            
            // ç”Ÿæˆéšæœºç½‘åæ·»åŠ åˆ°å…¬å…±ä¸­å¥–åå•
            const randomNickname = nicknames[Math.floor(Math.random() * nicknames.length)];
            addToWinners(randomNickname, selectedPrize.name, shortTime);
            
            // é‡ç½®æŒ‰é’®çŠ¶æ€
            isDrawing = false;
            elements.startLotteryBtn.disabled = false;
            elements.startLotteryBtn.innerHTML = `
                <div style="font-size: 32px;">ğŸ</div>
                <div class="start-btn-text">å¼€å§‹æŠ½å¥–</div>
                <div class="chance-count">å‰©ä½™: <span id="chanceCountDisplay">${remainingChances}</span> æ¬¡</div>
            `;
            elements.startLotteryBtn.classList.remove('spinning');
            
            // æ›´æ–°æ˜¾ç¤º
            updateHistoryDisplay();
        }

        // æ·»åŠ åˆ°ä¸­å¥–åå•
        function addToWinners(name, prize, time) {
            winners.unshift({ name, prize, time });
            if (winners.length > 50) winners = winners.slice(0, 50);
            updateWinnerList();
        }

        // æ›´æ–°ä¸­å¥–åå•æ˜¾ç¤º
        function updateWinnerList() {
            elements.winnerList.innerHTML = '';
            const shuffledWinners = [...winners].sort(() => Math.random() - 0.5);
            
            shuffledWinners.slice(0, 10).forEach(winner => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span>ğŸ‘¤ ${winner.name}</span>
                    <span style="color: #FFD700; margin: 0 10px;">${winner.prize}</span>
                    <span style="font-size: 12px; opacity: 0.8;">${winner.time}</span>
                `;
                elements.winnerList.appendChild(li);
            });
            
            setTimeout(updateWinnerList, 5000);
        }

        // æ›´æ–°æˆ‘çš„ä¸­å¥–è®°å½•æ˜¾ç¤º
        function updateHistoryDisplay() {
            elements.historyContent.innerHTML = '';
            
            if (myHistory.length === 0) {
                elements.historyContent.innerHTML = '<p style="text-align: center; padding: 40px; color: #999;">æš‚æ— ä¸­å¥–è®°å½•ï¼Œå¿«å»æŠ½å¥–å§ï¼</p>';
                return;
            }
            
            myHistory.forEach(record => {
                const recordDiv = document.createElement('div');
                recordDiv.style.cssText = 'display: flex; align-items: center; padding: 12px; margin-bottom: 10px; background: rgba(255,255,255,0.05); border-radius: 10px; border-left: 4px solid #FFD700;';
                
                recordDiv.innerHTML = `
                    <img src="${record.image}" style="width: 50px; height: 50px; border-radius: 8px; margin-right: 15px; border: 2px solid #FFD700;">
                    <div style="flex: 1;">
                        <div style="color: #FFD700; font-weight: bold;">${record.name}</div>
                        <div style="margin-top: 5px;">
                            <span style="background: rgba(255,215,0,0.2); padding: 2px 8px; border-radius: 10px; font-size: 12px;">${record.level}</span>
                            <span style="margin-left: 10px;">${record.prize}</span>
                        </div>
                    </div>
                    <div style="font-size: 12px; opacity: 0.8;">${record.time}</div>
                `;
                
                elements.historyContent.appendChild(recordDiv);
            });
        }

        // åˆ‡æ¢èƒŒæ™¯éŸ³ä¹
        function toggleBgMusic() {
            isBgMusicOn = !isBgMusicOn;
            elements.bgMusicStatus.textContent = isBgMusicOn ? 'å¼€å¯' : 'å…³é—­';
            
            if (isBgMusicOn) {
                elements.bgMusic.play().catch(e => console.log("éŸ³ä¹æ’­æ”¾å¤±è´¥"));
                elements.bgMusicBtn.classList.add('active');
            } else {
                elements.bgMusic.pause();
                elements.bgMusicBtn.classList.remove('active');
            }
        }

        // åˆ‡æ¢éŸ³æ•ˆ
        function toggleSoundEffect() {
            isSoundEffectOn = !isSoundEffectOn;
            elements.soundEffectStatus.textContent = isSoundEffectOn ? 'å¼€å¯' : 'å…³é—­';
            elements.soundEffectBtn.classList.toggle('active', isSoundEffectOn);
        }

        // å¼€å§‹ç­”é¢˜é‡ç½®æµç¨‹
        function startQuiz() {
            // é‡ç½®ç­”é¢˜çŠ¶æ€
            quizState = {
                currentQuestion: 0,
                score: 0,
                selectedOption: null,
                quizCompleted: false,
                questions: []
            };
            
            // ä»é¢˜åº“ä¸­éšæœºé€‰æ‹©5é“é¢˜
            const shuffledQuestions = [...quizQuestions].sort(() => Math.random() - 0.5);
            quizState.questions = shuffledQuestions.slice(0, 5);
            
            // æ˜¾ç¤ºç­”é¢˜å¼¹çª—
            showQuizQuestion();
            elements.quizModal.style.display = 'flex';
        }

        // æ˜¾ç¤ºå½“å‰é¢˜ç›®
        function showQuizQuestion() {
            const currentQ = quizState.questions[quizState.currentQuestion];
            const progress = ((quizState.currentQuestion) / 5) * 100;
            
            elements.quizContent.innerHTML = `
                <div style="text-align: center;">
                    <h2 style="color: #FFD700; margin-bottom: 25px; display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <span>ğŸ§ </span> è„‘ç­‹æ€¥è½¬å¼¯æŒ‘æˆ˜
                    </h2>
                    
                    <div style="width: 100%; height: 10px; background: rgba(255, 255, 255, 0.1); border-radius: 5px; margin: 20px 0; overflow: hidden;">
                        <div style="height: 100%; background: linear-gradient(90deg, #FF416C, #FF4B2B); border-radius: 5px; transition: width 0.5s; width: ${progress}%"></div>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; margin-bottom: 25px; font-size: 16px; color: #FFD700; padding: 0 10px;">
                        <div>é¢˜ç›®: ${quizState.currentQuestion + 1}/5</div>
                        <div>å¾—åˆ†: ${quizState.score}/3</div>
                    </div>
                    
                    <div style="background: rgba(255, 255, 255, 0.05); border-radius: 15px; padding: 25px; margin-bottom: 30px; border: 1px solid rgba(255, 215, 0, 0.3); text-align: left;">
                        <div style="font-size: 18px; line-height: 1.6; margin-bottom: 25px; color: #fff; min-height: 60px;">${currentQ.question}</div>
                        <div style="display: grid; gap: 12px;">
                            ${currentQ.options.map((option, index) => `
                                <button class="option-btn" onclick="selectOption(${index})" style="background: rgba(255, 255, 255, 0.08); border: 1px solid rgba(255, 215, 0, 0.3); color: white; padding: 15px 20px; border-radius: 12px; cursor: pointer; font-size: 16px; text-align: left;">
                                    ${String.fromCharCode(65 + index)}. ${option}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div style="display: flex; justify-content: center; margin-top: 30px;">
                        <button onclick="submitAnswer()" style="background: linear-gradient(90deg, #FF416C, #FF4B2B); border: none; color: white; padding: 12px 30px; border-radius: 50px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s; width: 100%;">
                            ${quizState.currentQuestion < 4 ? 'æäº¤ç­”æ¡ˆ' : 'æäº¤æœ€åä¸€é¢˜'}
                        </button>
                    </div>
                </div>
            `;
        }

        // é€‰æ‹©é€‰é¡¹
        window.selectOption = function(index) {
            quizState.selectedOption = index;
            
            // æ›´æ–°æŒ‰é’®æ ·å¼
            document.querySelectorAll('.option-btn').forEach((btn, i) => {
                btn.style.background = i === index ? 'rgba(255, 215, 0, 0.25)' : 'rgba(255, 255, 255, 0.08)';
                btn.style.borderColor = i === index ? '#FFD700' : 'rgba(255, 215, 0, 0.3)';
            });
        }

        // æäº¤ç­”æ¡ˆ
        window.submitAnswer = function() {
            if (quizState.selectedOption === null) return;
            
            const currentQ = quizState.questions[quizState.currentQuestion];
            const isCorrect = quizState.selectedOption === currentQ.answer;
            
            // æ›´æ–°åˆ†æ•°
            if (isCorrect) {
                quizState.score++;
                playDingSound();
            }
            
            // æ˜¾ç¤ºç»“æœ
            quizState.currentQuestion++;
            quizState.selectedOption = null;
            
            if (quizState.currentQuestion < quizState.questions.length) {
                showQuizQuestion();
            } else {
                showQuizResult();
            }
        }

        // æ˜¾ç¤ºç­”é¢˜ç»“æœ
        function showQuizResult() {
            const success = quizState.score >= 3;
            
            elements.quizContent.innerHTML = `
                <div style="text-align: center; padding: 20px 0;">
                    <div style="font-size: 80px; margin-bottom: 20px;">${success ? 'ğŸ‰' : 'ğŸ˜¢'}</div>
                    <div style="font-size: 24px; margin-bottom: 30px; color: #FFD700;">
                        ${success ? 'æ­å–œä½ ï¼æŒ‘æˆ˜æˆåŠŸï¼' : 'å¾ˆé—æ†¾ï¼ŒæŒ‘æˆ˜å¤±è´¥ï¼'}
                    </div>
                    
                    <div style="background: rgba(255, 255, 255, 0.05); border-radius: 15px; padding: 25px; margin: 20px 0; border: 1px solid rgba(255, 215, 0, 0.2);">
                        <div>ç­”é¢˜å®Œæˆ</div>
                        <div style="font-size: 48px; font-weight: bold; color: #FFD700; margin: 10px 0;">${quizState.score}/5 åˆ†</div>
                        <div style="margin-top: 15px; color: #ccc;">
                            ${success ? 'âœ… ä½ å·²æˆåŠŸç­”å¯¹3é¢˜ä»¥ä¸Š' : 'âŒ éœ€è¦ç­”å¯¹3é¢˜æ‰èƒ½é‡ç½®æ¬¡æ•°'}
                        </div>
                    </div>
                    
                    ${success ? `
                        <div style="font-size: 20px; color: #4CAF50; margin-top: 25px; padding: 15px; background: rgba(76, 175, 80, 0.1); border-radius: 12px; border: 1px solid #4CAF50;">
                            ğŸ è·å¾—å¥–åŠ±ï¼šæŠ½å¥–æ¬¡æ•°é‡ç½®ä¸º3æ¬¡ï¼
                        </div>
                    ` : ''}
                    
                    <div style="display: flex; gap: 15px; margin-top: 30px;">
                        <button onclick="${success ? 'resetChances()' : 'closeQuizModal()'}" style="background: rgba(255, 215, 0, 0.2); border: 1px solid #FFD700; color: white; padding: 12px 30px; border-radius: 50px; cursor: pointer; font-size: 16px; font-weight: bold; flex: 1;">
                            ${success ? 'é‡ç½®æŠ½å¥–æ¬¡æ•°' : 'å…³é—­'}
                        </button>
                        ${!success ? `
                            <button onclick="retryQuiz()" style="background: linear-gradient(90deg, #FF416C, #FF4B2B); border: none; color: white; padding: 12px 30px; border-radius: 50px; cursor: pointer; font-size: 16px; font-weight: bold; flex: 1;">
                                é‡æ–°æŒ‘æˆ˜
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // é‡æ–°æŒ‘æˆ˜
        window.retryQuiz = function() {
            startQuiz();
        }

        // é‡ç½®æŠ½å¥–æ¬¡æ•°
        window.resetChances = function() {
            remainingChances = 3;
            elements.chanceCountDisplay.textContent = remainingChances;
            elements.quizModal.style.display = 'none';
            elements.resultText.textContent = "ğŸŠ æŠ½å¥–æ¬¡æ•°å·²é‡ç½®ä¸º3æ¬¡ï¼ç¥ä½ å¥½è¿ï¼";
            
            playDingSound();
        }

        // å…³é—­ç­”é¢˜å¼¹çª—
        window.closeQuizModal = function() {
            elements.quizModal.style.display = 'none';
        }

        // ç”Ÿæˆåˆå§‹æ•°æ®
        function generateInitialData() {
            const now = new Date();
            
            for (let i = 0; i < 15; i++) {
                const randomNickname = nicknames[Math.floor(Math.random() * nicknames.length)];
                const randomPrize = prizes[Math.floor(Math.random() * prizes.length)];
                const timeOffset = i * 10 * 60 * 1000;
                const recordTime = new Date(now.getTime() - timeOffset);
                
                const shortTime = `${recordTime.getHours().toString().padStart(2,'0')}:${recordTime.getMinutes().toString().padStart(2,'0')}`;
                
                winners.push({
                    name: randomNickname,
                    prize: randomPrize.name,
                    time: shortTime
                });
            }
            
            currentUser = nicknames[Math.floor(Math.random() * nicknames.length)];
        }

        // åˆå§‹åŒ–
        function init() {
            initializeNineGrid();
            generateInitialData();
            updateWinnerList();
            updateHistoryDisplay();
            
            // è‡ªåŠ¨æ’­æ”¾èƒŒæ™¯éŸ³ä¹
            setTimeout(() => {
                try {
                    elements.bgMusic.volume = 0.5;
                    elements.bgMusic.play().then(() => {
                        isBgMusicOn = true;
                        updateMusicButton();
                    }).catch(e => {
                        isBgMusicOn = false;
                        updateMusicButton();
                    });
                } catch (e) {
                    console.log("éŸ³ä¹æ’­æ”¾é”™è¯¯:", e);
                }
            }, 1000);
        }

        // æ›´æ–°éŸ³ä¹æŒ‰é’®
        function updateMusicButton() {
            elements.bgMusicStatus.textContent = isBgMusicOn ? 'å¼€å¯' : 'å…³é—­';
            elements.bgMusicBtn.classList.toggle('active', isBgMusicOn);
        }

        // äº‹ä»¶ç›‘å¬
        document.addEventListener('DOMContentLoaded', () => {
            // æŠ½å¥–æŒ‰é’®äº‹ä»¶åœ¨initializeNineGridåç»‘å®š
            setTimeout(() => {
                if (elements.startLotteryBtn) {
                    elements.startLotteryBtn.addEventListener('click', startLottery);
                }
            }, 100);
        });

        elements.bgMusicBtn.addEventListener('click', toggleBgMusic);
        elements.soundEffectBtn.addEventListener('click', toggleSoundEffect);
        elements.viewHistoryBtn.addEventListener('click', () => {
            elements.historyModal.style.display = 'flex';
        });
        elements.resetBtn.addEventListener('click', startQuiz);
        elements.closeModal.addEventListener('click', () => {
            elements.historyModal.style.display = 'none';
        });
        
        elements.historyModal.addEventListener('click', (e) => {
            if (e.target === elements.historyModal) {
                elements.historyModal.style.display = 'none';
            }
        });
        
        elements.quizModal.addEventListener('click', (e) => {
            if (e.target === elements.quizModal) {
                elements.quizModal.style.display = 'none';
            }
        });

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', init);
    </script>
</body>
</html>

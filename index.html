<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹¸è¿å¤§æŠ½å¥– - ä¹å®«æ ¼</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            min-height: 100vh;
            color: white;
            padding: 15px;
        }
        
        .container {
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
            text-align: center;
        }
        
        .header {
            margin-bottom: 20px;
            padding: 20px;
        }
        
        h1 {
            font-size: clamp(24px, 5vw, 36px);
            margin-bottom: 10px;
            background: linear-gradient(to right, #FFD700, #FFA500);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle {
            font-size: clamp(14px, 3vw, 18px);
            opacity: 0.8;
            margin-bottom: 20px;
        }
        
        .music-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .control-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 215, 0, 0.5);
            color: white;
            padding: 8px 20px;
            border-radius: 50px;
            cursor: pointer;
            font-size: clamp(14px, 3vw, 16px);
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .control-btn:hover {
            background: rgba(255, 215, 0, 0.2);
            transform: translateY(-2px);
        }
        
        .control-btn.active {
            background: rgba(255, 215, 0, 0.3);
            border-color: #FFD700;
        }
        
        /* ä¹å®«æ ¼å¸ƒå±€ */
        .nine-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 10px;
            width: min(95vw, 600px);
            height: min(95vw, 600px);
            margin: 0 auto 30px;
            position: relative;
        }
        
        .grid-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        /* å¥–å“æ ¼å­ */
        .grid-item.prize {
            cursor: default;
        }
        
        .grid-item.prize.active {
            border-color: #FFD700;
            box-shadow: 0 0 25px rgba(255, 215, 0, 0.5);
            transform: scale(1.05);
            z-index: 2;
        }
        
        .prize-image {
            width: 70px;
            height: 70px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 8px;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .prize-emoji {
            font-size: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
            width: 70px;
            height: 70px;
        }
        
        .prize-name {
            font-size: 14px;
            text-align: center;
            font-weight: bold;
            color: #FFD700;
        }
        
        .prize-level {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 215, 0, 0.8);
            color: #000;
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: bold;
        }
        
        /* ä¸­å¿ƒæŠ½å¥–æŒ‰é’®æ ¼å­ */
        .grid-item.center-btn {
            background: linear-gradient(145deg, #FF416C, #FF4B2B);
            border: none;
            cursor: pointer;
            grid-column: 2;
            grid-row: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            z-index: 10;
        }
        
        .grid-item.center-btn:hover {
            background: linear-gradient(145deg, #FF4B2B, #FF416C);
            box-shadow: 0 0 30px rgba(255, 65, 108, 0.7);
        }
        
        .grid-item.center-btn:active {
            transform: scale(0.98);
        }
        
        .grid-item.center-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            background: linear-gradient(145deg, #666, #888);
        }
        
        .start-btn-text {
            font-size: clamp(16px, 3vw, 20px);
            font-weight: bold;
            color: white;
        }
        
        .chance-count {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
        }
        
        .result-display {
            margin: 20px auto;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            max-width: 600px;
            border: 2px solid rgba(255, 215, 0, 0.2);
        }
        
        .result-text {
            font-size: clamp(18px, 4vw, 24px);
            margin-bottom: 15px;
            min-height: 40px;
        }
        
        .result-prize {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        
        @media (min-width: 768px) {
            .result-prize {
                flex-direction: row;
                justify-content: center;
            }
        }
        
        .result-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 12px;
            border: 2px solid #FFD700;
        }
        
        .result-emoji {
            font-size: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100px;
            height: 100px;
            background: rgba(255, 215, 0, 0.1);
            border-radius: 50%;
            border: 2px solid #FFD700;
        }
        
        .winner-board {
            margin-top: 30px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .board-header {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 215, 0, 0.3);
        }
        
        @media (min-width: 576px) {
            .board-header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }
        
        .board-title {
            font-size: clamp(18px, 4vw, 20px);
            color: #FFD700;
        }
        
        .view-history-btn, .reset-btn {
            background: rgba(255, 215, 0, 0.2);
            border: 1px solid #FFD700;
            color: white;
            padding: 8px 20px;
            border-radius: 50px;
            cursor: pointer;
            font-size: clamp(14px, 3vw, 16px);
            transition: all 0.3s;
        }
        
        .view-history-btn:hover, .reset-btn:hover {
            background: rgba(255, 215, 0, 0.3);
            transform: translateY(-2px);
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .winner-scroll {
            height: 200px;
            overflow: hidden;
            position: relative;
        }
        
        .winner-list {
            list-style: none;
        }
        
        .winner-list li {
            padding: 10px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* å¼¹çª—æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            width: 100%;
            max-width: 500px;
            border-radius: 20px;
            padding: 30px;
            position: relative;
            border: 2px solid #FFD700;
            box-shadow: 0 0 40px rgba(255, 215, 0, 0.4);
        }
        
        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 215, 0, 0.2);
            border: 1px solid #FFD700;
            color: white;
            font-size: 20px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* æ—‹è½¬åŠ¨ç”» */
        @keyframes rotateIndicator {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .spinning {
            animation: rotateIndicator 1s linear infinite;
        }
        
        /* å“åº”å¼ä¼˜åŒ– */
        @media (max-width: 768px) {
            .nine-grid {
                width: min(95vw, 500px);
                height: min(95vw, 500px);
            }
            
            .prize-emoji {
                width: 50px;
                height: 50px;
                font-size: 30px;
            }
            
            .prize-name {
                font-size: 12px;
            }
            
            .result-emoji {
                width: 70px;
                height: 70px;
                font-size: 40px;
            }
        }
        
        @media (max-width: 480px) {
            .nine-grid {
                width: min(95vw, 400px);
                height: min(95vw, 400px);
                gap: 5px;
            }
            
            .prize-emoji {
                width: 40px;
                height: 40px;
                font-size: 24px;
            }
            
            .prize-name {
                font-size: 10px;
            }
            
            .grid-item {
                padding: 5px;
            }
            
            .result-emoji {
                width: 60px;
                height: 60px;
                font-size: 32px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ° å¹¸è¿å¤§æŠ½å¥– ğŸ°</h1>
            <p class="subtitle">ç‚¹å‡»ä¸­å¿ƒæŒ‰é’®å¼€å§‹æŠ½å¥–ï¼Œä¹å®«æ ¼å¸ƒå±€ï¼Œç¥ä½ å¥½è¿ï¼</p>
            
            <div class="music-controls">
                <button class="control-btn" id="bgMusicBtn">
                    <span>ğŸµ</span> èƒŒæ™¯éŸ³ä¹: <span id="bgMusicStatus">å¼€å¯</span>
                </button>
                <button class="control-btn" id="soundEffectBtn">
                    <span>ğŸ”Š</span> æ—‹è½¬éŸ³æ•ˆ: <span id="soundEffectStatus">å¼€å¯</span>
                </button>
            </div>
        </div>
        
        <!-- ä¹å®«æ ¼å¸ƒå±€ -->
        <div class="nine-grid" id="nineGrid">
            <!-- å¥–å“æ ¼å­é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
        
        <!-- ç»“æœå±•ç¤º -->
        <div class="result-display">
            <div class="result-text" id="resultText">ç­‰å¾…æŠ½å¥–å¼€å§‹...</div>
            <div class="result-prize" id="resultPrize" style="display: none;">
                <div class="result-emoji" id="resultEmoji"></div>
                <div>
                    <div style="color: #FFD700; font-size: 20px; font-weight: bold;" id="resultPrizeName"></div>
                    <div style="color: #FFD700; font-size: 14px; margin-top: 5px;" id="resultPrizeLevel"></div>
                    <div style="margin-top: 10px; font-size: 14px; color: #aaa;" id="resultTime"></div>
                </div>
            </div>
        </div>
        
        <!-- ä¸­å¥–åå• -->
        <div class="winner-board">
            <div class="board-header">
                <div class="board-title">ğŸ† å®æ—¶ä¸­å¥–åå•</div>
                <div class="button-group">
                    <button class="view-history-btn" id="viewHistoryBtn">ğŸ“œ æˆ‘çš„ä¸­å¥–è®°å½•</button>
                    <button class="reset-btn" id="resetBtn">ğŸ”„ é‡ç½®æ¬¡æ•°</button>
                </div>
            </div>
            
            <div class="winner-scroll">
                <ul class="winner-list" id="winnerList"></ul>
            </div>
        </div>
    </div>
    
    <!-- æˆ‘çš„ä¸­å¥–è®°å½•å¼¹çª— -->
    <div class="modal" id="historyModal">
        <div class="modal-content">
            <button class="close-modal" id="closeModal">Ã—</button>
            <h2 style="color: #FFD700; margin-bottom: 15px;">ğŸ“‹ æˆ‘çš„ä¸­å¥–è®°å½•</h2>
            <div id="historyContent" style="max-height: 60vh; overflow-y: auto;"></div>
        </div>
    </div>
    
    <!-- ç­”é¢˜å¼¹çª— -->
    <div class="modal" id="quizModal">
        <div class="modal-content">
            <div id="quizContent">
                <!-- ç­”é¢˜å†…å®¹å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>
    
    <!-- éŸ³ä¹å…ƒç´  -->
    <audio id="backgroundMusic" loop>
        <source src="https://assets.mixkit.co/music/preview/mixkit-game-show-suspense-waiting-667.mp3" type="audio/mpeg">
        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘å…ƒç´ 
    </audio>
    
    <audio id="dingSound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3" type="audio/mpeg">
    </audio>

    <script>
        // ğŸ¯ ç³»ç»Ÿé…ç½®æ–‡ä»¶
        const SYSTEM_CONFIG = {
            // ===== ç­”é¢˜ç³»ç»Ÿé…ç½® =====
            QUIZ: {
                TOTAL_QUESTIONS: 5,          // æ¯æ¬¡ç­”é¢˜é¢˜ç›®æ•°é‡
                REQUIRED_SCORE: 3,           // éœ€è¦ç­”å¯¹çš„é¢˜ç›®æ•°
                TIME_PER_QUESTION: 0,        // æ¯é¢˜ç­”é¢˜æ—¶é—´(ç§’)ï¼Œ0è¡¨ç¤ºæ— é™åˆ¶
                MAX_RETRY_TIMES: 3           // æœ€å¤§é‡è¯•æ¬¡æ•°
            },
            
            // ===== æŠ½å¥–ç³»ç»Ÿé…ç½® =====
            LOTTERY: {
                INITIAL_CHANCES: 3,          // åˆå§‹æŠ½å¥–æ¬¡æ•°
                MAX_CHANCES: 10,             // æœ€å¤§æŠ½å¥–æ¬¡æ•°ä¸Šé™
                RESET_COOLDOWN: 60           // é‡ç½®å†·å´æ—¶é—´(åˆ†é’Ÿ)
            },
            
            // ===== åŠ¨ç”»æ•ˆæœé…ç½® =====
            ANIMATION: {
                SPIN_FAST_SPEED: 80,         // å¿«é€Ÿæ—‹è½¬é—´éš”(ms)
                SPIN_SLOW_SPEED: 200,        // æ…¢é€Ÿæ—‹è½¬é—´éš”(ms)
                TOTAL_SPINS: 20,             // æ€»æ—‹è½¬æ¬¡æ•°
                FINAL_SPINS: 3               // æœ€åå‡é€Ÿæ—‹è½¬æ¬¡æ•°
            },
            
            // ===== ç•Œé¢æ˜¾ç¤ºé…ç½® =====
            DISPLAY: {
                WINNERS_COUNT: 10,           // æ˜¾ç¤ºçš„ä¸­å¥–äººæ•°
                HISTORY_COUNT: 10,           // æ˜¾ç¤ºçš„å†å²è®°å½•æ•°
                AUTO_REFRESH: 5000,          // è‡ªåŠ¨åˆ·æ–°é—´éš”(ms)
                EMOJI_SIZE: "40px"           // Emojiæ˜¾ç¤ºå¤§å°
            },
            
            // ===== å£°éŸ³é…ç½® =====
            SOUND: {
                BACKGROUND_VOLUME: 0.3,      // èƒŒæ™¯éŸ³ä¹éŸ³é‡(0-1)
                EFFECT_VOLUME: 0.7,          // éŸ³æ•ˆéŸ³é‡(0-1)
                ENABLE_BY_DEFAULT: true      // é»˜è®¤å¼€å¯éŸ³æ•ˆ
            }
        };

        // ğŸ¯ å¥–å“æ•°æ® - ä½¿ç”¨EMOJIä»£æ›¿å›¾ç‰‡
        const prizes = [
            { 
                id: 1, 
                name: "iPhone 16 Pro", 
                level: "ä¸€ç­‰å¥–",
                emoji: "ğŸ“±", // ä½¿ç”¨emoji
                color: "#FFD700", // é‡‘è‰²
                probability: 0.1 
            },
            { 
                id: 2, 
                name: "iPad Air", 
                level: "äºŒç­‰å¥–",
                emoji: "ğŸ’»", // ä½¿ç”¨emoji
                color: "#C0C0C0", // é“¶è‰²
                probability: 0.2 
            },
            { 
                id: 3, 
                name: "æ™ºèƒ½æ‰‹è¡¨", 
                level: "ä¸‰ç­‰å¥–",
                emoji: "âŒš", // ä½¿ç”¨emoji
                color: "#CD7F32", // å¤é“œè‰²
                probability: 0.3
            },
            { 
                id: 4, 
                name: "AirPods", 
                level: "å››ç­‰å¥–",
                emoji: "ğŸ§", // ä½¿ç”¨emoji
                color: "#4CAF50", // ç»¿è‰²
                probability: 0.4 
            },
            { 
                id: 5, 
                name: "èƒŒåŒ…", 
                level: "äº”ç­‰å¥–",
                emoji: "ğŸ’", // ä½¿ç”¨emoji
                color: "#2196F3", // è“è‰²
                probability:  3
            },
            { 
                id: 6, 
                name: "å¥¶èŒ¶", 
                level: "å…­ç­‰å¥–",
                emoji: "ğŸ§‹", // ä½¿ç”¨emoji
                color: "#E91E63", // ç²‰è‰²
                probability:  6
            },
            { 
                id: 7, 
                name: "çŸ¿æ³‰æ°´", 
                level: "ä¸ƒç­‰å¥–",
                emoji: "ğŸ’§", // ä½¿ç”¨emoji
                color: "#00BCD4", // é’è‰²
                probability:  10
            },
            { 
                id: 8, 
                name: "è°¢è°¢å‚ä¸", 
                level: "å‚ä¸å¥–",
                emoji: "ğŸ", // ä½¿ç”¨emoji
                color: "#9E9E9E", // ç°è‰²
                probability: 70 
            }
        ];

        // ä¹å®«æ ¼å¸ƒå±€é¡ºåº
        const gridPositions = [
            { row: 1, col: 1 }, // å·¦ä¸Š
            { row: 1, col: 2 }, // ä¸Šä¸­
            { row: 1, col: 3 }, // å³ä¸Š
            { row: 2, col: 1 }, // å·¦ä¸­
            { row: 2, col: 2 }, // ä¸­å¿ƒï¼ˆæŠ½å¥–æŒ‰é’®ï¼‰
            { row: 2, col: 3 }, // å³ä¸­
            { row: 3, col: 1 }, // å·¦ä¸‹
            { row: 3, col: 2 }, // ä¸‹ä¸­
            { row: 3, col: 3 }  // å³ä¸‹
        ];

        // ç½‘ååº“
        const nicknames = [
            "æ˜Ÿæ²³æ»šçƒ«", "äººé—´ç†æƒ³", "æœˆè‰²çœŸç¾", "æ¸…é£å¾æ¥", "äº‘å·äº‘èˆ’", "èŠ±å¼€å¯Œè´µ", "æ˜Ÿè¾°å¤§æµ·",
            "æ—¶å…‰é™å¥½", "æ˜¥æš–èŠ±å¼€", "ç§‹æ°´ä¼Šäºº", "åŒ—åŸä»¥åŒ—", "å—é£æœªèµ·", "è¥¿æ¥¼æœˆä¸‹", "ä¸œç¯±æŠŠé…’",
            "å‰‘æŒ‡è‹ç©¹", "ç¬‘å‚²æ±Ÿæ¹–", "å¢¨æŸ“å€¾åŸ", "æµ…ç¬‘å®‰ç„¶", "ç¹åè½å¹•", "ç´ å¹´é”¦æ—¶", "æµ®ç”Ÿè‹¥æ¢¦",
            "åŠåŸçƒŸæ²™", "ä¸€ä¸–ç¹å", "ä¸‰ç”Ÿä¸‰ä¸–", "å››æµ·å…«è’", "äº”æ¹–å››æµ·", "å…­é“è½®å›", "ä¸ƒæ˜Ÿé«˜ç…§",
            "å…«ä»™è¿‡æµ·", "ä¹ä¹å½’ä¸€", "åå…¨åç¾", "ç™¾äº‹å¯ä¹", "åƒä¸åƒå¯»", "ä¸‡é‡ŒæŒ‘ä¸€", "äº¿è¡¨äººæ‰",
            "ç‹è€…å½’æ¥", "è£è€€ç‹è€…", "åƒé¸¡å¤§ç¥", "ç”µç«å°‘å¥³", "æ¸¸æˆäººç”Ÿ", "äºŒæ¬¡å…ƒå›", "åŠ¨æ¼«å®…ç”·",
            "æ–‡è‰ºé’å¹´", "æ‘‡æ»šå·¨æ˜Ÿ", "æµè¡Œæ•™ä¸»", "æ—¶å°šè¾¾äºº", "ç¾é£Ÿå®¶", "æ—…è¡Œå®¶", "æ‘„å½±å¸ˆ",
            "ç¨‹åºå‘˜", "è®¾è®¡å¸ˆ", "äº§å“ç»ç†", "è¿è¥å¤§ä½¬", "å¸‚åœºä¸“å®¶", "é”€å”®å† å†›", "è´¢åŠ¡è‡ªç”±",
            "æŠ•èµ„å¤©æ‰", "åˆ›ä¸šå…ˆé”‹", "å­¦éœ¸å›", "å­¦æ¸£é€†è¢­", "è€ƒè¯•å¤§ç¥", "è®ºæ–‡æ€æ‰‹", "å®ä¹ è¾¾äºº",
            "èŒåœºç²¾è‹±", "é€€ä¼‘ç”Ÿæ´»", "å…»ç”Ÿä¸“å®¶", "å¥èº«è¾¾äºº", "ç‘œä¼½å¤§å¸ˆ", "è·‘æ­¥å† å†›", "æ¸¸æ³³å¥å°†",
            "ç¯®çƒé«˜æ‰‹", "è¶³çƒæ˜æ˜Ÿ", "ç”µç«é€‰æ‰‹", "ä¸»æ’­å¤§ä½¬", "ç½‘çº¢è¾¾äºº", "æµé‡æ˜æ˜Ÿ", "ç²‰ä¸åƒä¸‡",
            "ç‚¹èµè¿‡ä¸‡", "è¯„è®ºç ´åƒ", "è½¬å‘ç™¾ä¸‡", "çƒ­æœç¬¬ä¸€", "çƒ­é—¨è¯é¢˜", "æµé‡æ‹…å½“", "æœˆå…‰æ—",
            "æœé˜³ç¾¤ä¼—", "å¤œçŒ«å­", "æ—©èµ·é¸Ÿ", "æŠ€æœ¯å®…", "æ–‡è‰ºèŒƒ", "é…·ç›–", "èŒæ–°", "å¤§ä½¬",
            "è‚å¸", "æ¬§çš‡", "éé…‹", "æ°ªé‡‘", "ç™½å«–", "ä½›ç³»", "ç¡¬æ ¸", "èººå¹³", "å†…å·", "æ‘†çƒ‚"
        ];

        // è„‘ç­‹æ€¥è½¬å¼¯é¢˜åº“
        const quizQuestions = [
            { question: "ä»€ä¹ˆä¸œè¥¿è¶Šæ´—è¶Šè„ï¼Ÿ", options: ["è¡£æœ", "æ°´", "ç¢—", "æ‰‹"], answer: 1 },
            { question: "ä»€ä¹ˆé—¨æ°¸è¿œå…³ä¸ä¸Šï¼Ÿ", options: ["çƒé—¨", "å†°ç®±é—¨", "å¿ƒé—¨", "è½¦é—¨"], answer: 0 },
            { question: "ä»€ä¹ˆä¸œè¥¿å¤©æ°”è¶Šçƒ­ï¼Œå®ƒçˆ¬å¾—è¶Šé«˜ï¼Ÿ", options: ["æ¸©åº¦è®¡", "èš‚èš", "å¤ªé˜³", "æ°”çƒ"], answer: 0 },
            { question: "ä»€ä¹ˆè›‹æ‰“ä¸çƒ‚ï¼Œç…®ä¸ç†Ÿï¼Œæ›´ä¸èƒ½åƒï¼Ÿ", options: ["é¸¡è›‹", "ç¬¨è›‹", "é¸­è›‹", "é›¶è›‹"], answer: 1 },
            { question: "ç”¨æ¤°å­å’Œè¥¿ç“œæ‰“å¤´å“ªä¸€ä¸ªæ¯”è¾ƒç—›ï¼Ÿ", options: ["æ¤°å­", "è¥¿ç“œ", "å¤´", "æ‰‹"], answer: 2 },
            { question: "æ—©æ™¨é†’æ¥ï¼Œæ¯ä¸ªäººéƒ½ä¼šå»åšçš„ç¬¬ä¸€ä»¶äº‹æ˜¯ä»€ä¹ˆï¼Ÿ", options: ["ççœ¼", "åˆ·ç‰™", "ä¸Šå•æ‰€", "ç©¿è¡£æœ"], answer: 0 },
            { question: "ä»€ä¹ˆä¸œè¥¿äººä»¬åœ¨ä¸åœåœ°åƒå®ƒï¼Œå´æ°¸è¿œåƒä¸é¥±ï¼Ÿ", options: ["ç©ºæ°”", "ç±³é¥­", "é›¶é£Ÿ", "å£æ°´"], answer: 0 },
            { question: "ä»€ä¹ˆè½¦å­å¯¸æ­¥éš¾è¡Œï¼Ÿ", options: ["é£è½¦", "è‡ªè¡Œè½¦", "æ±½è½¦", "é©¬è½¦"], answer: 0 },
            { question: "å“ªä¸€ä¸ªæœˆæœ‰äºŒåå…«å¤©ï¼Ÿ", options: ["äºŒæœˆ", "æ¯ä¸ªæœˆ", "åäºŒæœˆ", "å…­æœˆ"], answer: 1 },
            { question: "ä»€ä¹ˆè‹±æ–‡å­—æ¯æœ€å¤šäººå–œæ¬¢å¬ï¼Ÿ", options: ["A", "C", "D", "CD"], answer: 3 },
            { question: "ä¸€åªå‡¶çŒ›çš„é¥¿çŒ«ï¼Œçœ‹åˆ°è€é¼ ï¼Œä¸ºä½•æ‹”è…¿å°±è·‘ï¼Ÿ", options: ["å»è¿½è€é¼ ", "å»æ‰è€é¼ ", "è·‘å»æ‹ç”µå½±", "è·‘å»æŠ“é±¼"], answer: 3 },
            { question: "å°çº¢ä¸å¦ˆå¦ˆéƒ½åœ¨åŒä¸€ä¸ªç­é‡Œä¸Šè¯¾ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆï¼Ÿ", options: ["å¦ˆå¦ˆæ˜¯è€å¸ˆ", "å°çº¢æ˜¯è€å¸ˆ", "å¦ˆå¦ˆæ˜¯å­¦ç”Ÿ", "å¦ˆå¦ˆåœ¨å¬è¯¾"], answer: 0 },
            { question: "ä»€ä¹ˆæ°´æ°¸è¿œç”¨ä¸å®Œï¼Ÿ", options: ["è‡ªæ¥æ°´", "æ³ªæ°´", "å£æ°´", "æ³ªæ°´"], answer: 2 },
            { question: "ä»€ä¹ˆä¸œè¥¿æœ‰äº”ä¸ªå¤´ï¼Œä½†äººä¸è§‰å¾—å®ƒæ€ªï¼Ÿ", options: ["æ‰‹", "è„š", "æ‰‹å¥—", "æ€ªç‰©"], answer: 1 },
            { question: "ä»€ä¹ˆé…’ä¸èƒ½å–ï¼Ÿ", options: ["ç™½é…’", "å•¤é…’", "ç¢˜é…’", "çº¢é…’"], answer: 2 },
            { question: "ä»€ä¹ˆä¸œè¥¿æ™šä¸Šæ‰ç”Ÿå‡ºå°¾å·´å‘¢ï¼Ÿ", options: ["æ˜Ÿæ˜Ÿ", "æœˆäº®", "æµæ˜Ÿ", "è¤ç«è™«"], answer: 2 },
            { question: "ä¹¦åº—é‡Œä¹°ä¸åˆ°ä»€ä¹ˆä¹¦ï¼Ÿ", options: ["æ•™ç§‘ä¹¦", "å°è¯´", "é—ä¹¦", "æ¼«ç”»"], answer: 2 },
            { question: "ä»€ä¹ˆè·¯æœ€çª„ï¼Ÿ", options: ["å±±è·¯", "æ°´è·¯", "å†¤å®¶è·¯çª„", "å…¬è·¯"], answer: 2 },
            { question: "ä»€ä¹ˆäººå§‹ç»ˆä¸æ•¢æ´—æ¾¡ï¼Ÿ", options: ["æ³¥äºº", "ç›²äºº", "è€äºº", "å°å­©"], answer: 0 },
            { question: "ä»€ä¹ˆç‰›ä¸ä¼šåƒè‰ï¼Ÿ", options: ["èœ—ç‰›", "å¥¶ç‰›", "é»„ç‰›", "æ°´ç‰›"], answer: 0 },
            { question: "ä»€ä¹ˆä¸œè¥¿å˜´é‡Œæ²¡æœ‰èˆŒå¤´ï¼Ÿ", options: ["èŒ¶å£¶å˜´", "æ°´å£¶", "èŒ¶æ¯", "ä¿æ¸©æ¯"], answer: 0 },
            { question: "ä»€ä¹ˆäººç”Ÿç—…ä»æ¥ä¸çœ‹åŒ»ç”Ÿï¼Ÿ", options: ["ç›²äºº", "åŒ»ç”Ÿ", "æœºå™¨äºº", "æ­»äºº"], answer: 1 },
            { question: "æ—¶é’Ÿä»€ä¹ˆæ—¶å€™ä¸ä¼šèµ°ï¼Ÿ", options: ["æ²¡ç”µæ—¶", "åäº†æ—¶", "æ—¶é’Ÿæœ¬æ¥å°±ä¸ä¼šèµ°", "è£…çš„æ—¶å€™"], answer: 2 },
            { question: "ä»€ä¹ˆå­—å…¨ä¸–ç•Œé€šç”¨ï¼Ÿ", options: ["è‹±æ–‡", "ä¸­æ–‡", "é˜¿æ‹‰ä¼¯æ•°å­—", "æ•°å­¦ç¬¦å·"], answer: 2 },
            { question: "ä¸ºä»€ä¹ˆå°ç‹ä»åˆä¸€åˆ°åˆä¸‰å°±å­¦äº†ä¸€ç¯‡è¯¾æ–‡ï¼Ÿ", options: ["ä»–å¾ˆæ‡’", "è€å¸ˆåªæ•™ä¸€ç¯‡", "è¯¾æ–‡å¾ˆé•¿", "åˆä¸€åˆ°åˆä¸‰åªæœ‰ä¸‰å¤©"], answer: 3 },
            { question: "ä¸€ä¸ªäººç©ºè‚šå­æœ€å¤šèƒ½åƒå‡ ä¸ªé¸¡è›‹ï¼Ÿ", options: ["ä¸€ä¸ª", "ä¸¤ä¸ª", "ä¸‰ä¸ª", "ä¸€ä¸ªï¼ˆå› ä¸ºåƒäº†ä¸€ä¸ªåå°±ä¸æ˜¯ç©ºè‚šå­äº†ï¼‰"], answer: 3 },
            { question: "å½“å“¥ä¼¦å¸ƒä¸€åªè„šè¿ˆä¸Šæ–°å¤§é™†åï¼Œç´§æ¥ç€åšä»€ä¹ˆï¼Ÿ", options: ["è¿ˆä¸Šå¦ä¸€åªè„š", "æ’ä¸Šæ——å¸œ", "é«˜å‘¼èƒœåˆ©", "å¼€å§‹æ¢é™©"], answer: 0 },
            { question: "ä»€ä¹ˆä¸œè¥¿æ¯”ä¹Œé¸¦æ›´è®¨åŒï¼Ÿ", options: ["ä¹Œé¸¦å˜´", "ä¹Œé¸¦çš„åŒç±»", "ä¹Œé¸¦çš„æ•Œäºº", "ä¹Œé¸¦æœ¬èº«"], answer: 0 },
            { question: "ä¸–ç•Œä¸Šé™¤äº†ç«è½¦å•¥è½¦æœ€é•¿ï¼Ÿ", options: ["å µè½¦", "ç«è½¦", "æ±½è½¦", "è´§è½¦"], answer: 0 },
            { question: "ä»€ä¹ˆä¸œè¥¿ä¸èƒ½åƒï¼Ÿ", options: ["ä¸œè¥¿æ–¹å‘", "é£Ÿç‰©", "æ°´", "ç©ºæ°”"], answer: 0 },
            { question: "ä¸ºä»€ä¹ˆå¤§é›ç§‹å¤©è¦é£åˆ°å—æ–¹å»ï¼Ÿ", options: ["å› ä¸ºå—æ–¹æš–å’Œ", "å› ä¸ºèµ°å¾—å¤ªæ…¢äº†", "å› ä¸ºé£æ¯”èµ°å¿«", "å› ä¸ºæ˜¯å€™é¸Ÿ"], answer: 1 },
            { question: "ä»€ä¹ˆå¸½ä¸èƒ½æˆ´ï¼Ÿ", options: ["èºä¸å¸½", "è‰å¸½", "æ£’çƒå¸½", "ç¤¼å¸½"], answer: 0 },
            { question: "ä¸ºä»€ä¹ˆå¤§éƒ¨åˆ†ä½›æ•™å¾’éƒ½åœ¨åŒ—åŠçƒï¼Ÿ", options: ["å—æ— é˜¿å¼¥é™€ä½›", "æ°”å€™åŸå› ", "å†å²åŸå› ", "åœ°ç†åŸå› "], answer: 0 },
            { question: "ä»€ä¹ˆä¸œè¥¿æœ‰å¤´æ— è„šï¼Ÿ", options: ["é’‰å­", "è›‡", "èš¯èš“", "é“…ç¬”"], answer: 0 },
            { question: "é»‘äººä¸ºä»€ä¹ˆå–œæ¬¢åƒç™½è‰²å·§å…‹åŠ›ï¼Ÿ", options: ["æ€•å’¬åˆ°è‡ªå·±çš„æ‰‹", "ç™½è‰²å¥½åƒ", "é»‘è‰²å¤ªè‹¦", "è¥å…»å¥½"], answer: 0 },
            { question: "è°å¤©å¤©å»çœ‹ç—…ï¼Ÿ", options: ["åŒ»ç”Ÿ", "ç—…äºº", "æŠ¤å£«", "åŒ»é™¢é™¢é•¿"], answer: 0 },
            { question: "ä»€ä¹ˆç…§ç‰‡çœ‹ä¸å‡ºç…§çš„æ˜¯è°ï¼Ÿ", options: ["Xå…‰ç…§ç‰‡", "æ¨¡ç³Šç…§ç‰‡", "èƒŒå½±ç…§ç‰‡", "é»‘ç™½ç…§ç‰‡"], answer: 0 },
            { question: "ä»€ä¹ˆå¸ƒå‰ªä¸æ–­ï¼Ÿ", options: ["ç€‘å¸ƒ", "æ£‰å¸ƒ", "éº»å¸ƒ", "çº±å¸ƒ"], answer: 0 },
            { question: "ä»€ä¹ˆä¸œè¥¿åšçš„äººçŸ¥é“ï¼Œä¹°çš„äººçŸ¥é“ï¼Œå–çš„äººçŸ¥é“ï¼Œç”¨çš„äººå´ä¸çŸ¥é“ï¼Ÿ", options: ["æ£ºæ", "è¡£æœ", "é£Ÿç‰©", "æˆ¿å­"], answer: 0 },
            { question: "ä¸€ä¸ªäººä»é£æœºä¸Šæ‰ä¸‹æ¥ï¼Œä¸ºä»€ä¹ˆæ²¡æ‘”æ­»å‘¢ï¼Ÿ", options: ["é£æœºåœåœ¨åœ°ä¸Š", "æœ‰é™è½ä¼", "æ‰åœ¨æµ·é‡Œ", "æ‰åœ¨æ£‰èŠ±ä¸Š"], answer: 0 },
            { question: "ä»€ä¹ˆäººå¿ƒè‚ æœ€ä¸å¥½ï¼Ÿ", options: ["å¾—èƒƒè‚ ç‚çš„äºº", "å¿ƒè„ç—…çš„äºº", "æ²¡è‰¯å¿ƒçš„äºº", "åŒ»ç”Ÿ"], answer: 1 },
            { question: "å“ªé¡¹æ¯”èµ›æ˜¯å¾€åè·‘çš„ï¼Ÿ", options: ["æ‹”æ²³", "è·‘æ­¥", "æ¸¸æ³³", "è·³è¿œ"], answer: 0 },
            { question: "ä»€ä¹ˆå®˜ä¸ä»…ä¸é¢†å·¥èµ„ï¼Œè¿˜è¦è‡ªæè…°åŒ…ï¼Ÿ", options: ["æ–°éƒå®˜", "å†›å®˜", "æ³•å®˜", "è€ƒå®˜"], answer: 0 },
            { question: "ä»€ä¹ˆäººç”Ÿæ¥å°±ç§°ç‹ï¼Ÿ", options: ["å›½ç‹", "ç‹å­", "çš‡å¸", "å§“ç‹çš„äºº"], answer: 3 },
            { question: "ä»€ä¹ˆèŠ±æ²¡æœ‰æ ¹ï¼Ÿ", options: ["çƒŸèŠ±", "é›ªèŠ±", "æµªèŠ±", "ç«èŠ±"], answer: 0 },
            { question: "ä»€ä¹ˆä¸œè¥¿æœ€å®¹æ˜“æ»¡è¶³ï¼Ÿ", options: ["è¢œå­", "é‹å­", "å¸½å­", "æ‰‹å¥—"], answer: 0 },
            { question: "ä»€ä¹ˆé¸¡æ²¡æœ‰ç¿…è†€ï¼Ÿ", options: ["ç”°é¸¡", "å±±é¸¡", "é‡é¸¡", "çƒ§é¸¡"], answer: 0 },
            { question: "ä»€ä¹ˆèˆ¹ä»æ¥ä¸ä¸‹æ°´ï¼Ÿ", options: ["å®‡å®™é£èˆ¹", "èˆªç©ºæ¯èˆ°", "å¸†èˆ¹", "ç ´èˆ¹"], answer: 0 },
            { question: "ä»€ä¹ˆäººä¸€å¹´ä¸­åªå·¥ä½œä¸€å¤©ï¼Ÿ", options: ["åœ£è¯è€äºº", "æ¼”å‘˜", "ç¨‹åºå‘˜", "è€å¸ˆ"], answer: 0 },
            { question: "ä»€ä¹ˆäº‹å¤©ä¸çŸ¥é“åœ°çŸ¥é“ï¼Œä½ ä¸çŸ¥é“æˆ‘çŸ¥é“ï¼Ÿ", options: ["é‹å­ç ´äº†", "ç§˜å¯†", "å¤©æ°”", "ç­”æ¡ˆ"], answer: 0 }
        ];

        // ğŸ¯ çŠ¶æ€å˜é‡
        let isDrawing = false;
        let remainingChances = SYSTEM_CONFIG.LOTTERY.INITIAL_CHANCES; // ä½¿ç”¨é…ç½®
        let isBgMusicOn = SYSTEM_CONFIG.SOUND.ENABLE_BY_DEFAULT;
        let isSoundEffectOn = SYSTEM_CONFIG.SOUND.ENABLE_BY_DEFAULT;
        let winners = [];
        let myHistory = [];
        let currentUser = nicknames[Math.floor(Math.random() * nicknames.length)];
        
        // ç­”é¢˜çŠ¶æ€
        let quizState = {
            currentQuestion: 0,
            score: 0,
            selectedOption: null,
            questions: []
        };

        // ğŸ¯ DOMå…ƒç´ 
        let elements = {};

        // åˆå§‹åŒ–DOMå…ƒç´ 
        function initElements() {
            elements = {
                nineGrid: document.getElementById('nineGrid'),
                resultText: document.getElementById('resultText'),
                resultPrize: document.getElementById('resultPrize'),
                resultEmoji: document.getElementById('resultEmoji'),
                resultPrizeName: document.getElementById('resultPrizeName'),
                resultPrizeLevel: document.getElementById('resultPrizeLevel'),
                resultTime: document.getElementById('resultTime'),
                winnerList: document.getElementById('winnerList'),
                bgMusicBtn: document.getElementById('bgMusicBtn'),
                soundEffectBtn: document.getElementById('soundEffectBtn'),
                bgMusicStatus: document.getElementById('bgMusicStatus'),
                soundEffectStatus: document.getElementById('soundEffectStatus'),
                viewHistoryBtn: document.getElementById('viewHistoryBtn'),
                resetBtn: document.getElementById('resetBtn'),
                historyModal: document.getElementById('historyModal'),
                quizModal: document.getElementById('quizModal'),
                closeModal: document.getElementById('closeModal'),
                historyContent: document.getElementById('historyContent'),
                quizContent: document.getElementById('quizContent'),
                bgMusic: document.getElementById('backgroundMusic'),
                dingSound: document.getElementById('dingSound')
            };
        }

        // ğŸ¯ åˆå§‹åŒ–ä¹å®«æ ¼å¸ƒå±€
        function initializeNineGrid() {
            elements.nineGrid.innerHTML = '';
            
            // æ‰“ä¹±å¥–å“é¡ºåº
            const shuffledPrizes = [...prizes.filter(p => p.name !== "è°¢è°¢å‚ä¸")];
            shuffledPrizes.sort(() => Math.random() - 0.5);
            
            // ç¡®ä¿è°¢è°¢å‚ä¸åœ¨æœ€åä¸€ä¸ª
            const thanksPrize = prizes.find(p => p.name === "è°¢è°¢å‚ä¸");
            shuffledPrizes.push(thanksPrize);
            
            // åˆ›å»ºæ ¼å­
            for (let i = 0; i < 9; i++) {
                const gridItem = document.createElement('div');
                const position = gridPositions[i];
                
                gridItem.style.gridColumn = position.col;
                gridItem.style.gridRow = position.row;
                
                if (i === 4) { // ä¸­å¿ƒæŠ½å¥–æŒ‰é’®
                    gridItem.className = 'grid-item center-btn';
                    gridItem.id = 'startLotteryBtn';
                    gridItem.innerHTML = `
                        <div style="font-size: 32px;">ğŸ</div>
                        <div class="start-btn-text">å¼€å§‹æŠ½å¥–</div>
                        <div class="chance-count">å‰©ä½™: <span id="chanceCountDisplay">${remainingChances}</span> æ¬¡</div>
                    `;
                    
                    gridItem.addEventListener('click', startLottery);
                } else {
                    const prizeIndex = i < 4 ? i : i - 1;
                    const prize = shuffledPrizes[prizeIndex];
                    gridItem.className = 'grid-item prize';
                    gridItem.dataset.id = prize.id;
                    gridItem.dataset.index = prizeIndex;
                    
                    // ğŸ¯ ä½¿ç”¨emoji
                    gridItem.innerHTML = `
                        <div class="prize-level">${prize.level}</div>
                        <div class="prize-emoji">${prize.emoji}</div>
                        <div class="prize-name">${prize.name}</div>
                    `;
                }
                
                elements.nineGrid.appendChild(gridItem);
            }
            
            // ä¿å­˜chanceCountDisplayå¼•ç”¨
            elements.chanceCountDisplay = document.getElementById('chanceCountDisplay');
        }

        // ğŸ¯ æ’­æ”¾éŸ³æ•ˆ
        function playDingSound() {
            if (!isSoundEffectOn) return;
            
            try {
                elements.dingSound.currentTime = 0;
                elements.dingSound.volume = SYSTEM_CONFIG.SOUND.EFFECT_VOLUME;
                elements.dingSound.play().catch(e => console.log("éŸ³æ•ˆæ’­æ”¾å¤±è´¥"));
            } catch (e) {
                console.log("éŸ³æ•ˆé”™è¯¯:", e);
            }
        }

        // ğŸ¯ å¼€å§‹æŠ½å¥–
        function startLottery() {
            if (isDrawing) {
                console.log("æ­£åœ¨æŠ½å¥–ä¸­ï¼Œè¯·ç­‰å¾…...");
                return;
            }
            
            if (remainingChances <= 0) {
                elements.resultText.textContent = "æŠ½å¥–æ¬¡æ•°å·²ç”¨å®Œï¼ç‚¹å‡»é‡ç½®æ¬¡æ•°è·å–æ›´å¤šæœºä¼š";
                return;
            }
            
            console.log("å¼€å§‹æŠ½å¥–...");
            isDrawing = true;
            
            // ç«‹å³ç¦ç”¨æŒ‰é’®
            const startBtn = document.getElementById('startLotteryBtn');
            if (startBtn) {
                startBtn.disabled = true;
                startBtn.innerHTML = `
                    <div style="font-size: 32px;" class="spinning">ğŸ¯</div>
                    <div class="start-btn-text">æŠ½å¥–ä¸­...</div>
                `;
            }
            
            // ç«‹å³æ˜¾ç¤ºçŠ¶æ€
            elements.resultText.textContent = "ğŸ° æŠ½å¥–è¿›è¡Œä¸­...";
            
            // éšè—ä¸Šä¸€æ¬¡çš„ç»“æœ
            elements.resultPrize.style.display = 'none';
            
            // ğŸ¯ å¼‚æ­¥ç¡®å®šç›®æ ‡å¥–å“
            setTimeout(() => {
                const totalProbability = prizes.reduce((sum, prize) => sum + prize.probability, 0);
                let randomNum = Math.random() * totalProbability;
                let selectedPrize = prizes[0];
                
                for (const prize of prizes) {
                    if (randomNum < prize.probability) {
                        selectedPrize = prize;
                        break;
                    }
                    randomNum -= prize.probability;
                }
                
                console.log(`ä¸­å¥–å¥–å“: ${selectedPrize.name}`);
                
                // å¼€å§‹æ—‹è½¬åŠ¨ç”»
                startRotationAnimation(selectedPrize);
            }, 50);
        }

        // ğŸ¯ æ—‹è½¬åŠ¨ç”»ï¼ˆä½¿ç”¨é…ç½®ï¼‰
        function startRotationAnimation(selectedPrize) {
            const prizeItems = document.querySelectorAll('.grid-item.prize');
            let currentIndex = 0;
            let spinCount = 0;
            const totalSpins = SYSTEM_CONFIG.ANIMATION.TOTAL_SPINS;
            
            // æ¸…é™¤é«˜äº®
            prizeItems.forEach(item => item.classList.remove('active'));
            
            function spin() {
                playDingSound();
                
                // æ¸…é™¤ä¸Šä¸€ä¸ª
                if (spinCount > 0) {
                    const prevIndex = (currentIndex - 1 + prizeItems.length) % prizeItems.length;
                    prizeItems[prevIndex].classList.remove('active');
                }
                
                // é«˜äº®å½“å‰
                prizeItems[currentIndex].classList.add('active');
                
                currentIndex = (currentIndex + 1) % prizeItems.length;
                spinCount++;
                
                if (spinCount < totalSpins) {
                    // åŠ¨æ€é€Ÿåº¦ï¼ˆä½¿ç”¨é…ç½®ï¼‰
                    let speed;
                    if (spinCount < 15) {
                        speed = SYSTEM_CONFIG.ANIMATION.SPIN_FAST_SPEED;
                    } else if (spinCount < 17) {
                        speed = SYSTEM_CONFIG.ANIMATION.SPIN_SLOW_SPEED;
                    } else {
                        speed = SYSTEM_CONFIG.ANIMATION.SPIN_SLOW_SPEED + (spinCount - 17) * 50;
                    }
                    setTimeout(spin, speed);
                } else {
                    // æ‰¾åˆ°ç›®æ ‡æ ¼å­
                    let targetGridIndex = -1;
                    prizeItems.forEach((item, index) => {
                        if (parseInt(item.dataset.id) === selectedPrize.id) {
                            targetGridIndex = index;
                        }
                    });
                    
                    // ç²¾å‡†åœæ­¢
                    if (targetGridIndex !== -1) {
                        let movesToTarget = (targetGridIndex - currentIndex + prizeItems.length) % prizeItems.length;
                        if (movesToTarget === 0) movesToTarget = prizeItems.length;
                        
                        let finalMoves = 0;
                        
                        function finalAdjustment() {
                            playDingSound();
                            
                            const prev = prizeItems[(currentIndex - 1 + prizeItems.length) % prizeItems.length];
                            if (prev) prev.classList.remove('active');
                            
                            prizeItems[currentIndex].classList.add('active');
                            currentIndex = (currentIndex + 1) % prizeItems.length;
                            finalMoves++;
                            
                            if (finalMoves < movesToTarget) {
                                setTimeout(finalAdjustment, 200 + finalMoves * 80);
                            } else {
                                setTimeout(() => {
                                    showResult(selectedPrize);
                                }, 500);
                            }
                        }
                        
                        setTimeout(finalAdjustment, 300);
                    } else {
                        showResult(selectedPrize);
                    }
                }
            }
            
            setTimeout(spin, 100);
        }

        // ğŸ¯ æ˜¾ç¤ºç»“æœï¼ˆä¿®å¤å›¾ç‰‡æ˜¾ç¤ºé—®é¢˜ï¼‰
        function showResult(selectedPrize) {
            // æ¸…é™¤é«˜äº®
            document.querySelectorAll('.grid-item.prize').forEach(item => {
                item.classList.remove('active');
            });
            
            // é«˜äº®ä¸­å¥–æ ¼å­
            const winningItems = document.querySelectorAll(`.grid-item.prize[data-id="${selectedPrize.id}"]`);
            winningItems.forEach(item => item.classList.add('active'));
            
            // æ›´æ–°æ—¶é—´
            const now = new Date();
            const timeStr = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')} ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}:${now.getSeconds().toString().padStart(2,'0')}`;
            
            // ğŸ¯ ä¿®å¤ï¼šå®Œæ•´æ˜¾ç¤ºä¸­å¥–ç»“æœ
            if (selectedPrize.name === "è°¢è°¢å‚ä¸") {
                elements.resultText.textContent = `ğŸ˜¢ ${selectedPrize.name}ï¼Œä¸‹æ¬¡ç»§ç»­åŠ æ²¹ï¼`;
                elements.resultPrize.style.display = 'none';
            } else {
                elements.resultText.textContent = `ğŸ‰ æ­å–œï¼æŠ½ä¸­ ${selectedPrize.name} ğŸ‰`;
                
                // è®¾ç½®emoji
                elements.resultEmoji.textContent = selectedPrize.emoji;
                elements.resultEmoji.style.color = selectedPrize.color;
                
                // è®¾ç½®å¥–å“åç§°å’Œç­‰çº§
                elements.resultPrizeName.textContent = selectedPrize.name;
                elements.resultPrizeLevel.textContent = selectedPrize.level;
                elements.resultPrizeLevel.style.color = selectedPrize.color;
                
                // è®¾ç½®æ—¶é—´
                elements.resultTime.textContent = `ä¸­å¥–æ—¶é—´: ${timeStr}`;
                
                // æ˜¾ç¤ºç»“æœåŒºåŸŸ
                elements.resultPrize.style.display = 'flex';
            }
            
            // æ›´æ–°æ¬¡æ•°
            remainingChances--;
            if (elements.chanceCountDisplay) {
                elements.chanceCountDisplay.textContent = remainingChances;
            }
            
            // æ·»åŠ åˆ°è®°å½•
            myHistory.unshift({
                name: currentUser,
                prize: selectedPrize.name,
                level: selectedPrize.level,
                time: timeStr,
                emoji: selectedPrize.emoji,
                color: selectedPrize.color
            });
            
            // æ·»åŠ åˆ°å…¬å…±åå•
            const randomName = nicknames[Math.floor(Math.random() * nicknames.length)];
            winners.unshift({ 
                name: randomName, 
                prize: selectedPrize.name, 
                level: selectedPrize.level,
                time: now.toLocaleTimeString(),
                emoji: selectedPrize.emoji
            });
            
            // é™åˆ¶æ˜¾ç¤ºæ•°é‡ï¼ˆä½¿ç”¨é…ç½®ï¼‰
            if (winners.length > SYSTEM_CONFIG.DISPLAY.WINNERS_COUNT * 2) {
                winners = winners.slice(0, SYSTEM_CONFIG.DISPLAY.WINNERS_COUNT * 2);
            }
            
            updateWinnerList();
            
            // ğŸ¯ é‡ç½®æŒ‰é’®çŠ¶æ€
            isDrawing = false;
            const startBtn = document.getElementById('startLotteryBtn');
            if (startBtn) {
                startBtn.disabled = false;
                startBtn.innerHTML = `
                    <div style="font-size: 32px;">ğŸ</div>
                    <div class="start-btn-text">å¼€å§‹æŠ½å¥–</div>
                    <div class="chance-count">å‰©ä½™: <span id="chanceCountDisplay">${remainingChances}</span> æ¬¡</div>
                `;
                startBtn.classList.remove('spinning');
            }
            
            updateHistoryDisplay();
        }

        // ğŸ¯ æ›´æ–°ä¸­å¥–åå•ï¼ˆä½¿ç”¨é…ç½®ï¼‰
        function updateWinnerList() {
            if (!elements.winnerList) return;
            
            elements.winnerList.innerHTML = '';
            const displayWinners = winners.slice(0, SYSTEM_CONFIG.DISPLAY.WINNERS_COUNT);
            
            displayWinners.forEach(winner => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 18px;">${winner.emoji}</span>
                        <span>ğŸ‘¤ ${winner.name}</span>
                    </span>
                    <span style="color: #FFD700; margin: 0 10px; font-weight: bold;">${winner.prize}</span>
                    <span style="font-size: 12px; color: #aaa;">${winner.time}</span>
                `;
                elements.winnerList.appendChild(li);
            });
        }

        // ğŸ¯ æ›´æ–°æˆ‘çš„è®°å½•ï¼ˆä½¿ç”¨é…ç½®ï¼‰
        function updateHistoryDisplay() {
            if (!elements.historyContent) return;
            
            elements.historyContent.innerHTML = '';
            
            if (myHistory.length === 0) {
                elements.historyContent.innerHTML = '<p style="text-align: center; padding: 20px; color: #999;">æš‚æ— ä¸­å¥–è®°å½•</p>';
                return;
            }
            
            myHistory.slice(0, SYSTEM_CONFIG.DISPLAY.HISTORY_COUNT).forEach(record => {
                const div = document.createElement('div');
                div.style.cssText = 'display: flex; align-items: center; padding: 10px; margin-bottom: 8px; background: rgba(255,255,255,0.05); border-radius: 8px;';
                
                div.innerHTML = `
                    <div style="font-size: 28px; margin-right: 12px; color: ${record.color};">${record.emoji}</div>
                    <div style="flex: 1;">
                        <div style="color: #FFD700; font-weight: bold;">${record.name}</div>
                        <div>${record.prize} 
                            <span style="font-size: 12px; background: rgba(255,215,0,0.2); padding: 2px 8px; border-radius: 8px; margin-left: 8px; color: ${record.color};">${record.level}</span>
                        </div>
                    </div>
                    <div style="font-size: 12px; color: #999; text-align: right;">
                        <div>${record.time.split(' ')[0]}</div>
                        <div>${record.time.split(' ')[1]}</div>
                    </div>
                `;
                
                elements.historyContent.appendChild(div);
            });
        }

        // ğŸ¯ åˆ‡æ¢éŸ³ä¹
        function toggleBgMusic() {
            isBgMusicOn = !isBgMusicOn;
            elements.bgMusicStatus.textContent = isBgMusicOn ? 'å¼€å¯' : 'å…³é—­';
            
            if (isBgMusicOn) {
                elements.bgMusic.volume = SYSTEM_CONFIG.SOUND.BACKGROUND_VOLUME;
                elements.bgMusic.play().catch(e => console.log("éŸ³ä¹æ’­æ”¾å¤±è´¥"));
                elements.bgMusicBtn.classList.add('active');
            } else {
                elements.bgMusic.pause();
                elements.bgMusicBtn.classList.remove('active');
            }
        }

        // ğŸ¯ åˆ‡æ¢éŸ³æ•ˆ
        function toggleSoundEffect() {
            isSoundEffectOn = !isSoundEffectOn;
            elements.soundEffectStatus.textContent = isSoundEffectOn ? 'å¼€å¯' : 'å…³é—­';
            elements.soundEffectBtn.classList.toggle('active', isSoundEffectOn);
        }

        // ğŸ¯ å¼€å§‹ç­”é¢˜ï¼ˆä½¿ç”¨é…ç½®ï¼‰
        function startQuiz() {
            if (remainingChances >= SYSTEM_CONFIG.LOTTERY.MAX_CHANCES) {
                elements.resultText.textContent = "ğŸŠ æŠ½å¥–æ¬¡æ•°å·²è¾¾ä¸Šé™ï¼";
                return;
            }
            
            quizState = {
                currentQuestion: 0,
                score: 0,
                selectedOption: null,
                questions: [...quizQuestions].sort(() => Math.random() - 0.5).slice(0, SYSTEM_CONFIG.QUIZ.TOTAL_QUESTIONS)
            };
            
            showQuizQuestion();
            elements.quizModal.style.display = 'flex';
        }

        // ğŸ¯ æ˜¾ç¤ºé¢˜ç›®
        function showQuizQuestion() {
            const q = quizState.questions[quizState.currentQuestion];
            const progress = (quizState.currentQuestion / SYSTEM_CONFIG.QUIZ.TOTAL_QUESTIONS) * 100;
            
            elements.quizContent.innerHTML = `
                <div style="text-align: center;">
                    <h2 style="color: #FFD700; margin-bottom: 15px;">ğŸ§  ç­”é¢˜é‡ç½®</h2>
                    <div style="background: rgba(255,255,255,0.1); height: 6px; border-radius: 3px; margin: 15px 0;">
                        <div style="height: 100%; background: linear-gradient(90deg, #FF416C, #FF4B2B); width: ${progress}%; transition: width 0.3s;"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 20px; color: #FFD700;">
                        <span>ç¬¬ ${quizState.currentQuestion + 1}/${SYSTEM_CONFIG.QUIZ.TOTAL_QUESTIONS} é¢˜</span>
                        <span>å¾—åˆ†: ${quizState.score}/${SYSTEM_CONFIG.QUIZ.REQUIRED_SCORE}</span>
                    </div>
                    <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: left;">
                        <div style="font-size: 18px; margin-bottom: 15px; color: white;">${q.question}</div>
                        <div style="display: grid; gap: 10px;">
                            ${q.options.map((opt, i) => `
                                <button onclick="selectQuizOption(${i})" style="background: ${quizState.selectedOption === i ? 'rgba(255,215,0,0.2)' : 'rgba(255,255,255,0.05)'}; border: 1px solid ${quizState.selectedOption === i ? '#FFD700' : 'rgba(255,215,0,0.3)'}; color: white; padding: 12px; border-radius: 8px; text-align: left; cursor: pointer;">
                                    ${String.fromCharCode(65 + i)}. ${opt}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                    <button onclick="submitQuizAnswer()" style="background: linear-gradient(90deg, #FF416C, #FF4B2B); color: white; border: none; padding: 12px 30px; border-radius: 25px; font-size: 16px; cursor: pointer; width: 100%;" ${quizState.selectedOption === null ? 'disabled' : ''}>
                        ${quizState.currentQuestion < SYSTEM_CONFIG.QUIZ.TOTAL_QUESTIONS - 1 ? 'æäº¤ç­”æ¡ˆ' : 'å®Œæˆç­”é¢˜'}
                    </button>
                </div>
            `;
        }

        // ğŸ¯ é€‰æ‹©ç­”æ¡ˆ
        window.selectQuizOption = function(index) {
            quizState.selectedOption = index;
            showQuizQuestion();
        }

        // ğŸ¯ æäº¤ç­”æ¡ˆ
        window.submitQuizAnswer = function() {
            if (quizState.selectedOption === null) return;
            
            const q = quizState.questions[quizState.currentQuestion];
            if (quizState.selectedOption === q.answer) {
                quizState.score++;
                playDingSound();
            }
            
            quizState.currentQuestion++;
            quizState.selectedOption = null;
            
            if (quizState.currentQuestion < quizState.questions.length) {
                showQuizQuestion();
            } else {
                showQuizResult();
            }
        }

        // ğŸ¯ æ˜¾ç¤ºç­”é¢˜ç»“æœï¼ˆä½¿ç”¨é…ç½®ï¼‰
        function showQuizResult() {
            const success = quizState.score >= SYSTEM_CONFIG.QUIZ.REQUIRED_SCORE;
            
            elements.quizContent.innerHTML = `
                <div style="text-align: center; padding: 20px 0;">
                    <div style="font-size: 60px; margin-bottom: 15px;">${success ? 'ğŸ‰' : 'ğŸ˜¢'}</div>
                    <div style="font-size: 20px; color: #FFD700; margin-bottom: 15px;">
                        ${success ? 'æ­å–œï¼ç­”é¢˜æˆåŠŸï¼' : 'å¾ˆé—æ†¾ï¼Œç­”é¢˜å¤±è´¥'}
                    </div>
                    <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; margin: 15px 0;">
                        <div>å¾—åˆ†: ${quizState.score}/${SYSTEM_CONFIG.QUIZ.TOTAL_QUESTIONS}</div>
                        <div style="font-size: 32px; color: #FFD700; margin: 10px 0;">${quizState.score}åˆ†</div>
                        <div>${success ? 'âœ… è¾¾åˆ°è¦æ±‚åˆ†æ•°' : `âŒ éœ€è¦${SYSTEM_CONFIG.QUIZ.REQUIRED_SCORE}åˆ†æ‰èƒ½é‡ç½®`}</div>
                    </div>
                    ${success ? `
                        <div style="color: #4CAF50; background: rgba(76,175,80,0.1); padding: 10px; border-radius: 8px; margin: 15px 0; border: 1px solid #4CAF50;">
                            ğŸ è·å¾—${SYSTEM_CONFIG.LOTTERY.INITIAL_CHANCES}æ¬¡æŠ½å¥–æœºä¼šï¼
                        </div>
                    ` : ''}
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button onclick="${success ? 'resetChances()' : 'closeQuizModal()'}" style="flex: 1; background: rgba(255,215,0,0.2); border: 1px solid #FFD700; color: white; padding: 12px; border-radius: 25px; cursor: pointer;">
                            ${success ? 'é‡ç½®æ¬¡æ•°' : 'å…³é—­'}
                        </button>
                        ${!success ? `
                            <button onclick="retryQuiz()" style="flex: 1; background: linear-gradient(90deg, #FF416C, #FF4B2B); border: none; color: white; padding: 12px; border-radius: 25px; cursor: pointer;">
                                é‡æ–°æŒ‘æˆ˜
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // ğŸ¯ é‡æ–°æŒ‘æˆ˜
        window.retryQuiz = function() {
            startQuiz();
        }

        // ğŸ¯ é‡ç½®æ¬¡æ•°ï¼ˆä½¿ç”¨é…ç½®ï¼‰
        window.resetChances = function() {
            remainingChances = SYSTEM_CONFIG.LOTTERY.INITIAL_CHANCES;
            if (elements.chanceCountDisplay) {
                elements.chanceCountDisplay.textContent = remainingChances;
            }
            elements.quizModal.style.display = 'none';
            elements.resultText.textContent = "ğŸŠ æŠ½å¥–æ¬¡æ•°å·²é‡ç½®ï¼";
            playDingSound();
        }

        // ğŸ¯ å…³é—­å¼¹çª—
        window.closeQuizModal = function() {
            elements.quizModal.style.display = 'none';
        }

        // ğŸ¯ ç”Ÿæˆåˆå§‹æ•°æ®
        function generateInitialData() {
            const now = new Date();
            for (let i = 0; i < SYSTEM_CONFIG.DISPLAY.WINNERS_COUNT; i++) {
                const time = new Date(now.getTime() - i * 600000);
                const randomPrize = prizes[Math.floor(Math.random() * prizes.length)];
                winners.push({
                    name: nicknames[Math.floor(Math.random() * nicknames.length)],
                    prize: randomPrize.name,
                    level: randomPrize.level,
                    time: `${time.getHours().toString().padStart(2,'0')}:${time.getMinutes().toString().padStart(2,'0')}`,
                    emoji: randomPrize.emoji
                });
            }
            currentUser = nicknames[Math.floor(Math.random() * nicknames.length)];
        }

        // ğŸ¯ åˆå§‹åŒ–éŸ³ä¹
        function initMusic() {
            setTimeout(() => {
                try {
                    elements.bgMusic.volume = SYSTEM_CONFIG.SOUND.BACKGROUND_VOLUME;
                    elements.bgMusic.play().then(() => {
                        isBgMusicOn = true;
                        elements.bgMusicStatus.textContent = 'å¼€å¯';
                        elements.bgMusicBtn.classList.add('active');
                    }).catch(() => {
                        isBgMusicOn = false;
                    });
                } catch (e) {
                    console.log("éŸ³ä¹è‡ªåŠ¨æ’­æ”¾å¤±è´¥");
                }
            }, 500);
        }

        // ğŸ¯ ç»‘å®šäº‹ä»¶
        function bindEvents() {
            elements.bgMusicBtn.addEventListener('click', toggleBgMusic);
            elements.soundEffectBtn.addEventListener('click', toggleSoundEffect);
            elements.viewHistoryBtn.addEventListener('click', () => {
                elements.historyModal.style.display = 'flex';
            });
            elements.resetBtn.addEventListener('click', startQuiz);
            elements.closeModal.addEventListener('click', () => {
                elements.historyModal.style.display = 'none';
            });
            
            elements.historyModal.addEventListener('click', (e) => {
                if (e.target === elements.historyModal) {
                    elements.historyModal.style.display = 'none';
                }
            });
            
            elements.quizModal.addEventListener('click', (e) => {
                if (e.target === elements.quizModal) {
                    elements.quizModal.style.display = 'none';
                }
            });
        }

        // ğŸ¯ ä¸»åˆå§‹åŒ–
        function init() {
            console.log("å¼€å§‹åˆå§‹åŒ–...");
            
            // 1. è·å–DOMå…ƒç´ 
            initElements();
            
            // 2. ç«‹å³æ˜¾ç¤ºç•Œé¢
            initializeNineGrid();
            
            // 3. ç”Ÿæˆæ•°æ®
            generateInitialData();
            
            // 4. æ›´æ–°æ˜¾ç¤º
            updateWinnerList();
            updateHistoryDisplay();
            
            // 5. ç»‘å®šäº‹ä»¶
            bindEvents();
            
            // 6. åˆå§‹åŒ–éŸ³ä¹ï¼ˆå¼‚æ­¥ï¼‰
            initMusic();
            
            console.log("åˆå§‹åŒ–å®Œæˆï¼");
            console.log("ç³»ç»Ÿé…ç½®å·²åŠ è½½:", SYSTEM_CONFIG);
        }

        // ğŸ¯ é¡µé¢åŠ è½½å®Œæˆæ—¶ç«‹å³åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
